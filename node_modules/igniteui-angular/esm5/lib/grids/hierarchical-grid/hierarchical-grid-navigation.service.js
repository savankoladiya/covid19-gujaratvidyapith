/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { IgxGridNavigationService } from '../grid-navigation.service';
import { first } from 'rxjs/operators';
import { isIE } from '../../core/utils';
import { FilterMode } from '../common/enums';
var IgxHierarchicalGridNavigationService = /** @class */ (function (_super) {
    tslib_1.__extends(IgxHierarchicalGridNavigationService, _super);
    function IgxHierarchicalGridNavigationService() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    /**
     * @protected
     * @param {?=} visibleIndex
     * @param {?=} isSummary
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.getCellSelector = /**
     * @protected
     * @param {?=} visibleIndex
     * @param {?=} isSummary
     * @return {?}
     */
    function (visibleIndex, isSummary) {
        if (isSummary === void 0) { isSummary = false; }
        return isSummary ? 'igx-grid-summary-cell' : 'igx-hierarchical-grid-cell';
    };
    /**
     * @protected
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.getRowSelector = /**
     * @protected
     * @return {?}
     */
    function () {
        return 'igx-hierarchical-grid-row';
    };
    /**
     * @protected
     * @param {?} index
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.getRowByIndex = /**
     * @protected
     * @param {?} index
     * @return {?}
     */
    function (index) {
        var _this = this;
        /** @type {?} */
        var selector = this.getRowSelector();
        /** @type {?} */
        var rows = Array.from(this.grid.nativeElement.querySelectorAll(selector + "[data-rowindex=\"" + index + "\"]"));
        /** @type {?} */
        var row;
        rows.forEach(function (r) {
            /** @type {?} */
            var parentGrid = _this.getClosestElemByTag(r, 'igx-hierarchical-grid');
            if (parentGrid && parentGrid.getAttribute('id') === _this.grid.id) {
                row = r;
            }
        });
        return row;
    };
    /**
     * @private
     * @param {?=} grid
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.getChildContainer = /**
     * @private
     * @param {?=} grid
     * @return {?}
     */
    function (grid) {
        /** @type {?} */
        var currGrid = grid || this.grid;
        return currGrid.nativeElement.parentNode.parentNode.parentNode;
    };
    /**
     * @private
     * @param {?=} grid
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.getChildGridRowContainer = /**
     * @private
     * @param {?=} grid
     * @return {?}
     */
    function (grid) {
        /** @type {?} */
        var currGrid = grid || this.grid;
        return currGrid.nativeElement.parentNode.parentNode;
    };
    /**
     * @private
     * @param {?} childGridID
     * @param {?} grid
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.getChildGrid = /**
     * @private
     * @param {?} childGridID
     * @param {?} grid
     * @return {?}
     */
    function (childGridID, grid) {
        /** @type {?} */
        var cgrid = grid.hgridAPI.getChildGrids(true).filter(function (g) { return g.id === childGridID; })[0];
        return cgrid;
    };
    /**
     * @private
     * @param {?} grid
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype._isScrolledToBottom = /**
     * @private
     * @param {?} grid
     * @return {?}
     */
    function (grid) {
        /** @type {?} */
        var scrollTop = grid.verticalScrollContainer.scrollPosition;
        /** @type {?} */
        var scrollHeight = grid.verticalScrollContainer.getScroll().scrollHeight;
        return scrollHeight === 0 || Math.round(scrollTop + grid.verticalScrollContainer.igxForContainerSize) === scrollHeight;
    };
    /**
     * @private
     * @param {?} index
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.getIsChildAtIndex = /**
     * @private
     * @param {?} index
     * @return {?}
     */
    function (index) {
        return this.grid.isChildGridRecord(this.grid.dataView[index]);
    };
    /**
     * @param {?} rowIndex
     * @param {?} visibleColumnIndex
     * @param {?=} isSummary
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.getCellElementByVisibleIndex = /**
     * @param {?} rowIndex
     * @param {?} visibleColumnIndex
     * @param {?=} isSummary
     * @return {?}
     */
    function (rowIndex, visibleColumnIndex, isSummary) {
        if (isSummary === void 0) { isSummary = false; }
        /** @type {?} */
        var cellSelector = this.getCellSelector(visibleColumnIndex, isSummary);
        if (isSummary) {
            /** @type {?} */
            var summaryRow = this.grid.summariesRowList.toArray()[0].nativeElement;
            return summaryRow.querySelector(cellSelector + "[data-visibleIndex=\"" + visibleColumnIndex + "\"]");
        }
        /** @type {?} */
        var row = this.getRowByIndex(rowIndex);
        return row.querySelector(cellSelector + "[data-rowindex=\"" + rowIndex + "\"][data-visibleIndex=\"" + visibleColumnIndex + "\"]");
    };
    /**
     * @param {?} rowElement
     * @param {?} selectedNode
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.navigateUp = /**
     * @param {?} rowElement
     * @param {?} selectedNode
     * @return {?}
     */
    function (rowElement, selectedNode) {
        var _this = this;
        if (selectedNode.isSummaryRow) {
            return;
        }
        /** @type {?} */
        var prevElem = rowElement.previousElementSibling;
        /** @type {?} */
        var visibleColumnIndex = selectedNode.column;
        /** @type {?} */
        var currentRowIndex = selectedNode.row;
        if (prevElem) {
            /** @type {?} */
            var nodeName = prevElem.children[0].nodeName.toLowerCase();
            /** @type {?} */
            var isElemChildGrid = nodeName.toLowerCase() === 'igx-child-grid-row';
            if (isElemChildGrid) {
                this.focusPrevChild(prevElem, visibleColumnIndex, this.grid);
            }
            else {
                if (this.grid.parent !== null) {
                    // currently navigating in child grid
                    this._navigateUpInChild(rowElement, currentRowIndex, visibleColumnIndex);
                }
                else {
                    _super.prototype.navigateUp.call(this, rowElement, selectedNode);
                }
            }
        }
        else if (currentRowIndex !== 0) {
            // handle scenario when prev item is child grid but is not yet in view
            /** @type {?} */
            var isPrevChildGrid = this.getIsChildAtIndex(currentRowIndex - 1);
            if (!isPrevChildGrid) {
                _super.prototype.navigateUp.call(this, rowElement, selectedNode);
            }
            else {
                this.scrollGrid(this.grid, -rowElement.offsetHeight, function () {
                    rowElement = _this.getRowByIndex(currentRowIndex);
                    _this.navigateUp(rowElement, selectedNode);
                });
            }
        }
        else if (this.grid.parent !== null &&
            currentRowIndex === 0) {
            // move to prev row in sibling layout or parent
            this.focusPrev(visibleColumnIndex);
        }
    };
    /**
     * @param {?} rowElement
     * @param {?} selectedNode
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.navigateDown = /**
     * @param {?} rowElement
     * @param {?} selectedNode
     * @return {?}
     */
    function (rowElement, selectedNode) {
        if (selectedNode.isSummaryRow) {
            return;
        }
        /** @type {?} */
        var nextElem = rowElement.nextElementSibling;
        /** @type {?} */
        var visibleColumnIndex = selectedNode.column;
        /** @type {?} */
        var currentRowIndex = selectedNode.row;
        if (nextElem) {
            // next elem is in DOM
            /** @type {?} */
            var nodeName = nextElem.children[0].nodeName.toLowerCase();
            /** @type {?} */
            var isNextElemChildGrid = nodeName.toLowerCase() === 'igx-child-grid-row';
            if (isNextElemChildGrid) {
                this.focusNextChild(nextElem, visibleColumnIndex, this.grid);
            }
            else {
                if (this.grid.parent !== null) {
                    // currently navigating in child grid
                    this._navigateDownInChild(rowElement, currentRowIndex, visibleColumnIndex);
                }
                else {
                    _super.prototype.navigateDown.call(this, rowElement, selectedNode);
                }
            }
        }
        else if (currentRowIndex !== this.grid.dataView.length - 1) {
            // scroll next in view
            _super.prototype.navigateDown.call(this, rowElement, selectedNode);
        }
        else if (this.grid.parent !== null &&
            currentRowIndex === this.grid.dataView.length - 1) {
            // move to next row in sibling layout or in parent
            this.focusNext(visibleColumnIndex);
        }
    };
    /**
     * @param {?} visibleColumnIndex
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.navigateTop = /**
     * @param {?} visibleColumnIndex
     * @return {?}
     */
    function (visibleColumnIndex) {
        var _this = this;
        if (this.grid.parent !== null) {
            // navigating in child
            /** @type {?} */
            var childContainer = this.grid.nativeElement.parentNode.parentNode;
            /** @type {?} */
            var diff = childContainer.getBoundingClientRect().top - this.grid.rootGrid.tbody.nativeElement.getBoundingClientRect().top;
            /** @type {?} */
            var topIsVisible = diff >= 0;
            /** @type {?} */
            var scrollable = this.getNextScrollable(this.grid);
            if (!topIsVisible) {
                this.scrollGrid(scrollable.grid, diff, function () { return _super.prototype.navigateTop.call(_this, visibleColumnIndex); });
            }
            else {
                _super.prototype.navigateTop.call(this, visibleColumnIndex);
            }
        }
        else {
            _super.prototype.navigateTop.call(this, visibleColumnIndex);
        }
    };
    /**
     * @param {?} visibleColumnIndex
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.navigateBottom = /**
     * @param {?} visibleColumnIndex
     * @return {?}
     */
    function (visibleColumnIndex) {
        var _this = this;
        // handle scenario where last index is child grid
        // in that case focus cell in last data row
        /** @type {?} */
        var lastIndex = this.grid.dataView.length - 1;
        if (this.getIsChildAtIndex(lastIndex)) {
            /** @type {?} */
            var targetIndex_1 = lastIndex - 1;
            /** @type {?} */
            var scrTopPosition = this.grid.verticalScrollContainer.getScrollForIndex(targetIndex_1, true);
            /** @type {?} */
            var verticalScrollTop = this.grid.verticalScrollContainer.scrollPosition;
            /** @type {?} */
            var cellSelector_1 = this.getCellSelector(visibleColumnIndex);
            if (verticalScrollTop === scrTopPosition) {
                /** @type {?} */
                var cells = this.getRowByIndex(targetIndex_1).querySelectorAll(cellSelector_1 + "[data-visibleIndex=\"" + visibleColumnIndex + "\"]");
                cells[cells.length - 1].focus();
            }
            else {
                this.scrollGrid(this.grid, scrTopPosition - verticalScrollTop, function () {
                    /** @type {?} */
                    var cells = _this.getRowByIndex(targetIndex_1).querySelectorAll(cellSelector_1 + "[data-visibleIndex=\"" + visibleColumnIndex + "\"]");
                    if (cells.length > 0) {
                        cells[cells.length - 1].focus();
                    }
                });
            }
        }
        else if (this.grid.parent !== null) {
            /** @type {?} */
            var childContainer = this.grid.nativeElement.parentNode.parentNode;
            /** @type {?} */
            var diff = childContainer.getBoundingClientRect().bottom - this.grid.rootGrid.tbody.nativeElement.getBoundingClientRect().bottom;
            /** @type {?} */
            var endIsVisible = diff < 0;
            /** @type {?} */
            var scrollable = this.getNextScrollableDown(this.grid);
            if (!endIsVisible) {
                this.scrollGrid(scrollable.grid, diff, function () { return _super.prototype.navigateBottom.call(_this, visibleColumnIndex); });
            }
            else {
                _super.prototype.navigateBottom.call(this, visibleColumnIndex);
            }
        }
        else {
            _super.prototype.navigateBottom.call(this, visibleColumnIndex);
        }
    };
    /**
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.goToLastCell = /**
     * @return {?}
     */
    function () {
        var _this = this;
        // handle scenario where last index is child grid
        // in that case focus last cell in last data row
        /** @type {?} */
        var lastIndex = this.grid.dataView.length - 1;
        if (this.getIsChildAtIndex(lastIndex)) {
            /** @type {?} */
            var targetIndex_2 = lastIndex - 1;
            /** @type {?} */
            var scrTopPosition = this.grid.verticalScrollContainer.getScrollForIndex(targetIndex_2, true);
            /** @type {?} */
            var verticalScrollTop = this.grid.verticalScrollContainer.scrollPosition;
            if (verticalScrollTop === scrTopPosition) {
                this.onKeydownEnd(targetIndex_2);
            }
            else {
                this.scrollGrid(this.grid, scrTopPosition - verticalScrollTop, function () {
                    _this.onKeydownEnd(targetIndex_2);
                });
            }
        }
        else {
            _super.prototype.goToLastCell.call(this);
        }
    };
    /**
     * @param {?} rowIndex
     * @param {?=} isSummary
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.onKeydownEnd = /**
     * @param {?} rowIndex
     * @param {?=} isSummary
     * @return {?}
     */
    function (rowIndex, isSummary) {
        var _this = this;
        if (isSummary === void 0) { isSummary = false; }
        if (this.grid.parent && !isSummary) {
            // handle scenario where last child row might not be in view
            // parent should scroll to child grid end
            /** @type {?} */
            var childContainer = this.grid.nativeElement.parentNode.parentNode;
            /** @type {?} */
            var diffBottom = childContainer.getBoundingClientRect().bottom - this.grid.rootGrid.nativeElement.getBoundingClientRect().bottom;
            /** @type {?} */
            var row = this.grid.getRowByIndex(rowIndex).element.nativeElement;
            /** @type {?} */
            var rowBottom = row.getBoundingClientRect().bottom;
            /** @type {?} */
            var rowIsVisible = rowBottom <= this.grid.rootGrid.tbody.nativeElement.getBoundingClientRect().bottom;
            /** @type {?} */
            var gridTop = this._getMaxTop(this.grid);
            /** @type {?} */
            var diffTop = row.getBoundingClientRect().bottom -
                row.offsetHeight - gridTop;
            /** @type {?} */
            var endIsVisible = diffBottom <= 0;
            /** @type {?} */
            var topVisible = diffTop >= 0;
            if (!endIsVisible && !rowIsVisible) {
                this.scrollGrid(this.grid.parent, diffBottom, function () { return _super.prototype.onKeydownEnd.call(_this, rowIndex); });
            }
            else if (!topVisible) {
                /** @type {?} */
                var scrGrid = this.grid.verticalScrollContainer.scrollPosition !== 0 ? this.grid :
                    this.getNextScrollable(this.grid).grid;
                /** @type {?} */
                var topGrid = scrGrid.tbody.nativeElement.getBoundingClientRect().top >
                    this.grid.rootGrid.tbody.nativeElement.getBoundingClientRect().top ? scrGrid : this.grid.rootGrid;
                this.scrollGrid(topGrid, diffTop, function () { return _super.prototype.onKeydownEnd.call(_this, rowIndex); });
            }
            else {
                _super.prototype.onKeydownEnd.call(this, rowIndex, isSummary);
            }
        }
        else {
            _super.prototype.onKeydownEnd.call(this, rowIndex, isSummary);
        }
    };
    /**
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.goToFirstCell = /**
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var verticalScroll = this.grid.verticalScrollContainer.getScroll();
        /** @type {?} */
        var horizontalScroll = this.grid.dataRowList.first.virtDirRow.getScroll();
        if (verticalScroll.scrollTop === 0 && this.grid.parent) {
            // scroll parent so that current child is in view
            if (!horizontalScroll.clientWidth || parseInt(horizontalScroll.scrollLeft, 10) <= 1 || this.grid.pinnedColumns.length) {
                this.navigateTop(0);
            }
            else {
                this.horizontalScroll(this.grid.dataRowList.first.index).scrollTo(0);
                this.grid.parentVirtDir.onChunkLoad
                    .pipe(first())
                    .subscribe(function () {
                    _this.navigateTop(0);
                });
            }
        }
        else {
            _super.prototype.goToFirstCell.call(this);
        }
    };
    /**
     * @param {?} currentRowEl
     * @param {?} selectedNode
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.performTab = /**
     * @param {?} currentRowEl
     * @param {?} selectedNode
     * @return {?}
     */
    function (currentRowEl, selectedNode) {
        var _this = this;
        if (this.grid.rowInEditMode) {
            _super.prototype.performTab.call(this, currentRowEl, selectedNode);
            return;
        }
        /** @type {?} */
        var rowIndex = selectedNode.row;
        /** @type {?} */
        var visibleColumnIndex = selectedNode.column;
        /** @type {?} */
        var isSummaryRow = selectedNode.isSummaryRow;
        /** @type {?} */
        var summaryRows = this.grid.summariesRowList.toArray();
        /** @type {?} */
        var hasSummaries = summaryRows.length > 0;
        /** @type {?} */
        var isLastDataRow = rowIndex === this.grid.dataView.length - 1;
        /** @type {?} */
        var nextIsDataRow = this.grid.dataRowList.find(function (row) { return row.index === rowIndex + 1; });
        /** @type {?} */
        var isLastColumn = this.grid.unpinnedColumns[this.grid.unpinnedColumns.length - 1].visibleIndex === visibleColumnIndex;
        /** @type {?} */
        var isLastSummaryRow = hasSummaries && isSummaryRow;
        /** @type {?} */
        var nextIndex = rowIndex + 1;
        /** @type {?} */
        var virt = this.grid.verticalScrollContainer;
        /** @type {?} */
        var isNextChild = nextIndex <= virt.igxForOf.length - 1 &&
            this.grid.isChildGridRecord(virt.igxForOf[nextIndex]);
        if (!nextIsDataRow && !(isLastDataRow && hasSummaries) && isLastColumn && !isSummaryRow) {
            // navigating in child, next is not summary
            /** @type {?} */
            var childContainer = this.getChildGridRowContainer();
            /** @type {?} */
            var nextIsSiblingChild = this.grid.parent ? !!childContainer.nextElementSibling : false;
            if (nextIsSiblingChild) {
                this.focusNextChildDOMElem(childContainer, this.grid.parent);
            }
            else if (isNextChild) {
                /** @type {?} */
                var isInView = virt.state.startIndex + virt.state.chunkSize > nextIndex;
                if (!isInView) {
                    this.scrollGrid(this.grid, 'next', function () {
                        _this.focusNextChildDOMElem(currentRowEl, _this.grid);
                    });
                }
                else {
                    this.focusNextChildDOMElem(currentRowEl, this.grid);
                }
            }
            else if (this.grid.parent && this.grid.parent.summariesRowList.length > 0) {
                this._navigateToNextParentRow(currentRowEl);
            }
            else {
                this.navigateDown(currentRowEl, { row: rowIndex, column: 0 });
            }
        }
        else if (isLastSummaryRow && isLastColumn && this.grid.parent) {
            this._navigateToNextParentRow(currentRowEl);
        }
        else if (isLastDataRow && hasSummaries && isLastColumn && this.grid.parent) {
            // navigating in child rows, next is child grid's summary row
            this.focusNextRow(summaryRows[0].nativeElement, 0, this.grid.parent, true);
        }
        else {
            _super.prototype.performTab.call(this, currentRowEl, selectedNode);
        }
    };
    /**
     * @private
     * @param {?} currentRowEl
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype._navigateToNextParentRow = /**
     * @private
     * @param {?} currentRowEl
     * @return {?}
     */
    function (currentRowEl) {
        // next is parent summary or next parent row
        /** @type {?} */
        var parent = this.grid.parent;
        /** @type {?} */
        var parentHasSummary = parent.summariesRowList.length > 0;
        /** @type {?} */
        var parentRowIndex = parseInt(this.getClosestElemByTag(currentRowEl, 'igx-child-grid-row').parentNode.getAttribute('data-rowindex'), 10);
        /** @type {?} */
        var isLastRowInParent = parent.dataView.length - 1 === parentRowIndex;
        // check if next is sibling
        /** @type {?} */
        var childRowContainer = this.getChildGridRowContainer(this.grid);
        /** @type {?} */
        var nextIsSiblingChild = !!childRowContainer.nextElementSibling;
        if (isLastRowInParent && parentHasSummary && !nextIsSiblingChild) {
            // next is parent summary
            /** @type {?} */
            var parentSummary = parent.summariesRowList.first.nativeElement;
            parent.navigation.focusNextRow(parentSummary, 0, parent, true);
        }
        else {
            // next is sibling or parent
            this.focusNext(0);
        }
    };
    /**
     * @private
     * @param {?} currentRowEl
     * @param {?} grid
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.focusNextChildDOMElem = /**
     * @private
     * @param {?} currentRowEl
     * @param {?} grid
     * @return {?}
     */
    function (currentRowEl, grid) {
        /** @type {?} */
        var gridElem = currentRowEl.nextElementSibling.querySelector('igx-hierarchical-grid');
        /** @type {?} */
        var childGridID = gridElem.getAttribute('id');
        /** @type {?} */
        var childGrid = this.getChildGrid(childGridID, grid);
        if (childGrid.allowFiltering && childGrid.filterMode === FilterMode.quickFilter) {
            childGrid.navigation.moveFocusToFilterCell(true);
            return;
        }
        this.focusNextChild(currentRowEl.nextElementSibling, 0, grid);
    };
    /**
     * @param {?} column
     * @param {?} eventArgs
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.navigatePrevFilterCell = /**
     * @param {?} column
     * @param {?} eventArgs
     * @return {?}
     */
    function (column, eventArgs) {
        if (column.visibleIndex === 0 && this.grid.parent) {
            eventArgs.preventDefault();
            /** @type {?} */
            var targetGrid = this.grid.parent;
            /** @type {?} */
            var prevSiblingChild = this.getChildGridRowContainer().previousElementSibling;
            if (prevSiblingChild) {
                /** @type {?} */
                var gridElem = prevSiblingChild.querySelectorAll('igx-hierarchical-grid')[0];
                targetGrid = this.getChildGrid(gridElem.getAttribute('id'), this.grid.parent);
            }
            this.focusPrev(targetGrid.unpinnedColumns[targetGrid.unpinnedColumns.length - 1].visibleIndex);
        }
        else {
            _super.prototype.navigatePrevFilterCell.call(this, column, eventArgs);
        }
    };
    /**
     * @param {?} column
     * @param {?} eventArgs
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.navigateNextFilterCell = /**
     * @param {?} column
     * @param {?} eventArgs
     * @return {?}
     */
    function (column, eventArgs) {
        /** @type {?} */
        var cols = this.grid.filteringService.unpinnedFilterableColumns;
        /** @type {?} */
        var nextFilterableIndex = cols.indexOf(column) + 1;
        if (nextFilterableIndex >= this.grid.filteringService.unpinnedFilterableColumns.length) {
            // next is not filter cell
            /** @type {?} */
            var dataRows = this.grid.rowList.toArray();
            /** @type {?} */
            var hasRows = dataRows.length !== 0;
            /** @type {?} */
            var summaryRows = this.grid.summariesRowList.toArray();
            /** @type {?} */
            var hasSummaries = summaryRows.length > 0 && summaryRows[0].summaryCells.length > 0;
            if (hasRows) {
                this.focusNextRow(dataRows[0].nativeElement, 0, this.grid, false);
            }
            else if (hasSummaries) {
                this.focusNextRow(summaryRows[0].nativeElement, 0, this.grid, true);
            }
            else {
                this.focusNext(0);
            }
            eventArgs.preventDefault();
        }
        else {
            _super.prototype.navigateNextFilterCell.call(this, column, eventArgs);
        }
    };
    /**
     * @param {?} currentRowEl
     * @param {?} selectedNode
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.performShiftTabKey = /**
     * @param {?} currentRowEl
     * @param {?} selectedNode
     * @return {?}
     */
    function (currentRowEl, selectedNode) {
        var _this = this;
        if (this.grid.rowInEditMode) {
            _super.prototype.performShiftTabKey.call(this, currentRowEl, selectedNode);
            return;
        }
        /** @type {?} */
        var rowIndex = selectedNode.row;
        /** @type {?} */
        var visibleColumnIndex = selectedNode.column;
        /** @type {?} */
        var isSummary = selectedNode.isSummaryRow;
        if (visibleColumnIndex === 0 && rowIndex === 0 && this.grid.parent && !isSummary) {
            if (this.grid.allowFiltering && this.grid.filterMode === FilterMode.quickFilter) {
                this.moveFocusToFilterCell();
            }
            else {
                /** @type {?} */
                var prevSiblingChild = this.getChildGridRowContainer().previousElementSibling;
                if (prevSiblingChild) {
                    /** @type {?} */
                    var gridElem = prevSiblingChild.querySelectorAll('igx-hierarchical-grid')[0];
                    this.performShiftTabIntoChild(gridElem, currentRowEl, rowIndex);
                }
                else {
                    /** @type {?} */
                    var selNode = {
                        row: rowIndex,
                        column: this.grid.parent.unpinnedColumns[this.grid.parent.unpinnedColumns.length - 1].visibleIndex
                    };
                    this.navigateUp(currentRowEl, selNode);
                }
            }
        }
        else if (visibleColumnIndex === 0 && currentRowEl.previousElementSibling &&
            currentRowEl.previousElementSibling.children[0].tagName.toLowerCase() === 'igx-child-grid-row') {
            /** @type {?} */
            var gridElem = this.getLastGridElem(currentRowEl.previousElementSibling);
            this.performShiftTabIntoChild(gridElem, currentRowEl, rowIndex);
        }
        else if (visibleColumnIndex === 0 && isSummary) {
            /** @type {?} */
            var lastRowIndex_1 = this.grid.dataView.length - 1;
            if (lastRowIndex_1 === -1) {
                // no child data
                if (this.grid.allowFiltering && this.grid.filterMode === FilterMode.quickFilter) {
                    this.moveFocusToFilterCell();
                }
                else {
                    /** @type {?} */
                    var selNode = {
                        row: rowIndex,
                        column: this.grid.parent.unpinnedColumns[this.grid.parent.unpinnedColumns.length - 1].visibleIndex
                    };
                    this.navigateUp(currentRowEl, selNode);
                }
            }
            else if (!this.getIsChildAtIndex(lastRowIndex_1)) {
                _super.prototype.goToLastCell.call(this);
            }
            else {
                /** @type {?} */
                var scrTopPosition = this.grid.verticalScrollContainer.getScrollForIndex(lastRowIndex_1, true);
                /** @type {?} */
                var verticalScrollTop = this.grid.verticalScrollContainer.scrollPosition;
                if (verticalScrollTop === scrTopPosition || isNaN(scrTopPosition)) {
                    /** @type {?} */
                    var closestChild = this.getLastGridElem(this.grid.getRowByIndex(lastRowIndex_1).nativeElement.parentElement);
                    this.performShiftTabIntoChild(closestChild, currentRowEl, rowIndex);
                }
                else {
                    this.scrollGrid(this.grid, scrTopPosition - verticalScrollTop, function () {
                        /** @type {?} */
                        var closestChild = _this.getLastGridElem(_this.grid.getRowByIndex(lastRowIndex_1).nativeElement.parentElement);
                        _this.performShiftTabIntoChild(closestChild, currentRowEl, rowIndex);
                    });
                }
            }
        }
        else {
            _super.prototype.performShiftTabKey.call(this, currentRowEl, selectedNode);
        }
    };
    /**
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.getFocusableGrid = /**
     * @return {?}
     */
    function () {
        return (isIE() && this.grid.rootGrid) ? this.grid.rootGrid : this.grid;
    };
    /**
     * @private
     * @param {?} trContainer
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.getLastGridElem = /**
     * @private
     * @param {?} trContainer
     * @return {?}
     */
    function (trContainer) {
        /** @type {?} */
        var children = trContainer.children;
        /** @type {?} */
        var closestChild = children[children.length - 1].children[0].children[0];
        return closestChild;
    };
    /**
     * @private
     * @param {?} gridElem
     * @param {?} currentRowEl
     * @param {?} rowIndex
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.performShiftTabIntoChild = /**
     * @private
     * @param {?} gridElem
     * @param {?} currentRowEl
     * @param {?} rowIndex
     * @return {?}
     */
    function (gridElem, currentRowEl, rowIndex) {
        /** @type {?} */
        var childGridID = gridElem.getAttribute('id');
        /** @type {?} */
        var childGrid = this.getChildGrid(childGridID, this.grid) || this.getChildGrid(childGridID, this.grid.parent);
        /** @type {?} */
        var lastIndex = childGrid.unpinnedColumns[childGrid.unpinnedColumns.length - 1].visibleIndex;
        /** @type {?} */
        var summaryRows = childGrid.summariesRowList.toArray();
        if (summaryRows.length > 0 && summaryRows[0].summaryCells.length > 0) {
            // move focus to last summary row cell
            /** @type {?} */
            var summaryRow = summaryRows[0].nativeElement;
            this.focusPrevRow(summaryRow, lastIndex, childGrid, true, true);
        }
        else if (childGrid.rowList.length === 0 &&
            childGrid.allowFiltering && childGrid.filterMode === FilterMode.quickFilter) {
            // move to filter cell
            childGrid.navigation.moveFocusToFilterCell();
        }
        else if (childGrid.rowList.length === 0) {
            // move to prev child or parent row
            /** @type {?} */
            var prevChild = this.getSibling(childGrid);
            if (prevChild) {
                this.performShiftTabIntoChild(prevChild, currentRowEl, rowIndex);
            }
            else {
                /** @type {?} */
                var selNode = {
                    row: rowIndex,
                    column: this.grid.unpinnedColumns[this.grid.unpinnedColumns.length - 1].visibleIndex
                };
                this.navigateUp(currentRowEl, selNode);
            }
        }
        else {
            // move to prev cell
            childGrid.navigation.goToLastCell();
        }
    };
    /**
     * @private
     * @param {?} childGrid
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.getSibling = /**
     * @private
     * @param {?} childGrid
     * @return {?}
     */
    function (childGrid) {
        /** @type {?} */
        var prevChildRow = childGrid.childRow.nativeElement.previousElementSibling;
        if (prevChildRow) {
            return prevChildRow.children[0].children[0];
        }
        return null;
    };
    /**
     * @private
     * @param {?} elem
     * @param {?} visibleColumnIndex
     * @param {?} grid
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.focusNextChild = /**
     * @private
     * @param {?} elem
     * @param {?} visibleColumnIndex
     * @param {?} grid
     * @return {?}
     */
    function (elem, visibleColumnIndex, grid) {
        var _this = this;
        /** @type {?} */
        var gridElem = elem.querySelector('igx-hierarchical-grid');
        /** @type {?} */
        var childGridID = gridElem.getAttribute('id');
        /** @type {?} */
        var childGrid = this.getChildGrid(childGridID, grid);
        if (childGrid.rowList.length === 0) {
            this.focusNext(visibleColumnIndex, childGrid);
            return;
        }
        // Update column index since the next child can have in general less columns than visibleColumnIndex value.
        /** @type {?} */
        var lastCellIndex = childGrid.unpinnedColumns[childGrid.unpinnedColumns.length - 1].visibleIndex;
        visibleColumnIndex = Math.min(lastCellIndex, visibleColumnIndex);
        if (childGrid.verticalScrollContainer.state.startIndex !== 0) {
            // scroll to top
            this.scrollGrid(childGrid, 'top', function () { return _this.focusNextRow(elem, visibleColumnIndex, childGrid); });
        }
        else {
            this.focusNextRow(elem, visibleColumnIndex, childGrid);
        }
    };
    /**
     * @private
     * @param {?} elem
     * @param {?} visibleColumnIndex
     * @param {?} grid
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.focusPrevChild = /**
     * @private
     * @param {?} elem
     * @param {?} visibleColumnIndex
     * @param {?} grid
     * @return {?}
     */
    function (elem, visibleColumnIndex, grid) {
        var _this = this;
        /** @type {?} */
        var grids = [];
        /** @type {?} */
        var gridElems = Array.from(elem.querySelectorAll('igx-hierarchical-grid'));
        /** @type {?} */
        var childLevel = grid.childLayoutList.first.level;
        gridElems.forEach(function (hg) {
            /** @type {?} */
            var parentRow = _this.getClosestElemByTag(hg, 'igx-child-grid-row');
            if (parentRow && parseInt(parentRow.getAttribute('data-level'), 10) === childLevel) {
                grids.push(hg);
            }
        });
        /** @type {?} */
        var gridElem = grids[grids.length - 1];
        /** @type {?} */
        var childGridID = gridElem.getAttribute('id');
        /** @type {?} */
        var childGrid = this.getChildGrid(childGridID, grid);
        if (childGrid.rowList.length === 0) {
            this.focusPrev(visibleColumnIndex, childGrid);
            return;
        }
        // Update column index since the previous child can have in general less columns than visibleColumnIndex value.
        /** @type {?} */
        var lastCellIndex = childGrid.unpinnedColumns[childGrid.unpinnedColumns.length - 1].visibleIndex;
        visibleColumnIndex = Math.min(lastCellIndex, visibleColumnIndex);
        /** @type {?} */
        var isScrolledToBottom = this._isScrolledToBottom(childGrid);
        /** @type {?} */
        var lastIndex = childGrid.dataView.length - 1;
        if (!isScrolledToBottom) {
            // scroll to end
            this.scrollGrid(childGrid, 'bottom', function () { return _this.focusPrevChild(elem, visibleColumnIndex, grid); });
        }
        else {
            /** @type {?} */
            var lastRowInChild = childGrid.getRowByIndex(lastIndex);
            /** @type {?} */
            var isChildGrid = lastRowInChild.nativeElement.nodeName.toLowerCase() === 'igx-child-grid-row';
            if (isChildGrid) {
                this.focusPrevChild(lastRowInChild.nativeElement.parentNode, visibleColumnIndex, childGrid);
            }
            else {
                this.focusPrevRow(lastRowInChild.nativeElement, visibleColumnIndex, childGrid, true);
            }
        }
    };
    /**
     * @private
     * @param {?} visibleColumnIndex
     * @param {?=} grid
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.focusPrev = /**
     * @private
     * @param {?} visibleColumnIndex
     * @param {?=} grid
     * @return {?}
     */
    function (visibleColumnIndex, grid) {
        var _this = this;
        /** @type {?} */
        var currGrid = grid || this.grid;
        /** @type {?} */
        var parentContainer = this.getChildContainer(currGrid);
        /** @type {?} */
        var childRowContainer = this.getChildGridRowContainer(currGrid);
        /** @type {?} */
        var prevIsSiblingChild = !!childRowContainer.previousElementSibling;
        /** @type {?} */
        var prev = childRowContainer.previousElementSibling || parentContainer.previousElementSibling;
        if (prev) {
            if (prevIsSiblingChild) {
                this.focusPrevChild(prev, visibleColumnIndex, currGrid.parent);
            }
            else {
                this.focusPrevRow(prev, visibleColumnIndex, currGrid.parent);
            }
        }
        else {
            this.scrollGrid(currGrid.parent, 'prev', function () {
                parentContainer = _this.getChildContainer(grid);
                childRowContainer = _this.getChildGridRowContainer(grid);
                prev = childRowContainer.previousElementSibling || parentContainer.previousElementSibling;
                if (prevIsSiblingChild) {
                    _this.focusPrevChild(prev, visibleColumnIndex, currGrid.parent);
                }
                else {
                    _this.focusPrevRow(prev, visibleColumnIndex, currGrid.parent);
                }
            });
        }
    };
    /**
     * @private
     * @param {?} grid
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.getNextParentInfo = /**
     * @private
     * @param {?} grid
     * @return {?}
     */
    function (grid) {
        // find next parent that is not at bottom
        /** @type {?} */
        var currGrid = grid.parent;
        /** @type {?} */
        var nextElem = this.getChildContainer(grid).nextElementSibling;
        while (!nextElem && currGrid.parent !== null) {
            nextElem = this.getChildContainer(currGrid).nextElementSibling;
            currGrid = currGrid.parent;
        }
        return { grid: currGrid, nextElement: nextElem };
    };
    /**
     * @private
     * @param {?} grid
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.getNextScrollable = /**
     * @private
     * @param {?} grid
     * @return {?}
     */
    function (grid) {
        /** @type {?} */
        var currGrid = grid.parent;
        if (!currGrid) {
            return { grid: grid, prev: null };
        }
        /** @type {?} */
        var nonScrollable = currGrid.verticalScrollContainer.scrollPosition === 0;
        /** @type {?} */
        var prev = grid;
        while (nonScrollable && currGrid.parent !== null) {
            prev = currGrid;
            currGrid = currGrid.parent;
            nonScrollable = currGrid.verticalScrollContainer.scrollPosition === 0;
        }
        return { grid: currGrid, prev: prev };
    };
    /**
     * @private
     * @param {?} visibleColumnIndex
     * @param {?=} grid
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.focusNext = /**
     * @private
     * @param {?} visibleColumnIndex
     * @param {?=} grid
     * @return {?}
     */
    function (visibleColumnIndex, grid) {
        var _this = this;
        /** @type {?} */
        var currGrid = grid || this.grid;
        /** @type {?} */
        var parentInfo = this.getNextParentInfo(currGrid);
        /** @type {?} */
        var nextParentGrid = parentInfo.grid;
        /** @type {?} */
        var nextParentElem = parentInfo.nextElement;
        /** @type {?} */
        var childRowContainer = this.getChildGridRowContainer(currGrid);
        /** @type {?} */
        var nextIsSiblingChild = !!childRowContainer.nextElementSibling;
        /** @type {?} */
        var next = childRowContainer.nextElementSibling || nextParentElem;
        /** @type {?} */
        var verticalScroll = nextParentGrid.verticalScrollContainer.getScroll();
        /** @type {?} */
        var parentState = nextParentGrid.verticalScrollContainer.state;
        /** @type {?} */
        var atLastChunk = parentState.startIndex + parentState.chunkSize ===
            nextParentGrid.dataView.length;
        if (next) {
            if (nextIsSiblingChild) {
                this.focusNextChild(next, visibleColumnIndex, nextParentGrid);
            }
            else {
                this.focusNextRow(next, visibleColumnIndex, grid || nextParentGrid);
            }
        }
        else if (verticalScroll.scrollTop !==
            verticalScroll.scrollHeight - nextParentGrid.verticalScrollContainer.igxForContainerSize && !atLastChunk) {
            this.scrollGrid(nextParentGrid, 'next', function () {
                nextParentElem = parentInfo.nextElement;
                childRowContainer = _this.getChildGridRowContainer();
                next = childRowContainer.nextElementSibling || nextParentElem;
                if (next && nextIsSiblingChild) {
                    _this.focusNextChild(next, visibleColumnIndex, nextParentGrid);
                }
                else if (next) {
                    _this.focusNextRow(next, visibleColumnIndex, grid || nextParentGrid);
                }
            });
        }
    };
    /**
     * @private
     * @param {?} grid
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.getNextScrollableDown = /**
     * @private
     * @param {?} grid
     * @return {?}
     */
    function (grid) {
        /** @type {?} */
        var currGrid = grid.parent;
        if (!currGrid) {
            return { grid: grid, prev: null };
        }
        /** @type {?} */
        var scrollTop = currGrid.verticalScrollContainer.scrollPosition;
        /** @type {?} */
        var scrollHeight = currGrid.verticalScrollContainer.getScroll().scrollHeight;
        /** @type {?} */
        var nonScrollable = scrollHeight === 0 ||
            Math.round(scrollTop + currGrid.verticalScrollContainer.igxForContainerSize) === scrollHeight;
        /** @type {?} */
        var prev = grid;
        while (nonScrollable && currGrid.parent !== null) {
            prev = currGrid;
            currGrid = currGrid.parent;
            scrollTop = currGrid.verticalScrollContainer.scrollPosition;
            scrollHeight = currGrid.verticalScrollContainer.getScroll().scrollHeight;
            nonScrollable = scrollHeight === 0 ||
                Math.round(scrollTop + currGrid.verticalScrollContainer.igxForContainerSize) === scrollHeight;
        }
        return { grid: currGrid, prev: prev };
    };
    /**
     * @private
     * @param {?} grid
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype._getMinBottom = /**
     * @private
     * @param {?} grid
     * @return {?}
     */
    function (grid) {
        /** @type {?} */
        var currGrid = grid;
        /** @type {?} */
        var bottom = currGrid.tbody.nativeElement.getBoundingClientRect().bottom;
        while (currGrid.parent) {
            currGrid = currGrid.parent;
            bottom = Math.min(bottom, currGrid.tbody.nativeElement.getBoundingClientRect().bottom);
        }
        return bottom;
    };
    /**
     * @private
     * @param {?} grid
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype._getMaxTop = /**
     * @private
     * @param {?} grid
     * @return {?}
     */
    function (grid) {
        /** @type {?} */
        var currGrid = grid;
        /** @type {?} */
        var top = currGrid.tbody.nativeElement.getBoundingClientRect().top;
        while (currGrid.parent) {
            currGrid = currGrid.parent;
            top = Math.max(top, currGrid.tbody.nativeElement.getBoundingClientRect().top);
        }
        return top;
    };
    /**
     * @private
     * @param {?} elem
     * @param {?} visibleColumnIndex
     * @param {?} grid
     * @param {?=} isSummary
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.focusNextRow = /**
     * @private
     * @param {?} elem
     * @param {?} visibleColumnIndex
     * @param {?} grid
     * @param {?=} isSummary
     * @return {?}
     */
    function (elem, visibleColumnIndex, grid, isSummary) {
        var _this = this;
        /** @type {?} */
        var lastCellIndex = grid.unpinnedColumns[grid.unpinnedColumns.length - 1].visibleIndex;
        visibleColumnIndex = Math.min(lastCellIndex, visibleColumnIndex);
        /** @type {?} */
        var cellSelector = this.getCellSelector(visibleColumnIndex, isSummary);
        if (grid.navigation.isColumnFullyVisible(visibleColumnIndex) || grid.rowList.length === 0) {
            /** @type {?} */
            var cell_1 = elem.querySelector(cellSelector + "[data-visibleIndex=\"" + visibleColumnIndex + "\"]");
            /** @type {?} */
            var closestScrollableGrid = this.getNextScrollableDown(grid).grid;
            // const diff = cell.getBoundingClientRect().bottom - grid.rootGrid.tbody.nativeElement.getBoundingClientRect().bottom;
            /** @type {?} */
            var gridBottom = this._getMinBottom(grid);
            /** @type {?} */
            var diff = cell_1.getBoundingClientRect().bottom - gridBottom;
            /** @type {?} */
            var inView = diff <= 0;
            /** @type {?} */
            var scrollTop = closestScrollableGrid.verticalScrollContainer.scrollPosition;
            /** @type {?} */
            var scrollHeight = closestScrollableGrid.verticalScrollContainer.getScroll().scrollHeight;
            /** @type {?} */
            var canScroll = !(scrollHeight === 0 ||
                Math.round(scrollTop + closestScrollableGrid.verticalScrollContainer.igxForContainerSize) === scrollHeight);
            if (!inView && canScroll) {
                this.scrollGrid(closestScrollableGrid, diff, function () { return cell_1.focus({ preventScroll: true }); });
            }
            else {
                cell_1.focus({ preventScroll: true });
            }
        }
        else {
            this.horizontalScrollGridToIndex(grid, visibleColumnIndex, function () {
                _this.focusNextRow(elem, visibleColumnIndex, grid, isSummary);
            });
        }
    };
    /**
     * @param {?} visibleColumnIndex
     * @param {?=} grid
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.getColumnUnpinnedIndex = /**
     * @param {?} visibleColumnIndex
     * @param {?=} grid
     * @return {?}
     */
    function (visibleColumnIndex, grid) {
        /** @type {?} */
        var currGrid = grid || this.grid;
        /** @type {?} */
        var column = currGrid.unpinnedColumns.find(function (col) { return !col.columnGroup && col.visibleIndex === visibleColumnIndex; });
        return currGrid.pinnedColumns.length ? currGrid.unpinnedColumns.filter(function (c) { return !c.columnGroup; }).indexOf(column) :
            visibleColumnIndex;
    };
    /**
     * @private
     * @param {?} elem
     * @param {?} visibleColumnIndex
     * @param {?} grid
     * @param {?=} inChild
     * @param {?=} isSummary
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.focusPrevRow = /**
     * @private
     * @param {?} elem
     * @param {?} visibleColumnIndex
     * @param {?} grid
     * @param {?=} inChild
     * @param {?=} isSummary
     * @return {?}
     */
    function (elem, visibleColumnIndex, grid, inChild, isSummary) {
        var _this = this;
        /** @type {?} */
        var lastCellIndex = grid.unpinnedColumns[grid.unpinnedColumns.length - 1].visibleIndex;
        visibleColumnIndex = Math.min(lastCellIndex, visibleColumnIndex);
        if (grid.navigation.isColumnFullyVisible(visibleColumnIndex)) {
            /** @type {?} */
            var cellSelector_2 = this.getCellSelector(visibleColumnIndex, isSummary);
            /** @type {?} */
            var cells = elem.querySelectorAll(cellSelector_2 + "[data-visibleIndex=\"" + visibleColumnIndex + "\"]");
            /** @type {?} */
            var cell_2 = cells[cells.length - 1];
            /** @type {?} */
            var rIndex_1 = parseInt(elem.getAttribute('data-rowindex'), 10);
            /** @type {?} */
            var scrGrid = grid.verticalScrollContainer.scrollPosition !== 0 ? grid :
                this.getNextScrollable(grid).grid;
            /** @type {?} */
            var topGrid = scrGrid.tbody.nativeElement.getBoundingClientRect().top >
                grid.rootGrid.tbody.nativeElement.getBoundingClientRect().top ? scrGrid : grid.rootGrid;
            /** @type {?} */
            var gridTop = this._getMaxTop(grid);
            /** @type {?} */
            var scrTop = scrGrid.verticalScrollContainer.scrollPosition;
            /** @type {?} */
            var diff = cell_2.getBoundingClientRect().bottom -
                cell_2.offsetHeight - gridTop;
            if (scrTop !== 0 && diff < 0 && !inChild) {
                this.scrollGrid(scrGrid, diff, function () {
                    /** @type {?} */
                    var el = !isSummary ? grid.navigation.getRowByIndex(rIndex_1) : elem;
                    cell_2 = el.querySelectorAll(cellSelector_2 + "[data-visibleIndex=\"" + visibleColumnIndex + "\"]")[0];
                    cell_2.focus({ preventScroll: true });
                });
            }
            else if (diff < 0 && inChild) {
                this.scrollGrid(topGrid, diff, function () {
                    cell_2.focus({ preventScroll: true });
                });
            }
            else {
                cell_2.focus({ preventScroll: true });
            }
        }
        else {
            this.horizontalScrollGridToIndex(grid, visibleColumnIndex, function () {
                _this.focusPrevRow(elem, visibleColumnIndex, grid, inChild, isSummary);
            });
        }
    };
    /**
     * @private
     * @param {?} grid
     * @param {?} visibleColumnIndex
     * @param {?} callBackFunc
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.horizontalScrollGridToIndex = /**
     * @private
     * @param {?} grid
     * @param {?} visibleColumnIndex
     * @param {?} callBackFunc
     * @return {?}
     */
    function (grid, visibleColumnIndex, callBackFunc) {
        /** @type {?} */
        var unpinnedIndex = this.getColumnUnpinnedIndex(visibleColumnIndex, grid);
        grid.parentVirtDir.onChunkLoad
            .pipe(first())
            .subscribe(callBackFunc);
        if (grid.dataRowList.length > 0) {
            grid.dataRowList.first.virtDirRow.scrollTo(unpinnedIndex);
        }
        else {
            grid.headerContainer.scrollTo(unpinnedIndex);
        }
    };
    /**
     * @private
     * @param {?} grid
     * @param {?} target
     * @param {?} callBackFunc
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.scrollGrid = /**
     * @private
     * @param {?} grid
     * @param {?} target
     * @param {?} callBackFunc
     * @return {?}
     */
    function (grid, target, callBackFunc) {
        this.getFocusableGrid().nativeElement.focus({ preventScroll: true });
        requestAnimationFrame(function () {
            if (typeof target === 'number') {
                grid.verticalScrollContainer.addScrollTop(target);
            }
            else {
                switch (target) {
                    case 'top':
                        grid.verticalScrollContainer.scrollTo(0);
                        break;
                    case 'bottom':
                        grid.verticalScrollContainer.scrollTo(grid.dataView.length - 1);
                        break;
                    case 'next':
                        grid.verticalScrollContainer.scrollNext();
                        break;
                    case 'prev':
                        grid.verticalScrollContainer.scrollPrev();
                        break;
                }
            }
            grid.verticalScrollContainer.onChunkLoad
                .pipe(first())
                .subscribe(callBackFunc);
        });
    };
    /**
     * @private
     * @param {?} rowElement
     * @param {?} currentRowIndex
     * @param {?} visibleColumnIndex
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype._navigateUpInChild = /**
     * @private
     * @param {?} rowElement
     * @param {?} currentRowIndex
     * @param {?} visibleColumnIndex
     * @return {?}
     */
    function (rowElement, currentRowIndex, visibleColumnIndex) {
        var _this = this;
        /** @type {?} */
        var prevElem = rowElement.previousElementSibling;
        /** @type {?} */
        var scrollable = this.getNextScrollable(this.grid);
        /** @type {?} */
        var grid = scrollable.grid;
        /** @type {?} */
        var scrTop = grid.verticalScrollContainer.scrollPosition;
        /** @type {?} */
        var containerTop = scrollable.prev.nativeElement.parentNode.parentNode.parentNode.parentNode;
        /** @type {?} */
        var top = parseInt(containerTop.style.top, 10);
        if (scrTop !== 0 && top < 0) {
            this.scrollGrid(grid, -prevElem.offsetHeight, function () { return _super.prototype.navigateUp.call(_this, rowElement, { row: currentRowIndex, column: visibleColumnIndex }); });
        }
        else {
            _super.prototype.navigateUp.call(this, rowElement, { row: currentRowIndex, column: visibleColumnIndex });
        }
    };
    /**
     * @private
     * @param {?} rowElement
     * @param {?} currentRowIndex
     * @param {?} visibleColumnIndex
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype._navigateDownInChild = /**
     * @private
     * @param {?} rowElement
     * @param {?} currentRowIndex
     * @param {?} visibleColumnIndex
     * @return {?}
     */
    function (rowElement, currentRowIndex, visibleColumnIndex) {
        var _this = this;
        /** @type {?} */
        var nextElem = rowElement.nextElementSibling;
        /** @type {?} */
        var childContainer = this.grid.nativeElement.parentNode.parentNode;
        /** @type {?} */
        var diff = childContainer.getBoundingClientRect().bottom - this.grid.rootGrid.nativeElement.getBoundingClientRect().bottom;
        /** @type {?} */
        var endIsVisible = diff < 0;
        /** @type {?} */
        var scrollable = this.getNextScrollableDown(this.grid);
        /** @type {?} */
        var grid = scrollable.grid;
        if (!endIsVisible) {
            this.scrollGrid(grid, nextElem.offsetHeight, function () { return _super.prototype.navigateDown.call(_this, rowElement, { row: currentRowIndex, column: visibleColumnIndex }); });
        }
        else {
            _super.prototype.navigateDown.call(this, rowElement, { row: currentRowIndex, column: visibleColumnIndex });
        }
    };
    /**
     * @private
     * @param {?} sourceElem
     * @param {?} targetTag
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.getClosestElemByTag = /**
     * @private
     * @param {?} sourceElem
     * @param {?} targetTag
     * @return {?}
     */
    function (sourceElem, targetTag) {
        /** @type {?} */
        var result = sourceElem;
        while (result !== null && result.nodeType === 1) {
            if (result.tagName.toLowerCase() === targetTag.toLowerCase()) {
                return result;
            }
            result = result.parentNode;
        }
        return null;
    };
    /**
     * @protected
     * @param {?} nextIndex
     * @return {?}
     */
    IgxHierarchicalGridNavigationService.prototype.getNextRowByIndex = /**
     * @protected
     * @param {?} nextIndex
     * @return {?}
     */
    function (nextIndex) {
        return this.grid.dataRowList.find(function (element) { return element.index === nextIndex; }).element.nativeElement;
    };
    return IgxHierarchicalGridNavigationService;
}(IgxGridNavigationService));
export { IgxHierarchicalGridNavigationService };
if (false) {
    /** @type {?} */
    IgxHierarchicalGridNavigationService.prototype.grid;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGllcmFyY2hpY2FsLWdyaWQtbmF2aWdhdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vaWduaXRldWktYW5ndWxhci8iLCJzb3VyY2VzIjpbImxpYi9ncmlkcy9oaWVyYXJjaGljYWwtZ3JpZC9oaWVyYXJjaGljYWwtZ3JpZC1uYXZpZ2F0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUV0RSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHdkMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3hDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUU3QztJQUEwRCxnRUFBd0I7SUFBbEY7O0lBOHlCQSxDQUFDOzs7Ozs7O0lBM3lCYSw4REFBZTs7Ozs7O0lBQXpCLFVBQTBCLFlBQXFCLEVBQUUsU0FBaUI7UUFBakIsMEJBQUEsRUFBQSxpQkFBaUI7UUFDOUQsT0FBTyxTQUFTLENBQUMsQ0FBQyxDQUFDLHVCQUF1QixDQUFDLENBQUMsQ0FBQyw0QkFBNEIsQ0FBQztJQUM5RSxDQUFDOzs7OztJQUVTLDZEQUFjOzs7O0lBQXhCO1FBQ0ksT0FBTywyQkFBMkIsQ0FBQztJQUN2QyxDQUFDOzs7Ozs7SUFFUyw0REFBYTs7Ozs7SUFBdkIsVUFBd0IsS0FBSztRQUE3QixpQkFZQzs7WUFYUyxRQUFRLEdBQUcsSUFBSSxDQUFDLGNBQWMsRUFBRTs7WUFDaEMsSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsZ0JBQWdCLENBQ3pELFFBQVEseUJBQW1CLEtBQUssUUFBSSxDQUFDLENBQUM7O1lBQ3pDLEdBQUc7UUFDUCxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQUMsQ0FBQzs7Z0JBQ0wsVUFBVSxHQUFHLEtBQUksQ0FB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LE1BQU0sS0FBSyxJQUFJLElBQUksTUFBTSxDQUFDLFFBQVEsS0FBSyxDQUFDLEVBQUU7WUFDN0MsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxLQUFLLFNBQVMsQ0FBQyxXQUFXLEVBQUUsRUFBRTtnQkFDMUQsT0FBTyxNQUFNLENBQUM7YUFDakI7WUFDRCxNQUFNLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQztTQUM5QjtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7Ozs7OztJQUVTLGdFQUFpQjs7Ozs7SUFBM0IsVUFBNEIsU0FBUztRQUNqQyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxVQUFBLE9BQU8sSUFBSSxPQUFBLE9BQU8sQ0FBQyxLQUFLLEtBQUssU0FBUyxFQUEzQixDQUEyQixDQUFDLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQztJQUNyRyxDQUFDO0lBQ0osMkNBQUM7QUFBRCxDQUFDLEFBOXlCRCxDQUEwRCx3QkFBd0IsR0E4eUJqRjs7OztJQTd5Qkcsb0RBQTBDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSWd4R3JpZE5hdmlnYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi4vZ3JpZC1uYXZpZ2F0aW9uLnNlcnZpY2UnO1xuaW1wb3J0IHsgSWd4SGllcmFyY2hpY2FsR3JpZENvbXBvbmVudCB9IGZyb20gJy4vaGllcmFyY2hpY2FsLWdyaWQuY29tcG9uZW50JztcbmltcG9ydCB7IGZpcnN0IH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgSWd4Q29sdW1uQ29tcG9uZW50IH0gZnJvbSAnLi4vLi4vZ3JpZHMvY29sdW1uLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBJU2VsZWN0aW9uTm9kZSB9IGZyb20gJy4uLy4uL2NvcmUvZ3JpZC1zZWxlY3Rpb24nO1xuaW1wb3J0IHsgaXNJRSB9IGZyb20gJy4uLy4uL2NvcmUvdXRpbHMnO1xuaW1wb3J0IHsgRmlsdGVyTW9kZSB9IGZyb20gJy4uL2NvbW1vbi9lbnVtcyc7XG5cbmV4cG9ydCBjbGFzcyBJZ3hIaWVyYXJjaGljYWxHcmlkTmF2aWdhdGlvblNlcnZpY2UgZXh0ZW5kcyBJZ3hHcmlkTmF2aWdhdGlvblNlcnZpY2Uge1xuICAgIHB1YmxpYyBncmlkOiBJZ3hIaWVyYXJjaGljYWxHcmlkQ29tcG9uZW50O1xuXG4gICAgcHJvdGVjdGVkIGdldENlbGxTZWxlY3Rvcih2aXNpYmxlSW5kZXg/OiBudW1iZXIsIGlzU3VtbWFyeSA9IGZhbHNlKSB7XG4gICAgICAgIHJldHVybiBpc1N1bW1hcnkgPyAnaWd4LWdyaWQtc3VtbWFyeS1jZWxsJyA6ICdpZ3gtaGllcmFyY2hpY2FsLWdyaWQtY2VsbCc7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGdldFJvd1NlbGVjdG9yKCkge1xuICAgICAgICByZXR1cm4gJ2lneC1oaWVyYXJjaGljYWwtZ3JpZC1yb3cnO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBnZXRSb3dCeUluZGV4KGluZGV4KSB7XG4gICAgICAgIGNvbnN0IHNlbGVjdG9yID0gdGhpcy5nZXRSb3dTZWxlY3RvcigpO1xuICAgICAgICBjb25zdCByb3dzID0gQXJyYXkuZnJvbSh0aGlzLmdyaWQubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKFxuICAgICAgICAgICAgYCR7c2VsZWN0b3J9W2RhdGEtcm93aW5kZXg9XCIke2luZGV4fVwiXWApKTtcbiAgICAgICAgbGV0IHJvdztcbiAgICAgICAgcm93cy5mb3JFYWNoKChyKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBwYXJlbnRHcmlkID0gdGhpcy5nZXRDbG9zZXN0RWxlbUJ5VGFnKHIsICdpZ3gtaGllcmFyY2hpY2FsLWdyaWQnKTtcbiAgICAgICAgICAgIGlmIChwYXJlbnRHcmlkICYmIHBhcmVudEdyaWQuZ2V0QXR0cmlidXRlKCdpZCcpID09PSB0aGlzLmdyaWQuaWQpIHtcbiAgICAgICAgICAgICAgICByb3cgPSByO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHJvdztcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldENoaWxkQ29udGFpbmVyKGdyaWQ/KSB7XG4gICAgICAgIGNvbnN0IGN1cnJHcmlkID0gZ3JpZCB8fCB0aGlzLmdyaWQ7XG4gICAgICAgIHJldHVybiBjdXJyR3JpZC5uYXRpdmVFbGVtZW50LnBhcmVudE5vZGUucGFyZW50Tm9kZS5wYXJlbnROb2RlO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0Q2hpbGRHcmlkUm93Q29udGFpbmVyKGdyaWQ/KSB7XG4gICAgICAgIGNvbnN0IGN1cnJHcmlkID0gZ3JpZCB8fCB0aGlzLmdyaWQ7XG4gICAgICAgIHJldHVybiBjdXJyR3JpZC5uYXRpdmVFbGVtZW50LnBhcmVudE5vZGUucGFyZW50Tm9kZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldENoaWxkR3JpZChjaGlsZEdyaWRJRCwgZ3JpZCkge1xuICAgICAgICBjb25zdCBjZ3JpZCA9IGdyaWQuaGdyaWRBUEkuZ2V0Q2hpbGRHcmlkcyh0cnVlKS5maWx0ZXIoKGcpID0+IGcuaWQgPT09IGNoaWxkR3JpZElEKVswXTtcbiAgICAgICAgcmV0dXJuIGNncmlkO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2lzU2Nyb2xsZWRUb0JvdHRvbShncmlkKSB7XG4gICAgICAgIGNvbnN0IHNjcm9sbFRvcCA9IGdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXIuc2Nyb2xsUG9zaXRpb247XG4gICAgICAgIGNvbnN0IHNjcm9sbEhlaWdodCA9IGdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXIuZ2V0U2Nyb2xsKCkuc2Nyb2xsSGVpZ2h0O1xuICAgICAgICByZXR1cm4gc2Nyb2xsSGVpZ2h0ID09PSAwIHx8IE1hdGgucm91bmQoc2Nyb2xsVG9wICsgZ3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5pZ3hGb3JDb250YWluZXJTaXplKSA9PT0gc2Nyb2xsSGVpZ2h0O1xuICAgIH1cbiAgICBwcml2YXRlIGdldElzQ2hpbGRBdEluZGV4KGluZGV4KSB7XG4gICAgICAgIHJldHVybiB0aGlzLmdyaWQuaXNDaGlsZEdyaWRSZWNvcmQodGhpcy5ncmlkLmRhdGFWaWV3W2luZGV4XSk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldENlbGxFbGVtZW50QnlWaXNpYmxlSW5kZXgocm93SW5kZXgsIHZpc2libGVDb2x1bW5JbmRleCwgaXNTdW1tYXJ5ID0gZmFsc2UpIHtcbiAgICAgICAgY29uc3QgY2VsbFNlbGVjdG9yID0gdGhpcy5nZXRDZWxsU2VsZWN0b3IodmlzaWJsZUNvbHVtbkluZGV4LCBpc1N1bW1hcnkpO1xuICAgICAgICBpZiAoaXNTdW1tYXJ5KSB7XG4gICAgICAgICAgICBjb25zdCBzdW1tYXJ5Um93ID0gdGhpcy5ncmlkLnN1bW1hcmllc1Jvd0xpc3QudG9BcnJheSgpWzBdLm5hdGl2ZUVsZW1lbnQ7XG4gICAgICAgICAgICByZXR1cm4gc3VtbWFyeVJvdy5xdWVyeVNlbGVjdG9yKFxuICAgICAgICAgICAgICAgIGAke2NlbGxTZWxlY3Rvcn1bZGF0YS12aXNpYmxlSW5kZXg9XCIke3Zpc2libGVDb2x1bW5JbmRleH1cIl1gKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCByb3cgPSB0aGlzLmdldFJvd0J5SW5kZXgocm93SW5kZXgpO1xuICAgICAgICByZXR1cm4gcm93LnF1ZXJ5U2VsZWN0b3IoXG4gICAgICAgICAgICBgJHtjZWxsU2VsZWN0b3J9W2RhdGEtcm93aW5kZXg9XCIke3Jvd0luZGV4fVwiXVtkYXRhLXZpc2libGVJbmRleD1cIiR7dmlzaWJsZUNvbHVtbkluZGV4fVwiXWApO1xuICAgIH1cblxuICAgIHB1YmxpYyBuYXZpZ2F0ZVVwKHJvd0VsZW1lbnQsIHNlbGVjdGVkTm9kZTogSVNlbGVjdGlvbk5vZGUpIHtcbiAgICAgICAgaWYgKHNlbGVjdGVkTm9kZS5pc1N1bW1hcnlSb3cpIHsgcmV0dXJuOyB9XG4gICAgICAgIGNvbnN0IHByZXZFbGVtID0gcm93RWxlbWVudC5wcmV2aW91c0VsZW1lbnRTaWJsaW5nO1xuICAgICAgICBjb25zdCB2aXNpYmxlQ29sdW1uSW5kZXggPSBzZWxlY3RlZE5vZGUuY29sdW1uO1xuICAgICAgICBjb25zdCBjdXJyZW50Um93SW5kZXggPSBzZWxlY3RlZE5vZGUucm93O1xuICAgICAgICBpZiAocHJldkVsZW0pIHtcbiAgICAgICAgICAgIGNvbnN0IG5vZGVOYW1lID0gcHJldkVsZW0uY2hpbGRyZW5bMF0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgIGNvbnN0IGlzRWxlbUNoaWxkR3JpZCA9IG5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdpZ3gtY2hpbGQtZ3JpZC1yb3cnO1xuICAgICAgICAgICAgaWYgKGlzRWxlbUNoaWxkR3JpZCkge1xuICAgICAgICAgICAgICAgIHRoaXMuZm9jdXNQcmV2Q2hpbGQocHJldkVsZW0sIHZpc2libGVDb2x1bW5JbmRleCwgdGhpcy5ncmlkKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZ3JpZC5wYXJlbnQgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gY3VycmVudGx5IG5hdmlnYXRpbmcgaW4gY2hpbGQgZ3JpZFxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9uYXZpZ2F0ZVVwSW5DaGlsZChyb3dFbGVtZW50LCBjdXJyZW50Um93SW5kZXgsIHZpc2libGVDb2x1bW5JbmRleCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgc3VwZXIubmF2aWdhdGVVcChyb3dFbGVtZW50LCBzZWxlY3RlZE5vZGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChjdXJyZW50Um93SW5kZXggIT09IDApIHtcbiAgICAgICAgICAgIC8vIGhhbmRsZSBzY2VuYXJpbyB3aGVuIHByZXYgaXRlbSBpcyBjaGlsZCBncmlkIGJ1dCBpcyBub3QgeWV0IGluIHZpZXdcbiAgICAgICAgICAgIGNvbnN0IGlzUHJldkNoaWxkR3JpZCA9IHRoaXMuZ2V0SXNDaGlsZEF0SW5kZXgoY3VycmVudFJvd0luZGV4IC0gMSk7XG4gICAgICAgICAgICBpZiAoIWlzUHJldkNoaWxkR3JpZCkge1xuICAgICAgICAgICAgICAgIHN1cGVyLm5hdmlnYXRlVXAocm93RWxlbWVudCwgc2VsZWN0ZWROb2RlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zY3JvbGxHcmlkKHRoaXMuZ3JpZCwgLXJvd0VsZW1lbnQub2Zmc2V0SGVpZ2h0LFxuICAgICAgICAgICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByb3dFbGVtZW50ID0gdGhpcy5nZXRSb3dCeUluZGV4KGN1cnJlbnRSb3dJbmRleCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm5hdmlnYXRlVXAocm93RWxlbWVudCwgc2VsZWN0ZWROb2RlKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5ncmlkLnBhcmVudCAhPT0gbnVsbCAmJlxuICAgICAgICAgICAgY3VycmVudFJvd0luZGV4ID09PSAwKSB7XG4gICAgICAgICAgICAvLyBtb3ZlIHRvIHByZXYgcm93IGluIHNpYmxpbmcgbGF5b3V0IG9yIHBhcmVudFxuICAgICAgICAgICAgdGhpcy5mb2N1c1ByZXYodmlzaWJsZUNvbHVtbkluZGV4KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBwdWJsaWMgbmF2aWdhdGVEb3duKHJvd0VsZW1lbnQsIHNlbGVjdGVkTm9kZTogSVNlbGVjdGlvbk5vZGUpIHtcbiAgICAgICAgaWYgKHNlbGVjdGVkTm9kZS5pc1N1bW1hcnlSb3cpIHsgcmV0dXJuOyB9XG4gICAgICAgIGNvbnN0IG5leHRFbGVtID0gcm93RWxlbWVudC5uZXh0RWxlbWVudFNpYmxpbmc7XG4gICAgICAgIGNvbnN0IHZpc2libGVDb2x1bW5JbmRleCA9IHNlbGVjdGVkTm9kZS5jb2x1bW47XG4gICAgICAgIGNvbnN0IGN1cnJlbnRSb3dJbmRleCA9IHNlbGVjdGVkTm9kZS5yb3c7XG4gICAgICAgIGlmIChuZXh0RWxlbSkge1xuICAgICAgICAgICAgLy8gbmV4dCBlbGVtIGlzIGluIERPTVxuICAgICAgICAgICAgY29uc3Qgbm9kZU5hbWUgPSBuZXh0RWxlbS5jaGlsZHJlblswXS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICAgICAgY29uc3QgaXNOZXh0RWxlbUNoaWxkR3JpZCA9IG5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdpZ3gtY2hpbGQtZ3JpZC1yb3cnO1xuICAgICAgICAgICAgaWYgKGlzTmV4dEVsZW1DaGlsZEdyaWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZvY3VzTmV4dENoaWxkKG5leHRFbGVtLCB2aXNpYmxlQ29sdW1uSW5kZXgsIHRoaXMuZ3JpZCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLmdyaWQucGFyZW50ICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGN1cnJlbnRseSBuYXZpZ2F0aW5nIGluIGNoaWxkIGdyaWRcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbmF2aWdhdGVEb3duSW5DaGlsZChyb3dFbGVtZW50LCBjdXJyZW50Um93SW5kZXgsIHZpc2libGVDb2x1bW5JbmRleCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgc3VwZXIubmF2aWdhdGVEb3duKHJvd0VsZW1lbnQsIHNlbGVjdGVkTm9kZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGN1cnJlbnRSb3dJbmRleCAhPT0gdGhpcy5ncmlkLmRhdGFWaWV3Lmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICAgIC8vIHNjcm9sbCBuZXh0IGluIHZpZXdcbiAgICAgICAgICAgIHN1cGVyLm5hdmlnYXRlRG93bihyb3dFbGVtZW50LCBzZWxlY3RlZE5vZGUpO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuZ3JpZC5wYXJlbnQgIT09IG51bGwgJiZcbiAgICAgICAgICAgIGN1cnJlbnRSb3dJbmRleCA9PT0gdGhpcy5ncmlkLmRhdGFWaWV3Lmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICAgIC8vIG1vdmUgdG8gbmV4dCByb3cgaW4gc2libGluZyBsYXlvdXQgb3IgaW4gcGFyZW50XG4gICAgICAgICAgICB0aGlzLmZvY3VzTmV4dCh2aXNpYmxlQ29sdW1uSW5kZXgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIG5hdmlnYXRlVG9wKHZpc2libGVDb2x1bW5JbmRleCkge1xuICAgICAgICBpZiAodGhpcy5ncmlkLnBhcmVudCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgLy8gbmF2aWdhdGluZyBpbiBjaGlsZFxuICAgICAgICAgICAgY29uc3QgY2hpbGRDb250YWluZXIgPSB0aGlzLmdyaWQubmF0aXZlRWxlbWVudC5wYXJlbnROb2RlLnBhcmVudE5vZGU7XG4gICAgICAgICAgICBjb25zdCBkaWZmID1cbiAgICAgICAgICAgIGNoaWxkQ29udGFpbmVyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnRvcCAtIHRoaXMuZ3JpZC5yb290R3JpZC50Ym9keS5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnRvcDtcbiAgICAgICAgICAgIGNvbnN0IHRvcElzVmlzaWJsZSA9IGRpZmYgPj0gMDtcbiAgICAgICAgICAgIGNvbnN0IHNjcm9sbGFibGUgPSB0aGlzLmdldE5leHRTY3JvbGxhYmxlKHRoaXMuZ3JpZCk7XG4gICAgICAgICAgICBpZiAoIXRvcElzVmlzaWJsZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsR3JpZChzY3JvbGxhYmxlLmdyaWQsIGRpZmYsXG4gICAgICAgICAgICAgICAgICAgICgpID0+IHN1cGVyLm5hdmlnYXRlVG9wKHZpc2libGVDb2x1bW5JbmRleCkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBzdXBlci5uYXZpZ2F0ZVRvcCh2aXNpYmxlQ29sdW1uSW5kZXgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3VwZXIubmF2aWdhdGVUb3AodmlzaWJsZUNvbHVtbkluZGV4KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBuYXZpZ2F0ZUJvdHRvbSh2aXNpYmxlQ29sdW1uSW5kZXgpIHtcbiAgICAgICAgLy8gaGFuZGxlIHNjZW5hcmlvIHdoZXJlIGxhc3QgaW5kZXggaXMgY2hpbGQgZ3JpZFxuICAgICAgICAvLyBpbiB0aGF0IGNhc2UgZm9jdXMgY2VsbCBpbiBsYXN0IGRhdGEgcm93XG4gICAgICAgIGNvbnN0IGxhc3RJbmRleCA9IHRoaXMuZ3JpZC5kYXRhVmlldy5sZW5ndGggLSAxO1xuICAgICAgICBpZiAodGhpcy5nZXRJc0NoaWxkQXRJbmRleChsYXN0SW5kZXgpKSB7XG4gICAgICAgICAgICBjb25zdCB0YXJnZXRJbmRleCA9IGxhc3RJbmRleCAtIDE7XG4gICAgICAgICAgICBjb25zdCBzY3JUb3BQb3NpdGlvbiA9IHRoaXMuZ3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5nZXRTY3JvbGxGb3JJbmRleCh0YXJnZXRJbmRleCwgdHJ1ZSk7XG4gICAgICAgICAgICBjb25zdCB2ZXJ0aWNhbFNjcm9sbFRvcCA9IHRoaXMuZ3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5zY3JvbGxQb3NpdGlvbjtcbiAgICAgICAgICAgIGNvbnN0IGNlbGxTZWxlY3RvciA9IHRoaXMuZ2V0Q2VsbFNlbGVjdG9yKHZpc2libGVDb2x1bW5JbmRleCk7XG4gICAgICAgICAgICBpZiAodmVydGljYWxTY3JvbGxUb3AgPT09IHNjclRvcFBvc2l0aW9uKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY2VsbHMgPSB0aGlzLmdldFJvd0J5SW5kZXgodGFyZ2V0SW5kZXgpLnF1ZXJ5U2VsZWN0b3JBbGwoXG4gICAgICAgICAgICAgICAgICAgIGAke2NlbGxTZWxlY3Rvcn1bZGF0YS12aXNpYmxlSW5kZXg9XCIke3Zpc2libGVDb2x1bW5JbmRleH1cIl1gKTtcbiAgICAgICAgICAgICAgICBjZWxsc1tjZWxscy5sZW5ndGggLSAxXS5mb2N1cygpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbEdyaWQodGhpcy5ncmlkLCBzY3JUb3BQb3NpdGlvbiAtIHZlcnRpY2FsU2Nyb2xsVG9wLFxuICAgICAgICAgICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjZWxscyA9IHRoaXMuZ2V0Um93QnlJbmRleCh0YXJnZXRJbmRleCkucXVlcnlTZWxlY3RvckFsbChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBgJHtjZWxsU2VsZWN0b3J9W2RhdGEtdmlzaWJsZUluZGV4PVwiJHt2aXNpYmxlQ29sdW1uSW5kZXh9XCJdYCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2VsbHMubGVuZ3RoID4gMCkgeyBjZWxsc1tjZWxscy5sZW5ndGggLSAxXS5mb2N1cygpOyB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgIGlmICh0aGlzLmdyaWQucGFyZW50ICE9PSBudWxsKSB7XG4gICAgICAgICAgICBjb25zdCBjaGlsZENvbnRhaW5lciA9IHRoaXMuZ3JpZC5uYXRpdmVFbGVtZW50LnBhcmVudE5vZGUucGFyZW50Tm9kZTtcbiAgICAgICAgICAgIGNvbnN0IGRpZmYgPVxuICAgICAgICAgICAgY2hpbGRDb250YWluZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkuYm90dG9tIC0gdGhpcy5ncmlkLnJvb3RHcmlkLnRib2R5Lm5hdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkuYm90dG9tO1xuICAgICAgICAgICAgY29uc3QgZW5kSXNWaXNpYmxlID0gZGlmZiA8IDA7XG4gICAgICAgICAgICBjb25zdCBzY3JvbGxhYmxlID0gdGhpcy5nZXROZXh0U2Nyb2xsYWJsZURvd24odGhpcy5ncmlkKTtcbiAgICAgICAgICAgIGlmICghZW5kSXNWaXNpYmxlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zY3JvbGxHcmlkKHNjcm9sbGFibGUuZ3JpZCwgZGlmZixcbiAgICAgICAgICAgICAgICAgICAgKCkgPT4gc3VwZXIubmF2aWdhdGVCb3R0b20odmlzaWJsZUNvbHVtbkluZGV4KSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHN1cGVyLm5hdmlnYXRlQm90dG9tKHZpc2libGVDb2x1bW5JbmRleCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzdXBlci5uYXZpZ2F0ZUJvdHRvbSh2aXNpYmxlQ29sdW1uSW5kZXgpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHB1YmxpYyBnb1RvTGFzdENlbGwoKSB7XG4gICAgICAgIC8vIGhhbmRsZSBzY2VuYXJpbyB3aGVyZSBsYXN0IGluZGV4IGlzIGNoaWxkIGdyaWRcbiAgICAgICAgLy8gaW4gdGhhdCBjYXNlIGZvY3VzIGxhc3QgY2VsbCBpbiBsYXN0IGRhdGEgcm93XG4gICAgICAgIGNvbnN0IGxhc3RJbmRleCA9IHRoaXMuZ3JpZC5kYXRhVmlldy5sZW5ndGggLSAxO1xuICAgICAgICBpZiAodGhpcy5nZXRJc0NoaWxkQXRJbmRleChsYXN0SW5kZXgpKSB7XG4gICAgICAgICAgICBjb25zdCB0YXJnZXRJbmRleCA9IGxhc3RJbmRleCAtIDE7XG4gICAgICAgICAgICBjb25zdCBzY3JUb3BQb3NpdGlvbiA9IHRoaXMuZ3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5nZXRTY3JvbGxGb3JJbmRleCh0YXJnZXRJbmRleCwgdHJ1ZSk7XG4gICAgICAgICAgICBjb25zdCB2ZXJ0aWNhbFNjcm9sbFRvcCA9IHRoaXMuZ3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5zY3JvbGxQb3NpdGlvbjtcbiAgICAgICAgICAgIGlmICh2ZXJ0aWNhbFNjcm9sbFRvcCA9PT0gc2NyVG9wUG9zaXRpb24pIHtcbiAgICAgICAgICAgICAgICB0aGlzLm9uS2V5ZG93bkVuZCh0YXJnZXRJbmRleCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsR3JpZCh0aGlzLmdyaWQsIHNjclRvcFBvc2l0aW9uIC0gdmVydGljYWxTY3JvbGxUb3AsXG4gICAgICAgICAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25LZXlkb3duRW5kKHRhcmdldEluZGV4KTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzdXBlci5nb1RvTGFzdENlbGwoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBvbktleWRvd25FbmQocm93SW5kZXgsIGlzU3VtbWFyeSA9IGZhbHNlKSB7XG4gICAgICAgIGlmICh0aGlzLmdyaWQucGFyZW50ICYmICFpc1N1bW1hcnkpIHtcbiAgICAgICAgICAgIC8vIGhhbmRsZSBzY2VuYXJpbyB3aGVyZSBsYXN0IGNoaWxkIHJvdyBtaWdodCBub3QgYmUgaW4gdmlld1xuICAgICAgICAgICAgLy8gcGFyZW50IHNob3VsZCBzY3JvbGwgdG8gY2hpbGQgZ3JpZCBlbmRcbiAgICAgICAgICAgIGNvbnN0IGNoaWxkQ29udGFpbmVyID0gdGhpcy5ncmlkLm5hdGl2ZUVsZW1lbnQucGFyZW50Tm9kZS5wYXJlbnROb2RlO1xuICAgICAgICAgICAgY29uc3QgZGlmZkJvdHRvbSA9XG4gICAgICAgICAgICAgICAgY2hpbGRDb250YWluZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkuYm90dG9tIC0gdGhpcy5ncmlkLnJvb3RHcmlkLm5hdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkuYm90dG9tO1xuICAgICAgICAgICAgY29uc3Qgcm93ID0gdGhpcy5ncmlkLmdldFJvd0J5SW5kZXgocm93SW5kZXgpLmVsZW1lbnQubmF0aXZlRWxlbWVudDtcbiAgICAgICAgICAgIGNvbnN0IHJvd0JvdHRvbSA9IHJvdy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5ib3R0b207XG4gICAgICAgICAgICBjb25zdCByb3dJc1Zpc2libGUgPSByb3dCb3R0b20gPD0gdGhpcy5ncmlkLnJvb3RHcmlkLnRib2R5Lm5hdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkuYm90dG9tO1xuICAgICAgICAgICAgY29uc3QgZ3JpZFRvcCA9IHRoaXMuX2dldE1heFRvcCh0aGlzLmdyaWQpO1xuICAgICAgICAgICAgY29uc3QgZGlmZlRvcCA9IHJvdy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5ib3R0b20gLVxuICAgICAgICAgICAgICAgIHJvdy5vZmZzZXRIZWlnaHQgLSBncmlkVG9wO1xuICAgICAgICAgICAgY29uc3QgZW5kSXNWaXNpYmxlID0gZGlmZkJvdHRvbSA8PSAwO1xuICAgICAgICAgICAgY29uc3QgdG9wVmlzaWJsZSA9IGRpZmZUb3AgPj0gMDtcbiAgICAgICAgICAgIGlmICghZW5kSXNWaXNpYmxlICYmICFyb3dJc1Zpc2libGUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbEdyaWQodGhpcy5ncmlkLnBhcmVudCwgZGlmZkJvdHRvbSwgKCkgPT4gc3VwZXIub25LZXlkb3duRW5kKHJvd0luZGV4KSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKCF0b3BWaXNpYmxlKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc2NyR3JpZCA9IHRoaXMuZ3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5zY3JvbGxQb3NpdGlvbiAhPT0gMCA/IHRoaXMuZ3JpZCA6XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0TmV4dFNjcm9sbGFibGUodGhpcy5ncmlkKS5ncmlkO1xuICAgICAgICAgICAgICAgIGNvbnN0IHRvcEdyaWQgPSBzY3JHcmlkLnRib2R5Lm5hdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkudG9wID5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5ncmlkLnJvb3RHcmlkLnRib2R5Lm5hdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkudG9wID8gc2NyR3JpZCA6IHRoaXMuZ3JpZC5yb290R3JpZDtcbiAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbEdyaWQodG9wR3JpZCwgZGlmZlRvcCwgKCkgPT4gc3VwZXIub25LZXlkb3duRW5kKHJvd0luZGV4KSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHN1cGVyLm9uS2V5ZG93bkVuZChyb3dJbmRleCwgaXNTdW1tYXJ5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN1cGVyLm9uS2V5ZG93bkVuZChyb3dJbmRleCwgaXNTdW1tYXJ5KTtcbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgcHVibGljIGdvVG9GaXJzdENlbGwoKSB7XG4gICAgICAgIGNvbnN0IHZlcnRpY2FsU2Nyb2xsID0gdGhpcy5ncmlkLnZlcnRpY2FsU2Nyb2xsQ29udGFpbmVyLmdldFNjcm9sbCgpO1xuICAgICAgICBjb25zdCBob3Jpem9udGFsU2Nyb2xsID0gdGhpcy5ncmlkLmRhdGFSb3dMaXN0LmZpcnN0LnZpcnREaXJSb3cuZ2V0U2Nyb2xsKCk7XG4gICAgICAgIGlmICh2ZXJ0aWNhbFNjcm9sbC5zY3JvbGxUb3AgPT09IDAgJiYgdGhpcy5ncmlkLnBhcmVudCkge1xuICAgICAgICAgICAgLy8gc2Nyb2xsIHBhcmVudCBzbyB0aGF0IGN1cnJlbnQgY2hpbGQgaXMgaW4gdmlld1xuICAgICAgICAgICAgaWYgKCFob3Jpem9udGFsU2Nyb2xsLmNsaWVudFdpZHRoIHx8IHBhcnNlSW50KGhvcml6b250YWxTY3JvbGwuc2Nyb2xsTGVmdCwgMTApIDw9IDEgfHwgdGhpcy5ncmlkLnBpbm5lZENvbHVtbnMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5uYXZpZ2F0ZVRvcCgwKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5ob3Jpem9udGFsU2Nyb2xsKHRoaXMuZ3JpZC5kYXRhUm93TGlzdC5maXJzdC5pbmRleCkuc2Nyb2xsVG8oMCk7XG4gICAgICAgICAgICAgICAgdGhpcy5ncmlkLnBhcmVudFZpcnREaXIub25DaHVua0xvYWRcbiAgICAgICAgICAgICAgICAgICAgLnBpcGUoZmlyc3QoKSlcbiAgICAgICAgICAgICAgICAgICAgLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm5hdmlnYXRlVG9wKDApO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN1cGVyLmdvVG9GaXJzdENlbGwoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBwZXJmb3JtVGFiKGN1cnJlbnRSb3dFbCwgc2VsZWN0ZWROb2RlOiBJU2VsZWN0aW9uTm9kZSkge1xuICAgICAgICBpZiAodGhpcy5ncmlkLnJvd0luRWRpdE1vZGUpIHtcbiAgICAgICAgICAgIHN1cGVyLnBlcmZvcm1UYWIoY3VycmVudFJvd0VsLCBzZWxlY3RlZE5vZGUpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHJvd0luZGV4ID0gc2VsZWN0ZWROb2RlLnJvdztcbiAgICAgICAgY29uc3QgdmlzaWJsZUNvbHVtbkluZGV4ID0gc2VsZWN0ZWROb2RlLmNvbHVtbjtcbiAgICAgICAgY29uc3QgaXNTdW1tYXJ5Um93ID0gc2VsZWN0ZWROb2RlLmlzU3VtbWFyeVJvdztcbiAgICAgICAgY29uc3Qgc3VtbWFyeVJvd3MgPSB0aGlzLmdyaWQuc3VtbWFyaWVzUm93TGlzdC50b0FycmF5KCk7XG4gICAgICAgIGNvbnN0IGhhc1N1bW1hcmllcyA9IHN1bW1hcnlSb3dzLmxlbmd0aCA+IDA7XG4gICAgICAgIGNvbnN0IGlzTGFzdERhdGFSb3cgPSByb3dJbmRleCA9PT0gdGhpcy5ncmlkLmRhdGFWaWV3Lmxlbmd0aCAtIDE7XG4gICAgICAgIGNvbnN0IG5leHRJc0RhdGFSb3cgPSB0aGlzLmdyaWQuZGF0YVJvd0xpc3QuZmluZChyb3cgPT4gcm93LmluZGV4ID09PSByb3dJbmRleCArIDEpO1xuICAgICAgICBjb25zdCBpc0xhc3RDb2x1bW4gPSB0aGlzLmdyaWQudW5waW5uZWRDb2x1bW5zW3RoaXMuZ3JpZC51bnBpbm5lZENvbHVtbnMubGVuZ3RoIC0gMV0udmlzaWJsZUluZGV4ID09PSB2aXNpYmxlQ29sdW1uSW5kZXg7XG4gICAgICAgIGNvbnN0IGlzTGFzdFN1bW1hcnlSb3cgPSBoYXNTdW1tYXJpZXMgJiYgaXNTdW1tYXJ5Um93O1xuICAgICAgICBjb25zdCBuZXh0SW5kZXggPSByb3dJbmRleCArIDE7XG4gICAgICAgIGNvbnN0IHZpcnQgPSB0aGlzLmdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXI7XG4gICAgICAgIGNvbnN0IGlzTmV4dENoaWxkID0gbmV4dEluZGV4IDw9IHZpcnQuaWd4Rm9yT2YubGVuZ3RoIC0gMSAmJlxuICAgICAgICAgICAgdGhpcy5ncmlkLmlzQ2hpbGRHcmlkUmVjb3JkKHZpcnQuaWd4Rm9yT2ZbbmV4dEluZGV4XSk7XG4gICAgICAgIGlmICghbmV4dElzRGF0YVJvdyAmJiAhKGlzTGFzdERhdGFSb3cgJiYgaGFzU3VtbWFyaWVzKSAmJiBpc0xhc3RDb2x1bW4gJiYgIWlzU3VtbWFyeVJvdykge1xuICAgICAgICAgICAgLy8gbmF2aWdhdGluZyBpbiBjaGlsZCwgbmV4dCBpcyBub3Qgc3VtbWFyeVxuICAgICAgICAgICAgY29uc3QgY2hpbGRDb250YWluZXIgPSB0aGlzLmdldENoaWxkR3JpZFJvd0NvbnRhaW5lcigpO1xuICAgICAgICAgICAgY29uc3QgbmV4dElzU2libGluZ0NoaWxkID0gdGhpcy5ncmlkLnBhcmVudCA/ICEhY2hpbGRDb250YWluZXIubmV4dEVsZW1lbnRTaWJsaW5nIDogZmFsc2U7XG4gICAgICAgICAgICBpZiAobmV4dElzU2libGluZ0NoaWxkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5mb2N1c05leHRDaGlsZERPTUVsZW0oY2hpbGRDb250YWluZXIsIHRoaXMuZ3JpZC5wYXJlbnQpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChpc05leHRDaGlsZCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGlzSW5WaWV3ID0gdmlydC5zdGF0ZS5zdGFydEluZGV4ICsgdmlydC5zdGF0ZS5jaHVua1NpemUgPiBuZXh0SW5kZXg7XG4gICAgICAgICAgICAgICAgaWYgKCFpc0luVmlldykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbEdyaWQodGhpcy5ncmlkLCAnbmV4dCcsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZm9jdXNOZXh0Q2hpbGRET01FbGVtKGN1cnJlbnRSb3dFbCwgdGhpcy5ncmlkKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5mb2N1c05leHRDaGlsZERPTUVsZW0oY3VycmVudFJvd0VsLCB0aGlzLmdyaWQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5ncmlkLnBhcmVudCAmJiB0aGlzLmdyaWQucGFyZW50LnN1bW1hcmllc1Jvd0xpc3QubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgdGhpcy5fbmF2aWdhdGVUb05leHRQYXJlbnRSb3coY3VycmVudFJvd0VsKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5uYXZpZ2F0ZURvd24oY3VycmVudFJvd0VsLCB7IHJvdzogcm93SW5kZXgsIGNvbHVtbjogMCB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChpc0xhc3RTdW1tYXJ5Um93ICYmIGlzTGFzdENvbHVtbiAmJiB0aGlzLmdyaWQucGFyZW50KSB7XG4gICAgICAgICAgICB0aGlzLl9uYXZpZ2F0ZVRvTmV4dFBhcmVudFJvdyhjdXJyZW50Um93RWwpO1xuICAgICAgICB9IGVsc2UgIGlmIChpc0xhc3REYXRhUm93ICYmIGhhc1N1bW1hcmllcyAmJiBpc0xhc3RDb2x1bW4gJiYgdGhpcy5ncmlkLnBhcmVudCkge1xuICAgICAgICAgICAgLy8gbmF2aWdhdGluZyBpbiBjaGlsZCByb3dzLCBuZXh0IGlzIGNoaWxkIGdyaWQncyBzdW1tYXJ5IHJvd1xuICAgICAgICAgICB0aGlzLmZvY3VzTmV4dFJvdyhzdW1tYXJ5Um93c1swXS5uYXRpdmVFbGVtZW50LCAwLCB0aGlzLmdyaWQucGFyZW50LCB0cnVlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN1cGVyLnBlcmZvcm1UYWIoY3VycmVudFJvd0VsLCBzZWxlY3RlZE5vZGUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfbmF2aWdhdGVUb05leHRQYXJlbnRSb3coY3VycmVudFJvd0VsOiBhbnkpOiB2b2lkIHtcbiAgICAgICAgIC8vIG5leHQgaXMgcGFyZW50IHN1bW1hcnkgb3IgbmV4dCBwYXJlbnQgcm93XG4gICAgICAgICBjb25zdCBwYXJlbnQgPSB0aGlzLmdyaWQucGFyZW50O1xuICAgICAgICAgY29uc3QgcGFyZW50SGFzU3VtbWFyeSA9IHBhcmVudC5zdW1tYXJpZXNSb3dMaXN0Lmxlbmd0aCA+IDA7XG4gICAgICAgICBjb25zdCBwYXJlbnRSb3dJbmRleCA9IHBhcnNlSW50KFxuICAgICAgICAgICAgdGhpcy5nZXRDbG9zZXN0RWxlbUJ5VGFnKGN1cnJlbnRSb3dFbCwgJ2lneC1jaGlsZC1ncmlkLXJvdycpLnBhcmVudE5vZGUuZ2V0QXR0cmlidXRlKCdkYXRhLXJvd2luZGV4JyksIDEwKTtcbiAgICAgICAgIGNvbnN0IGlzTGFzdFJvd0luUGFyZW50ID0gcGFyZW50LmRhdGFWaWV3Lmxlbmd0aCAtIDEgPT09IHBhcmVudFJvd0luZGV4O1xuICAgICAgICAgLy8gY2hlY2sgaWYgbmV4dCBpcyBzaWJsaW5nXG4gICAgICAgICBjb25zdCBjaGlsZFJvd0NvbnRhaW5lciA9IHRoaXMuZ2V0Q2hpbGRHcmlkUm93Q29udGFpbmVyKHRoaXMuZ3JpZCk7XG4gICAgICAgICBjb25zdCBuZXh0SXNTaWJsaW5nQ2hpbGQgPSAhIWNoaWxkUm93Q29udGFpbmVyLm5leHRFbGVtZW50U2libGluZztcbiAgICAgICAgIGlmIChpc0xhc3RSb3dJblBhcmVudCAmJiBwYXJlbnRIYXNTdW1tYXJ5ICYmICFuZXh0SXNTaWJsaW5nQ2hpbGQpIHtcbiAgICAgICAgICAgICAvLyBuZXh0IGlzIHBhcmVudCBzdW1tYXJ5XG4gICAgICAgICAgICAgY29uc3QgcGFyZW50U3VtbWFyeSA9IHBhcmVudC5zdW1tYXJpZXNSb3dMaXN0LmZpcnN0Lm5hdGl2ZUVsZW1lbnQ7XG4gICAgICAgICAgICAgcGFyZW50Lm5hdmlnYXRpb24uZm9jdXNOZXh0Um93KHBhcmVudFN1bW1hcnksIDAsIHBhcmVudCwgdHJ1ZSk7XG4gICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgIC8vIG5leHQgaXMgc2libGluZyBvciBwYXJlbnRcbiAgICAgICAgICAgICB0aGlzLmZvY3VzTmV4dCgwKTtcbiAgICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGZvY3VzTmV4dENoaWxkRE9NRWxlbShjdXJyZW50Um93RWwsIGdyaWQpIHtcbiAgICAgICAgY29uc3QgZ3JpZEVsZW0gPSBjdXJyZW50Um93RWwubmV4dEVsZW1lbnRTaWJsaW5nLnF1ZXJ5U2VsZWN0b3IoJ2lneC1oaWVyYXJjaGljYWwtZ3JpZCcpO1xuICAgICAgICBjb25zdCBjaGlsZEdyaWRJRCA9IGdyaWRFbGVtLmdldEF0dHJpYnV0ZSgnaWQnKTtcbiAgICAgICAgY29uc3QgY2hpbGRHcmlkID0gdGhpcy5nZXRDaGlsZEdyaWQoY2hpbGRHcmlkSUQsIGdyaWQpO1xuICAgICAgICBpZiAoY2hpbGRHcmlkLmFsbG93RmlsdGVyaW5nICYmIGNoaWxkR3JpZC5maWx0ZXJNb2RlID09PSBGaWx0ZXJNb2RlLnF1aWNrRmlsdGVyKSB7XG4gICAgICAgICAgICBjaGlsZEdyaWQubmF2aWdhdGlvbi5tb3ZlRm9jdXNUb0ZpbHRlckNlbGwodHJ1ZSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5mb2N1c05leHRDaGlsZChjdXJyZW50Um93RWwubmV4dEVsZW1lbnRTaWJsaW5nLCAwLCBncmlkKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgbmF2aWdhdGVQcmV2RmlsdGVyQ2VsbChjb2x1bW46IElneENvbHVtbkNvbXBvbmVudCwgZXZlbnRBcmdzKSB7XG4gICAgICAgIGlmIChjb2x1bW4udmlzaWJsZUluZGV4ID09PSAwICYmIHRoaXMuZ3JpZC5wYXJlbnQpIHtcbiAgICAgICAgICAgIGV2ZW50QXJncy5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgbGV0IHRhcmdldEdyaWQgPSB0aGlzLmdyaWQucGFyZW50O1xuICAgICAgICAgICAgY29uc3QgcHJldlNpYmxpbmdDaGlsZCA9IHRoaXMuZ2V0Q2hpbGRHcmlkUm93Q29udGFpbmVyKCkucHJldmlvdXNFbGVtZW50U2libGluZztcbiAgICAgICAgICAgIGlmIChwcmV2U2libGluZ0NoaWxkKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZ3JpZEVsZW0gPSBwcmV2U2libGluZ0NoaWxkLnF1ZXJ5U2VsZWN0b3JBbGwoJ2lneC1oaWVyYXJjaGljYWwtZ3JpZCcpWzBdO1xuICAgICAgICAgICAgICAgIHRhcmdldEdyaWQgPSB0aGlzLmdldENoaWxkR3JpZChncmlkRWxlbS5nZXRBdHRyaWJ1dGUoJ2lkJyksIHRoaXMuZ3JpZC5wYXJlbnQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5mb2N1c1ByZXYodGFyZ2V0R3JpZC51bnBpbm5lZENvbHVtbnNbdGFyZ2V0R3JpZC51bnBpbm5lZENvbHVtbnMubGVuZ3RoIC0gMV0udmlzaWJsZUluZGV4KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN1cGVyLm5hdmlnYXRlUHJldkZpbHRlckNlbGwoY29sdW1uLCBldmVudEFyZ3MpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIG5hdmlnYXRlTmV4dEZpbHRlckNlbGwoY29sdW1uOiBJZ3hDb2x1bW5Db21wb25lbnQsIGV2ZW50QXJncykge1xuICAgICAgICBjb25zdCBjb2xzID0gdGhpcy5ncmlkLmZpbHRlcmluZ1NlcnZpY2UudW5waW5uZWRGaWx0ZXJhYmxlQ29sdW1ucztcbiAgICAgICAgY29uc3QgbmV4dEZpbHRlcmFibGVJbmRleCA9IGNvbHMuaW5kZXhPZihjb2x1bW4pICsgMTtcbiAgICAgICAgaWYgKG5leHRGaWx0ZXJhYmxlSW5kZXggPj0gdGhpcy5ncmlkLmZpbHRlcmluZ1NlcnZpY2UudW5waW5uZWRGaWx0ZXJhYmxlQ29sdW1ucy5sZW5ndGgpIHtcbiAgICAgICAgICAgIC8vIG5leHQgaXMgbm90IGZpbHRlciBjZWxsXG4gICAgICAgICAgICBjb25zdCBkYXRhUm93cyA9IHRoaXMuZ3JpZC5yb3dMaXN0LnRvQXJyYXkoKTtcbiAgICAgICAgICAgIGNvbnN0IGhhc1Jvd3MgPSBkYXRhUm93cy5sZW5ndGggIT09IDA7XG4gICAgICAgICAgICBjb25zdCBzdW1tYXJ5Um93cyA9IHRoaXMuZ3JpZC5zdW1tYXJpZXNSb3dMaXN0LnRvQXJyYXkoKTtcbiAgICAgICAgICAgIGNvbnN0IGhhc1N1bW1hcmllcyA9IHN1bW1hcnlSb3dzLmxlbmd0aCA+IDAgJiYgc3VtbWFyeVJvd3NbMF0uc3VtbWFyeUNlbGxzLmxlbmd0aCA+IDA7XG4gICAgICAgICAgICBpZiAoaGFzUm93cykge1xuICAgICAgICAgICAgICAgIHRoaXMuZm9jdXNOZXh0Um93KGRhdGFSb3dzWzBdLm5hdGl2ZUVsZW1lbnQsIDAsIHRoaXMuZ3JpZCwgZmFsc2UpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChoYXNTdW1tYXJpZXMpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZvY3VzTmV4dFJvdyhzdW1tYXJ5Um93c1swXS5uYXRpdmVFbGVtZW50LCAwLCB0aGlzLmdyaWQsIHRydWUpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZvY3VzTmV4dCgwKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGV2ZW50QXJncy5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3VwZXIubmF2aWdhdGVOZXh0RmlsdGVyQ2VsbChjb2x1bW4sIGV2ZW50QXJncyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgcGVyZm9ybVNoaWZ0VGFiS2V5KGN1cnJlbnRSb3dFbCwgc2VsZWN0ZWROb2RlOiBJU2VsZWN0aW9uTm9kZSkge1xuICAgICAgICBpZiAodGhpcy5ncmlkLnJvd0luRWRpdE1vZGUpIHtcbiAgICAgICAgICAgIHN1cGVyLnBlcmZvcm1TaGlmdFRhYktleShjdXJyZW50Um93RWwsIHNlbGVjdGVkTm9kZSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgcm93SW5kZXggPSBzZWxlY3RlZE5vZGUucm93O1xuICAgICAgICBjb25zdCB2aXNpYmxlQ29sdW1uSW5kZXggPSBzZWxlY3RlZE5vZGUuY29sdW1uO1xuICAgICAgICBjb25zdCBpc1N1bW1hcnkgPSBzZWxlY3RlZE5vZGUuaXNTdW1tYXJ5Um93O1xuICAgICAgICBpZiAodmlzaWJsZUNvbHVtbkluZGV4ID09PSAwICYmIHJvd0luZGV4ID09PSAwICYmIHRoaXMuZ3JpZC5wYXJlbnQgJiYgIWlzU3VtbWFyeSkge1xuICAgICAgICAgICAgaWYgKHRoaXMuZ3JpZC5hbGxvd0ZpbHRlcmluZyAmJiB0aGlzLmdyaWQuZmlsdGVyTW9kZSA9PT0gRmlsdGVyTW9kZS5xdWlja0ZpbHRlcikge1xuICAgICAgICAgICAgICAgIHRoaXMubW92ZUZvY3VzVG9GaWx0ZXJDZWxsKCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnN0IHByZXZTaWJsaW5nQ2hpbGQgPSB0aGlzLmdldENoaWxkR3JpZFJvd0NvbnRhaW5lcigpLnByZXZpb3VzRWxlbWVudFNpYmxpbmc7XG4gICAgICAgICAgICAgICAgaWYgKHByZXZTaWJsaW5nQ2hpbGQpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ3JpZEVsZW0gPSBwcmV2U2libGluZ0NoaWxkLnF1ZXJ5U2VsZWN0b3JBbGwoJ2lneC1oaWVyYXJjaGljYWwtZ3JpZCcpWzBdO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnBlcmZvcm1TaGlmdFRhYkludG9DaGlsZChncmlkRWxlbSwgY3VycmVudFJvd0VsLCByb3dJbmRleCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VsTm9kZSA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJvdzogcm93SW5kZXgsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW46IHRoaXMuZ3JpZC5wYXJlbnQudW5waW5uZWRDb2x1bW5zW3RoaXMuZ3JpZC5wYXJlbnQudW5waW5uZWRDb2x1bW5zLmxlbmd0aCAtIDFdLnZpc2libGVJbmRleFxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm5hdmlnYXRlVXAoY3VycmVudFJvd0VsLCBzZWxOb2RlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAodmlzaWJsZUNvbHVtbkluZGV4ID09PSAwICYmIGN1cnJlbnRSb3dFbC5wcmV2aW91c0VsZW1lbnRTaWJsaW5nICYmXG4gICAgICAgICAgICBjdXJyZW50Um93RWwucHJldmlvdXNFbGVtZW50U2libGluZy5jaGlsZHJlblswXS50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdpZ3gtY2hpbGQtZ3JpZC1yb3cnKSB7XG4gICAgICAgICAgICBjb25zdCBncmlkRWxlbSA9IHRoaXMuZ2V0TGFzdEdyaWRFbGVtKGN1cnJlbnRSb3dFbC5wcmV2aW91c0VsZW1lbnRTaWJsaW5nKTtcbiAgICAgICAgICAgIHRoaXMucGVyZm9ybVNoaWZ0VGFiSW50b0NoaWxkKGdyaWRFbGVtLCBjdXJyZW50Um93RWwsIHJvd0luZGV4KTtcbiAgICAgICAgfSBlbHNlIGlmICh2aXNpYmxlQ29sdW1uSW5kZXggPT09IDAgJiYgaXNTdW1tYXJ5KSB7XG4gICAgICAgICAgICBjb25zdCBsYXN0Um93SW5kZXggPSB0aGlzLmdyaWQuZGF0YVZpZXcubGVuZ3RoIC0gMTtcbiAgICAgICAgICAgIGlmIChsYXN0Um93SW5kZXggPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgLy8gbm8gY2hpbGQgZGF0YVxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmdyaWQuYWxsb3dGaWx0ZXJpbmcgJiYgdGhpcy5ncmlkLmZpbHRlck1vZGUgPT09IEZpbHRlck1vZGUucXVpY2tGaWx0ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tb3ZlRm9jdXNUb0ZpbHRlckNlbGwoKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBzZWxOb2RlID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcm93OiByb3dJbmRleCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbjogdGhpcy5ncmlkLnBhcmVudC51bnBpbm5lZENvbHVtbnNbdGhpcy5ncmlkLnBhcmVudC51bnBpbm5lZENvbHVtbnMubGVuZ3RoIC0gMV0udmlzaWJsZUluZGV4XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubmF2aWdhdGVVcChjdXJyZW50Um93RWwsIHNlbE5vZGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIXRoaXMuZ2V0SXNDaGlsZEF0SW5kZXgobGFzdFJvd0luZGV4KSkge1xuICAgICAgICAgICAgICAgIHN1cGVyLmdvVG9MYXN0Q2VsbCgpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBzY3JUb3BQb3NpdGlvbiA9IHRoaXMuZ3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5nZXRTY3JvbGxGb3JJbmRleChsYXN0Um93SW5kZXgsIHRydWUpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHZlcnRpY2FsU2Nyb2xsVG9wID0gdGhpcy5ncmlkLnZlcnRpY2FsU2Nyb2xsQ29udGFpbmVyLnNjcm9sbFBvc2l0aW9uO1xuICAgICAgICAgICAgICAgIGlmICh2ZXJ0aWNhbFNjcm9sbFRvcCA9PT0gc2NyVG9wUG9zaXRpb24gfHwgaXNOYU4oc2NyVG9wUG9zaXRpb24pKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNsb3Nlc3RDaGlsZCA9IHRoaXMuZ2V0TGFzdEdyaWRFbGVtKHRoaXMuZ3JpZC5nZXRSb3dCeUluZGV4KGxhc3RSb3dJbmRleCkubmF0aXZlRWxlbWVudC5wYXJlbnRFbGVtZW50KTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wZXJmb3JtU2hpZnRUYWJJbnRvQ2hpbGQoY2xvc2VzdENoaWxkLCBjdXJyZW50Um93RWwsIHJvd0luZGV4KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbEdyaWQodGhpcy5ncmlkLCBzY3JUb3BQb3NpdGlvbiAtIHZlcnRpY2FsU2Nyb2xsVG9wLFxuICAgICAgICAgICAgICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNsb3Nlc3RDaGlsZCA9IHRoaXMuZ2V0TGFzdEdyaWRFbGVtKHRoaXMuZ3JpZC5nZXRSb3dCeUluZGV4KGxhc3RSb3dJbmRleCkubmF0aXZlRWxlbWVudC5wYXJlbnRFbGVtZW50KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBlcmZvcm1TaGlmdFRhYkludG9DaGlsZChjbG9zZXN0Q2hpbGQsIGN1cnJlbnRSb3dFbCwgcm93SW5kZXgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3VwZXIucGVyZm9ybVNoaWZ0VGFiS2V5KGN1cnJlbnRSb3dFbCwgc2VsZWN0ZWROb2RlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBnZXRGb2N1c2FibGVHcmlkKCkge1xuICAgICAgICByZXR1cm4gKGlzSUUoKSAmJiB0aGlzLmdyaWQucm9vdEdyaWQpID8gdGhpcy5ncmlkLnJvb3RHcmlkIDogdGhpcy5ncmlkO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0TGFzdEdyaWRFbGVtKHRyQ29udGFpbmVyKSB7XG4gICAgICAgIGNvbnN0IGNoaWxkcmVuID0gdHJDb250YWluZXIuY2hpbGRyZW47XG4gICAgICAgIGNvbnN0IGNsb3Nlc3RDaGlsZCA9IGNoaWxkcmVuW2NoaWxkcmVuLmxlbmd0aCAtIDFdLmNoaWxkcmVuWzBdLmNoaWxkcmVuWzBdO1xuICAgICAgICByZXR1cm4gY2xvc2VzdENoaWxkO1xuICAgIH1cblxuICAgIHByaXZhdGUgcGVyZm9ybVNoaWZ0VGFiSW50b0NoaWxkKGdyaWRFbGVtLCBjdXJyZW50Um93RWwsIHJvd0luZGV4KSB7XG4gICAgICAgIGNvbnN0IGNoaWxkR3JpZElEID0gZ3JpZEVsZW0uZ2V0QXR0cmlidXRlKCdpZCcpO1xuICAgICAgICAgICAgY29uc3QgY2hpbGRHcmlkID0gdGhpcy5nZXRDaGlsZEdyaWQoY2hpbGRHcmlkSUQsIHRoaXMuZ3JpZCkgfHwgdGhpcy5nZXRDaGlsZEdyaWQoY2hpbGRHcmlkSUQsIHRoaXMuZ3JpZC5wYXJlbnQpO1xuICAgICAgICAgICAgY29uc3QgbGFzdEluZGV4ID0gY2hpbGRHcmlkLnVucGlubmVkQ29sdW1uc1tjaGlsZEdyaWQudW5waW5uZWRDb2x1bW5zLmxlbmd0aCAtIDFdLnZpc2libGVJbmRleDtcbiAgICAgICAgICAgIGNvbnN0IHN1bW1hcnlSb3dzID0gY2hpbGRHcmlkLnN1bW1hcmllc1Jvd0xpc3QudG9BcnJheSgpO1xuICAgICAgICAgICAgaWYgKHN1bW1hcnlSb3dzLmxlbmd0aCA+IDAgJiYgc3VtbWFyeVJvd3NbMF0uc3VtbWFyeUNlbGxzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAvLyBtb3ZlIGZvY3VzIHRvIGxhc3Qgc3VtbWFyeSByb3cgY2VsbFxuICAgICAgICAgICAgICAgIGNvbnN0IHN1bW1hcnlSb3cgPSBzdW1tYXJ5Um93c1swXS5uYXRpdmVFbGVtZW50O1xuICAgICAgICAgICAgICAgIHRoaXMuZm9jdXNQcmV2Um93KHN1bW1hcnlSb3csIGxhc3RJbmRleCwgY2hpbGRHcmlkLCB0cnVlLCB0cnVlKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2hpbGRHcmlkLnJvd0xpc3QubGVuZ3RoID09PSAwICYmXG4gICAgICAgICAgICAgY2hpbGRHcmlkLmFsbG93RmlsdGVyaW5nICYmIGNoaWxkR3JpZC5maWx0ZXJNb2RlID09PSBGaWx0ZXJNb2RlLnF1aWNrRmlsdGVyKSB7XG4gICAgICAgICAgICAgICAgIC8vIG1vdmUgdG8gZmlsdGVyIGNlbGxcbiAgICAgICAgICAgICAgICBjaGlsZEdyaWQubmF2aWdhdGlvbi5tb3ZlRm9jdXNUb0ZpbHRlckNlbGwoKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2hpbGRHcmlkLnJvd0xpc3QubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgLy8gbW92ZSB0byBwcmV2IGNoaWxkIG9yIHBhcmVudCByb3dcbiAgICAgICAgICAgICAgICBjb25zdCBwcmV2Q2hpbGQgPSB0aGlzLmdldFNpYmxpbmcoY2hpbGRHcmlkKTtcbiAgICAgICAgICAgICAgICBpZiAocHJldkNoaWxkKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGVyZm9ybVNoaWZ0VGFiSW50b0NoaWxkKHByZXZDaGlsZCwgY3VycmVudFJvd0VsLCByb3dJbmRleCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VsTm9kZSA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJvdzogIHJvd0luZGV4LFxuICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uOiB0aGlzLmdyaWQudW5waW5uZWRDb2x1bW5zW3RoaXMuZ3JpZC51bnBpbm5lZENvbHVtbnMubGVuZ3RoIC0gMV0udmlzaWJsZUluZGV4XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubmF2aWdhdGVVcChjdXJyZW50Um93RWwsIHNlbE5vZGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gbW92ZSB0byBwcmV2IGNlbGxcbiAgICAgICAgICAgICAgICBjaGlsZEdyaWQubmF2aWdhdGlvbi5nb1RvTGFzdENlbGwoKTtcbiAgICAgICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFNpYmxpbmcoY2hpbGRHcmlkKSB7XG4gICAgICAgIGNvbnN0IHByZXZDaGlsZFJvdyA9IGNoaWxkR3JpZC5jaGlsZFJvdy5uYXRpdmVFbGVtZW50LnByZXZpb3VzRWxlbWVudFNpYmxpbmc7XG4gICAgICAgIGlmIChwcmV2Q2hpbGRSb3cpIHtcbiAgICAgICAgICAgIHJldHVybiBwcmV2Q2hpbGRSb3cuY2hpbGRyZW5bMF0uY2hpbGRyZW5bMF07XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBmb2N1c05leHRDaGlsZChlbGVtLCB2aXNpYmxlQ29sdW1uSW5kZXgsIGdyaWQpIHtcbiAgICAgICAgY29uc3QgZ3JpZEVsZW0gPSBlbGVtLnF1ZXJ5U2VsZWN0b3IoJ2lneC1oaWVyYXJjaGljYWwtZ3JpZCcpO1xuICAgICAgICBjb25zdCBjaGlsZEdyaWRJRCA9IGdyaWRFbGVtLmdldEF0dHJpYnV0ZSgnaWQnKTtcbiAgICAgICAgY29uc3QgY2hpbGRHcmlkID0gdGhpcy5nZXRDaGlsZEdyaWQoY2hpbGRHcmlkSUQsIGdyaWQpO1xuXG4gICAgICAgIGlmIChjaGlsZEdyaWQucm93TGlzdC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHRoaXMuZm9jdXNOZXh0KHZpc2libGVDb2x1bW5JbmRleCwgY2hpbGRHcmlkKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFVwZGF0ZSBjb2x1bW4gaW5kZXggc2luY2UgdGhlIG5leHQgY2hpbGQgY2FuIGhhdmUgaW4gZ2VuZXJhbCBsZXNzIGNvbHVtbnMgdGhhbiB2aXNpYmxlQ29sdW1uSW5kZXggdmFsdWUuXG4gICAgICAgIGNvbnN0IGxhc3RDZWxsSW5kZXggPSBjaGlsZEdyaWQudW5waW5uZWRDb2x1bW5zW2NoaWxkR3JpZC51bnBpbm5lZENvbHVtbnMubGVuZ3RoIC0gMV0udmlzaWJsZUluZGV4O1xuICAgICAgICB2aXNpYmxlQ29sdW1uSW5kZXggPSBNYXRoLm1pbihsYXN0Q2VsbEluZGV4LCB2aXNpYmxlQ29sdW1uSW5kZXgpO1xuXG4gICAgICAgIGlmIChjaGlsZEdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXIuc3RhdGUuc3RhcnRJbmRleCAhPT0gMCkge1xuICAgICAgICAgICAgLy8gc2Nyb2xsIHRvIHRvcFxuICAgICAgICAgICAgdGhpcy5zY3JvbGxHcmlkKGNoaWxkR3JpZCwgJ3RvcCcsICgpID0+IHRoaXMuZm9jdXNOZXh0Um93KGVsZW0sIHZpc2libGVDb2x1bW5JbmRleCwgY2hpbGRHcmlkKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmZvY3VzTmV4dFJvdyhlbGVtLCB2aXNpYmxlQ29sdW1uSW5kZXgsIGNoaWxkR3JpZCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHJpdmF0ZSBmb2N1c1ByZXZDaGlsZChlbGVtLCB2aXNpYmxlQ29sdW1uSW5kZXgsIGdyaWQpIHtcbiAgICAgICAgY29uc3QgZ3JpZHMgPSBbXTtcbiAgICAgICAgY29uc3QgZ3JpZEVsZW1zID0gQXJyYXkuZnJvbShlbGVtLnF1ZXJ5U2VsZWN0b3JBbGwoJ2lneC1oaWVyYXJjaGljYWwtZ3JpZCcpKTtcbiAgICAgICAgY29uc3QgY2hpbGRMZXZlbCA9IGdyaWQuY2hpbGRMYXlvdXRMaXN0LmZpcnN0LmxldmVsO1xuICAgICAgICBncmlkRWxlbXMuZm9yRWFjaCgoaGcpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHBhcmVudFJvdyA9IHRoaXMuZ2V0Q2xvc2VzdEVsZW1CeVRhZyhoZywgJ2lneC1jaGlsZC1ncmlkLXJvdycpO1xuICAgICAgICAgICAgaWYgKHBhcmVudFJvdyAmJiBwYXJzZUludChwYXJlbnRSb3cuZ2V0QXR0cmlidXRlKCdkYXRhLWxldmVsJyksIDEwKSA9PT0gY2hpbGRMZXZlbCkge1xuICAgICAgICAgICAgICAgIGdyaWRzLnB1c2goaGcpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgZ3JpZEVsZW0gPSBncmlkc1tncmlkcy5sZW5ndGggLSAxXTtcbiAgICAgICAgY29uc3QgY2hpbGRHcmlkSUQgPSBncmlkRWxlbS5nZXRBdHRyaWJ1dGUoJ2lkJyk7XG4gICAgICAgIGNvbnN0IGNoaWxkR3JpZCA9IHRoaXMuZ2V0Q2hpbGRHcmlkKGNoaWxkR3JpZElELCBncmlkKTtcblxuICAgICAgICBpZiAoY2hpbGRHcmlkLnJvd0xpc3QubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICB0aGlzLmZvY3VzUHJldih2aXNpYmxlQ29sdW1uSW5kZXgsIGNoaWxkR3JpZCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICAvLyBVcGRhdGUgY29sdW1uIGluZGV4IHNpbmNlIHRoZSBwcmV2aW91cyBjaGlsZCBjYW4gaGF2ZSBpbiBnZW5lcmFsIGxlc3MgY29sdW1ucyB0aGFuIHZpc2libGVDb2x1bW5JbmRleCB2YWx1ZS5cbiAgICAgICAgY29uc3QgbGFzdENlbGxJbmRleCA9IGNoaWxkR3JpZC51bnBpbm5lZENvbHVtbnNbY2hpbGRHcmlkLnVucGlubmVkQ29sdW1ucy5sZW5ndGggLSAxXS52aXNpYmxlSW5kZXg7XG4gICAgICAgIHZpc2libGVDb2x1bW5JbmRleCA9IE1hdGgubWluKGxhc3RDZWxsSW5kZXgsIHZpc2libGVDb2x1bW5JbmRleCk7XG5cbiAgICAgICAgY29uc3QgaXNTY3JvbGxlZFRvQm90dG9tID0gdGhpcy5faXNTY3JvbGxlZFRvQm90dG9tKGNoaWxkR3JpZCk7XG4gICAgICAgIGNvbnN0IGxhc3RJbmRleCA9IGNoaWxkR3JpZC5kYXRhVmlldy5sZW5ndGggLSAxO1xuICAgICAgICBpZiAoIWlzU2Nyb2xsZWRUb0JvdHRvbSkge1xuICAgICAgICAgICAgLy8gc2Nyb2xsIHRvIGVuZFxuICAgICAgICAgICAgdGhpcy5zY3JvbGxHcmlkKGNoaWxkR3JpZCwgJ2JvdHRvbScsICgpID0+IHRoaXMuZm9jdXNQcmV2Q2hpbGQoZWxlbSwgdmlzaWJsZUNvbHVtbkluZGV4LCBncmlkKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBsYXN0Um93SW5DaGlsZCA9IGNoaWxkR3JpZC5nZXRSb3dCeUluZGV4KGxhc3RJbmRleCk7XG4gICAgICAgICAgICBjb25zdCBpc0NoaWxkR3JpZCA9IGxhc3RSb3dJbkNoaWxkLm5hdGl2ZUVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ2lneC1jaGlsZC1ncmlkLXJvdyc7XG4gICAgICAgICAgICBpZiAoaXNDaGlsZEdyaWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZvY3VzUHJldkNoaWxkKGxhc3RSb3dJbkNoaWxkLm5hdGl2ZUVsZW1lbnQucGFyZW50Tm9kZSwgdmlzaWJsZUNvbHVtbkluZGV4LCBjaGlsZEdyaWQpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZvY3VzUHJldlJvdyhsYXN0Um93SW5DaGlsZC5uYXRpdmVFbGVtZW50LCB2aXNpYmxlQ29sdW1uSW5kZXgsIGNoaWxkR3JpZCwgdHJ1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHJpdmF0ZSBmb2N1c1ByZXYodmlzaWJsZUNvbHVtbkluZGV4LCBncmlkPykge1xuICAgICAgICBjb25zdCBjdXJyR3JpZCA9IGdyaWQgfHwgdGhpcy5ncmlkO1xuICAgICAgICBsZXQgcGFyZW50Q29udGFpbmVyID0gdGhpcy5nZXRDaGlsZENvbnRhaW5lcihjdXJyR3JpZCk7XG4gICAgICAgIGxldCBjaGlsZFJvd0NvbnRhaW5lciA9IHRoaXMuZ2V0Q2hpbGRHcmlkUm93Q29udGFpbmVyKGN1cnJHcmlkKTtcbiAgICAgICAgY29uc3QgcHJldklzU2libGluZ0NoaWxkID0gISFjaGlsZFJvd0NvbnRhaW5lci5wcmV2aW91c0VsZW1lbnRTaWJsaW5nO1xuICAgICAgICBsZXQgcHJldiA9IGNoaWxkUm93Q29udGFpbmVyLnByZXZpb3VzRWxlbWVudFNpYmxpbmcgfHwgcGFyZW50Q29udGFpbmVyLnByZXZpb3VzRWxlbWVudFNpYmxpbmc7XG4gICAgICAgIGlmIChwcmV2KSB7XG4gICAgICAgICAgICBpZiAocHJldklzU2libGluZ0NoaWxkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5mb2N1c1ByZXZDaGlsZChwcmV2LCB2aXNpYmxlQ29sdW1uSW5kZXgsIGN1cnJHcmlkLnBhcmVudCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuZm9jdXNQcmV2Um93KHByZXYsIHZpc2libGVDb2x1bW5JbmRleCwgY3VyckdyaWQucGFyZW50KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuc2Nyb2xsR3JpZChjdXJyR3JpZC5wYXJlbnQsICdwcmV2JyxcbiAgICAgICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHBhcmVudENvbnRhaW5lciA9IHRoaXMuZ2V0Q2hpbGRDb250YWluZXIoZ3JpZCk7XG4gICAgICAgICAgICAgICAgICAgIGNoaWxkUm93Q29udGFpbmVyID0gdGhpcy5nZXRDaGlsZEdyaWRSb3dDb250YWluZXIoZ3JpZCk7XG4gICAgICAgICAgICAgICAgICAgIHByZXYgPSBjaGlsZFJvd0NvbnRhaW5lci5wcmV2aW91c0VsZW1lbnRTaWJsaW5nIHx8IHBhcmVudENvbnRhaW5lci5wcmV2aW91c0VsZW1lbnRTaWJsaW5nO1xuICAgICAgICAgICAgICAgICAgICBpZiAocHJldklzU2libGluZ0NoaWxkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZvY3VzUHJldkNoaWxkKHByZXYsIHZpc2libGVDb2x1bW5JbmRleCwgY3VyckdyaWQucGFyZW50KTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZm9jdXNQcmV2Um93KHByZXYsIHZpc2libGVDb2x1bW5JbmRleCwgY3VyckdyaWQucGFyZW50KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXROZXh0UGFyZW50SW5mbyhncmlkKSB7XG4gICAgICAgIC8vIGZpbmQgbmV4dCBwYXJlbnQgdGhhdCBpcyBub3QgYXQgYm90dG9tXG4gICAgICAgIGxldCBjdXJyR3JpZCA9IGdyaWQucGFyZW50O1xuICAgICAgICBsZXQgbmV4dEVsZW0gPSB0aGlzLmdldENoaWxkQ29udGFpbmVyKGdyaWQpLm5leHRFbGVtZW50U2libGluZztcbiAgICAgICAgd2hpbGUgKCFuZXh0RWxlbSAmJiBjdXJyR3JpZC5wYXJlbnQgIT09IG51bGwpIHtcbiAgICAgICAgICAgIG5leHRFbGVtID0gdGhpcy5nZXRDaGlsZENvbnRhaW5lcihjdXJyR3JpZCkubmV4dEVsZW1lbnRTaWJsaW5nO1xuICAgICAgICAgICAgY3VyckdyaWQgPSBjdXJyR3JpZC5wYXJlbnQ7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4geyBncmlkOiBjdXJyR3JpZCwgbmV4dEVsZW1lbnQ6IG5leHRFbGVtIH07XG4gICAgfVxuICAgIHByaXZhdGUgZ2V0TmV4dFNjcm9sbGFibGUoZ3JpZCkge1xuICAgICAgICBsZXQgY3VyckdyaWQgPSBncmlkLnBhcmVudDtcbiAgICAgICAgaWYgKCFjdXJyR3JpZCkge1xuICAgICAgICAgICAgcmV0dXJuIHsgZ3JpZDogZ3JpZCwgcHJldjogbnVsbCB9O1xuICAgICAgICB9XG4gICAgICAgIGxldCBub25TY3JvbGxhYmxlID0gY3VyckdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXIuc2Nyb2xsUG9zaXRpb24gPT09IDA7XG4gICAgICAgIGxldCBwcmV2ID0gZ3JpZDtcbiAgICAgICAgd2hpbGUgKG5vblNjcm9sbGFibGUgJiYgY3VyckdyaWQucGFyZW50ICE9PSBudWxsKSB7XG4gICAgICAgICAgICBwcmV2ID0gY3VyckdyaWQ7XG4gICAgICAgICAgICBjdXJyR3JpZCA9IGN1cnJHcmlkLnBhcmVudDtcbiAgICAgICAgICAgIG5vblNjcm9sbGFibGUgPSBjdXJyR3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5zY3JvbGxQb3NpdGlvbiA9PT0gMDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4geyBncmlkOiBjdXJyR3JpZCwgcHJldjogcHJldiB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgZm9jdXNOZXh0KHZpc2libGVDb2x1bW5JbmRleCwgZ3JpZD8pIHtcbiAgICAgICAgY29uc3QgY3VyckdyaWQgPSBncmlkIHx8IHRoaXMuZ3JpZDtcbiAgICAgICAgY29uc3QgcGFyZW50SW5mbyA9IHRoaXMuZ2V0TmV4dFBhcmVudEluZm8oY3VyckdyaWQpO1xuICAgICAgICBjb25zdCBuZXh0UGFyZW50R3JpZCA9IHBhcmVudEluZm8uZ3JpZDtcbiAgICAgICAgbGV0IG5leHRQYXJlbnRFbGVtID0gcGFyZW50SW5mby5uZXh0RWxlbWVudDtcbiAgICAgICAgbGV0IGNoaWxkUm93Q29udGFpbmVyID0gdGhpcy5nZXRDaGlsZEdyaWRSb3dDb250YWluZXIoY3VyckdyaWQpO1xuICAgICAgICBjb25zdCBuZXh0SXNTaWJsaW5nQ2hpbGQgPSAhIWNoaWxkUm93Q29udGFpbmVyLm5leHRFbGVtZW50U2libGluZztcbiAgICAgICAgbGV0IG5leHQgPSBjaGlsZFJvd0NvbnRhaW5lci5uZXh0RWxlbWVudFNpYmxpbmcgfHwgbmV4dFBhcmVudEVsZW07XG4gICAgICAgIGNvbnN0IHZlcnRpY2FsU2Nyb2xsID0gbmV4dFBhcmVudEdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXIuZ2V0U2Nyb2xsKCk7XG4gICAgICAgIGNvbnN0IHBhcmVudFN0YXRlID0gbmV4dFBhcmVudEdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXIuc3RhdGU7XG4gICAgICAgIGNvbnN0IGF0TGFzdENodW5rID0gcGFyZW50U3RhdGUuc3RhcnRJbmRleCArIHBhcmVudFN0YXRlLmNodW5rU2l6ZSA9PT1cbiAgICAgICAgIG5leHRQYXJlbnRHcmlkLmRhdGFWaWV3Lmxlbmd0aDtcbiAgICAgICAgaWYgKG5leHQpIHtcbiAgICAgICAgICAgIGlmIChuZXh0SXNTaWJsaW5nQ2hpbGQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZvY3VzTmV4dENoaWxkKG5leHQsIHZpc2libGVDb2x1bW5JbmRleCwgbmV4dFBhcmVudEdyaWQpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZvY3VzTmV4dFJvdyhuZXh0LCB2aXNpYmxlQ29sdW1uSW5kZXgsIGdyaWQgfHwgbmV4dFBhcmVudEdyaWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKHZlcnRpY2FsU2Nyb2xsLnNjcm9sbFRvcCAhPT1cbiAgICAgICAgICAgIHZlcnRpY2FsU2Nyb2xsLnNjcm9sbEhlaWdodCAtIG5leHRQYXJlbnRHcmlkLnZlcnRpY2FsU2Nyb2xsQ29udGFpbmVyLmlneEZvckNvbnRhaW5lclNpemUgJiYgIWF0TGFzdENodW5rKSB7XG4gICAgICAgICAgICB0aGlzLnNjcm9sbEdyaWQobmV4dFBhcmVudEdyaWQsICduZXh0JyxcbiAgICAgICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIG5leHRQYXJlbnRFbGVtID0gcGFyZW50SW5mby5uZXh0RWxlbWVudDtcbiAgICAgICAgICAgICAgICAgICAgY2hpbGRSb3dDb250YWluZXIgPSB0aGlzLmdldENoaWxkR3JpZFJvd0NvbnRhaW5lcigpO1xuICAgICAgICAgICAgICAgICAgICBuZXh0ID0gY2hpbGRSb3dDb250YWluZXIubmV4dEVsZW1lbnRTaWJsaW5nIHx8IG5leHRQYXJlbnRFbGVtO1xuICAgICAgICAgICAgICAgICAgICBpZiAobmV4dCAmJiBuZXh0SXNTaWJsaW5nQ2hpbGQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZm9jdXNOZXh0Q2hpbGQobmV4dCwgdmlzaWJsZUNvbHVtbkluZGV4LCBuZXh0UGFyZW50R3JpZCk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobmV4dCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5mb2N1c05leHRSb3cobmV4dCwgdmlzaWJsZUNvbHVtbkluZGV4LCBncmlkIHx8IG5leHRQYXJlbnRHcmlkKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIHByaXZhdGUgZ2V0TmV4dFNjcm9sbGFibGVEb3duKGdyaWQpIHtcbiAgICAgICAgbGV0IGN1cnJHcmlkID0gZ3JpZC5wYXJlbnQ7XG4gICAgICAgIGlmICghY3VyckdyaWQpIHtcbiAgICAgICAgICAgIHJldHVybiB7IGdyaWQ6IGdyaWQsIHByZXY6IG51bGwgfTtcbiAgICAgICAgfVxuICAgICAgICBsZXQgc2Nyb2xsVG9wID0gY3VyckdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXIuc2Nyb2xsUG9zaXRpb247XG4gICAgICAgIGxldCBzY3JvbGxIZWlnaHQgPSBjdXJyR3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5nZXRTY3JvbGwoKS5zY3JvbGxIZWlnaHQ7XG4gICAgICAgIGxldCBub25TY3JvbGxhYmxlID0gc2Nyb2xsSGVpZ2h0ID09PSAwIHx8XG4gICAgICAgICAgICBNYXRoLnJvdW5kKHNjcm9sbFRvcCArIGN1cnJHcmlkLnZlcnRpY2FsU2Nyb2xsQ29udGFpbmVyLmlneEZvckNvbnRhaW5lclNpemUpID09PSBzY3JvbGxIZWlnaHQ7XG4gICAgICAgIGxldCBwcmV2ID0gZ3JpZDtcbiAgICAgICAgd2hpbGUgKG5vblNjcm9sbGFibGUgJiYgY3VyckdyaWQucGFyZW50ICE9PSBudWxsKSB7XG4gICAgICAgICAgICBwcmV2ID0gY3VyckdyaWQ7XG4gICAgICAgICAgICBjdXJyR3JpZCA9IGN1cnJHcmlkLnBhcmVudDtcbiAgICAgICAgICAgIHNjcm9sbFRvcCA9IGN1cnJHcmlkLnZlcnRpY2FsU2Nyb2xsQ29udGFpbmVyLnNjcm9sbFBvc2l0aW9uO1xuICAgICAgICAgICAgc2Nyb2xsSGVpZ2h0ID0gY3VyckdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXIuZ2V0U2Nyb2xsKCkuc2Nyb2xsSGVpZ2h0O1xuICAgICAgICAgICAgbm9uU2Nyb2xsYWJsZSA9IHNjcm9sbEhlaWdodCA9PT0gMCB8fFxuICAgICAgICAgICAgICAgIE1hdGgucm91bmQoc2Nyb2xsVG9wICsgY3VyckdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXIuaWd4Rm9yQ29udGFpbmVyU2l6ZSkgPT09IHNjcm9sbEhlaWdodDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4geyBncmlkOiBjdXJyR3JpZCwgcHJldjogcHJldiB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgX2dldE1pbkJvdHRvbShncmlkKSB7XG4gICAgICAgIGxldCBjdXJyR3JpZCA9IGdyaWQ7XG4gICAgICAgIGxldCBib3R0b20gPSBjdXJyR3JpZC50Ym9keS5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmJvdHRvbTtcbiAgICAgICAgd2hpbGUgKGN1cnJHcmlkLnBhcmVudCkge1xuICAgICAgICAgICAgY3VyckdyaWQgPSBjdXJyR3JpZC5wYXJlbnQ7XG4gICAgICAgICAgICBib3R0b20gPSBNYXRoLm1pbihib3R0b20sIGN1cnJHcmlkLnRib2R5Lm5hdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkuYm90dG9tKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYm90dG9tO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2dldE1heFRvcChncmlkKSB7XG4gICAgICAgIGxldCBjdXJyR3JpZCA9IGdyaWQ7XG4gICAgICAgIGxldCB0b3AgPSBjdXJyR3JpZC50Ym9keS5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnRvcDtcbiAgICAgICAgd2hpbGUgKGN1cnJHcmlkLnBhcmVudCkge1xuICAgICAgICAgICAgY3VyckdyaWQgPSBjdXJyR3JpZC5wYXJlbnQ7XG4gICAgICAgICAgICB0b3AgPSBNYXRoLm1heCh0b3AsIGN1cnJHcmlkLnRib2R5Lm5hdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkudG9wKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdG9wO1xuICAgIH1cblxuICAgIHByaXZhdGUgZm9jdXNOZXh0Um93KGVsZW0sIHZpc2libGVDb2x1bW5JbmRleCwgZ3JpZCwgaXNTdW1tYXJ5Pykge1xuICAgICAgICBjb25zdCBsYXN0Q2VsbEluZGV4ID0gZ3JpZC51bnBpbm5lZENvbHVtbnNbZ3JpZC51bnBpbm5lZENvbHVtbnMubGVuZ3RoIC0gMV0udmlzaWJsZUluZGV4O1xuICAgICAgICB2aXNpYmxlQ29sdW1uSW5kZXggPSBNYXRoLm1pbihsYXN0Q2VsbEluZGV4LCB2aXNpYmxlQ29sdW1uSW5kZXgpO1xuICAgICAgICBjb25zdCBjZWxsU2VsZWN0b3IgPSB0aGlzLmdldENlbGxTZWxlY3Rvcih2aXNpYmxlQ29sdW1uSW5kZXgsIGlzU3VtbWFyeSk7XG4gICAgICAgIGlmIChncmlkLm5hdmlnYXRpb24uaXNDb2x1bW5GdWxseVZpc2libGUodmlzaWJsZUNvbHVtbkluZGV4KSB8fCBncmlkLnJvd0xpc3QubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICBjb25zdCBjZWxsID1cbiAgICAgICAgICAgICAgICBlbGVtLnF1ZXJ5U2VsZWN0b3IoYCR7Y2VsbFNlbGVjdG9yfVtkYXRhLXZpc2libGVJbmRleD1cIiR7dmlzaWJsZUNvbHVtbkluZGV4fVwiXWApO1xuICAgICAgICAgICAgY29uc3QgY2xvc2VzdFNjcm9sbGFibGVHcmlkID0gdGhpcy5nZXROZXh0U2Nyb2xsYWJsZURvd24oZ3JpZCkuZ3JpZDtcbiAgICAgICAgICAgIC8vIGNvbnN0IGRpZmYgPSBjZWxsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmJvdHRvbSAtIGdyaWQucm9vdEdyaWQudGJvZHkubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5ib3R0b207XG4gICAgICAgICAgICBjb25zdCBncmlkQm90dG9tID0gdGhpcy5fZ2V0TWluQm90dG9tKGdyaWQpO1xuICAgICAgICAgICAgY29uc3QgZGlmZiA9IGNlbGwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkuYm90dG9tIC0gZ3JpZEJvdHRvbTtcbiAgICAgICAgICAgIGNvbnN0IGluVmlldyA9IGRpZmYgPD0gMDtcbiAgICAgICAgICAgIGNvbnN0IHNjcm9sbFRvcCA9IGNsb3Nlc3RTY3JvbGxhYmxlR3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5zY3JvbGxQb3NpdGlvbjtcbiAgICAgICAgICAgIGNvbnN0IHNjcm9sbEhlaWdodCA9IGNsb3Nlc3RTY3JvbGxhYmxlR3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5nZXRTY3JvbGwoKS5zY3JvbGxIZWlnaHQ7XG4gICAgICAgICAgICBjb25zdCBjYW5TY3JvbGwgPSAhKHNjcm9sbEhlaWdodCA9PT0gMCB8fFxuICAgICAgICAgICAgICAgIE1hdGgucm91bmQoc2Nyb2xsVG9wICsgY2xvc2VzdFNjcm9sbGFibGVHcmlkLnZlcnRpY2FsU2Nyb2xsQ29udGFpbmVyLmlneEZvckNvbnRhaW5lclNpemUpID09PSBzY3JvbGxIZWlnaHQpO1xuICAgICAgICAgICAgaWYgKCFpblZpZXcgJiYgY2FuU2Nyb2xsKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zY3JvbGxHcmlkKGNsb3Nlc3RTY3JvbGxhYmxlR3JpZCwgZGlmZiwgKCkgPT4gY2VsbC5mb2N1cyh7IHByZXZlbnRTY3JvbGw6IHRydWUgfSkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjZWxsLmZvY3VzKHsgcHJldmVudFNjcm9sbDogdHJ1ZSB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuaG9yaXpvbnRhbFNjcm9sbEdyaWRUb0luZGV4KGdyaWQsIHZpc2libGVDb2x1bW5JbmRleCwgKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuZm9jdXNOZXh0Um93KGVsZW0sIHZpc2libGVDb2x1bW5JbmRleCwgZ3JpZCwgaXNTdW1tYXJ5KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIHB1YmxpYyBnZXRDb2x1bW5VbnBpbm5lZEluZGV4KHZpc2libGVDb2x1bW5JbmRleDogbnVtYmVyLCBncmlkPzogSWd4SGllcmFyY2hpY2FsR3JpZENvbXBvbmVudCkge1xuICAgICAgICBjb25zdCBjdXJyR3JpZCA9IGdyaWQgfHwgdGhpcy5ncmlkO1xuICAgICAgICBjb25zdCBjb2x1bW4gPSBjdXJyR3JpZC51bnBpbm5lZENvbHVtbnMuZmluZCgoY29sKSA9PiAhY29sLmNvbHVtbkdyb3VwICYmIGNvbC52aXNpYmxlSW5kZXggPT09IHZpc2libGVDb2x1bW5JbmRleCk7XG4gICAgICAgIHJldHVybiBjdXJyR3JpZC5waW5uZWRDb2x1bW5zLmxlbmd0aCA/IGN1cnJHcmlkLnVucGlubmVkQ29sdW1ucy5maWx0ZXIoKGMpID0+ICFjLmNvbHVtbkdyb3VwKS5pbmRleE9mKGNvbHVtbikgOlxuICAgICAgICAgICAgdmlzaWJsZUNvbHVtbkluZGV4O1xuICAgIH1cblxuICAgIHByaXZhdGUgZm9jdXNQcmV2Um93KGVsZW0sIHZpc2libGVDb2x1bW5JbmRleCwgZ3JpZCwgaW5DaGlsZD8sIGlzU3VtbWFyeT8pIHtcbiAgICAgICAgY29uc3QgbGFzdENlbGxJbmRleCA9IGdyaWQudW5waW5uZWRDb2x1bW5zW2dyaWQudW5waW5uZWRDb2x1bW5zLmxlbmd0aCAtIDFdLnZpc2libGVJbmRleDtcbiAgICAgICAgdmlzaWJsZUNvbHVtbkluZGV4ID0gTWF0aC5taW4obGFzdENlbGxJbmRleCwgdmlzaWJsZUNvbHVtbkluZGV4KTtcbiAgICAgICAgaWYgKGdyaWQubmF2aWdhdGlvbi5pc0NvbHVtbkZ1bGx5VmlzaWJsZSh2aXNpYmxlQ29sdW1uSW5kZXgpKSB7XG4gICAgICAgICAgICBjb25zdCBjZWxsU2VsZWN0b3IgPSB0aGlzLmdldENlbGxTZWxlY3Rvcih2aXNpYmxlQ29sdW1uSW5kZXgsIGlzU3VtbWFyeSk7XG4gICAgICAgICAgICBjb25zdCBjZWxscyA9IGVsZW0ucXVlcnlTZWxlY3RvckFsbChgJHtjZWxsU2VsZWN0b3J9W2RhdGEtdmlzaWJsZUluZGV4PVwiJHt2aXNpYmxlQ29sdW1uSW5kZXh9XCJdYCk7XG4gICAgICAgICAgICBsZXQgY2VsbCA9IGNlbGxzW2NlbGxzLmxlbmd0aCAtIDFdO1xuICAgICAgICAgICAgY29uc3QgckluZGV4ID0gcGFyc2VJbnQoZWxlbS5nZXRBdHRyaWJ1dGUoJ2RhdGEtcm93aW5kZXgnKSwgMTApO1xuICAgICAgICAgICAgY29uc3Qgc2NyR3JpZCA9IGdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXIuc2Nyb2xsUG9zaXRpb24gIT09IDAgPyBncmlkIDpcbiAgICAgICAgICAgICAgICB0aGlzLmdldE5leHRTY3JvbGxhYmxlKGdyaWQpLmdyaWQ7XG4gICAgICAgICAgICBjb25zdCB0b3BHcmlkID0gc2NyR3JpZC50Ym9keS5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnRvcCA+XG4gICAgICAgICAgICAgICAgZ3JpZC5yb290R3JpZC50Ym9keS5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnRvcCA/IHNjckdyaWQgOiBncmlkLnJvb3RHcmlkO1xuICAgICAgICAgICAgY29uc3QgZ3JpZFRvcCA9IHRoaXMuX2dldE1heFRvcChncmlkKTtcbiAgICAgICAgICAgIGNvbnN0IHNjclRvcCA9IHNjckdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXIuc2Nyb2xsUG9zaXRpb247XG4gICAgICAgICAgICBjb25zdCBkaWZmID0gY2VsbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5ib3R0b20gLVxuICAgICAgICAgICAgICAgIGNlbGwub2Zmc2V0SGVpZ2h0IC0gZ3JpZFRvcDtcbiAgICAgICAgICAgIGlmIChzY3JUb3AgIT09IDAgJiYgZGlmZiA8IDAgJiYgIWluQ2hpbGQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbEdyaWQoc2NyR3JpZCwgZGlmZiwgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBlbCA9ICFpc1N1bW1hcnkgPyBncmlkLm5hdmlnYXRpb24uZ2V0Um93QnlJbmRleChySW5kZXgpIDogZWxlbTtcbiAgICAgICAgICAgICAgICAgICAgY2VsbCA9IGVsLnF1ZXJ5U2VsZWN0b3JBbGwoYCR7Y2VsbFNlbGVjdG9yfVtkYXRhLXZpc2libGVJbmRleD1cIiR7dmlzaWJsZUNvbHVtbkluZGV4fVwiXWApWzBdO1xuICAgICAgICAgICAgICAgICAgICBjZWxsLmZvY3VzKHsgcHJldmVudFNjcm9sbDogdHJ1ZSB9KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZGlmZiA8IDAgJiYgaW5DaGlsZCkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsR3JpZCh0b3BHcmlkLCBkaWZmLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNlbGwuZm9jdXMoeyBwcmV2ZW50U2Nyb2xsOiB0cnVlIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjZWxsLmZvY3VzKHsgcHJldmVudFNjcm9sbDogdHJ1ZSB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuaG9yaXpvbnRhbFNjcm9sbEdyaWRUb0luZGV4KGdyaWQsIHZpc2libGVDb2x1bW5JbmRleCwgKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuZm9jdXNQcmV2Um93KGVsZW0sIHZpc2libGVDb2x1bW5JbmRleCwgZ3JpZCwgaW5DaGlsZCwgaXNTdW1tYXJ5KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBob3Jpem9udGFsU2Nyb2xsR3JpZFRvSW5kZXgoZ3JpZCwgdmlzaWJsZUNvbHVtbkluZGV4LCBjYWxsQmFja0Z1bmMpIHtcbiAgICAgICAgY29uc3QgdW5waW5uZWRJbmRleCA9IHRoaXMuZ2V0Q29sdW1uVW5waW5uZWRJbmRleCh2aXNpYmxlQ29sdW1uSW5kZXgsIGdyaWQpO1xuICAgICAgICBncmlkLnBhcmVudFZpcnREaXIub25DaHVua0xvYWRcbiAgICAgICAgICAgIC5waXBlKGZpcnN0KCkpXG4gICAgICAgICAgICAuc3Vic2NyaWJlKGNhbGxCYWNrRnVuYyk7XG4gICAgICAgIGlmIChncmlkLmRhdGFSb3dMaXN0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGdyaWQuZGF0YVJvd0xpc3QuZmlyc3QudmlydERpclJvdy5zY3JvbGxUbyh1bnBpbm5lZEluZGV4KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGdyaWQuaGVhZGVyQ29udGFpbmVyLnNjcm9sbFRvKHVucGlubmVkSW5kZXgpO1xuICAgICAgICB9XG5cbiAgICB9XG4gICAgcHJpdmF0ZSBzY3JvbGxHcmlkKGdyaWQsIHRhcmdldCwgY2FsbEJhY2tGdW5jKSB7XG4gICAgICAgIHRoaXMuZ2V0Rm9jdXNhYmxlR3JpZCgpLm5hdGl2ZUVsZW1lbnQuZm9jdXMoe3ByZXZlbnRTY3JvbGw6IHRydWV9KTtcbiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgdGFyZ2V0ID09PSAnbnVtYmVyJykge1xuICAgICAgICAgICAgICAgIGdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXIuYWRkU2Nyb2xsVG9wKHRhcmdldCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHN3aXRjaCAodGFyZ2V0KSB7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ3RvcCc6IGdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXIuc2Nyb2xsVG8oMCk7IGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICBjYXNlICdib3R0b20nOiBncmlkLnZlcnRpY2FsU2Nyb2xsQ29udGFpbmVyLnNjcm9sbFRvKGdyaWQuZGF0YVZpZXcubGVuZ3RoIC0gMSk7IGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICBjYXNlICduZXh0JzogZ3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5zY3JvbGxOZXh0KCk7IGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICBjYXNlICdwcmV2JzogZ3JpZC52ZXJ0aWNhbFNjcm9sbENvbnRhaW5lci5zY3JvbGxQcmV2KCk7IGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXIub25DaHVua0xvYWRcbiAgICAgICAgICAgICAgICAucGlwZShmaXJzdCgpKVxuICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUoY2FsbEJhY2tGdW5jKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfbmF2aWdhdGVVcEluQ2hpbGQocm93RWxlbWVudCwgY3VycmVudFJvd0luZGV4LCB2aXNpYmxlQ29sdW1uSW5kZXgpIHtcbiAgICAgICAgY29uc3QgcHJldkVsZW0gPSByb3dFbGVtZW50LnByZXZpb3VzRWxlbWVudFNpYmxpbmc7XG4gICAgICAgIGNvbnN0IHNjcm9sbGFibGUgPSB0aGlzLmdldE5leHRTY3JvbGxhYmxlKHRoaXMuZ3JpZCk7XG4gICAgICAgIGNvbnN0IGdyaWQgPSBzY3JvbGxhYmxlLmdyaWQ7XG4gICAgICAgIGNvbnN0IHNjclRvcCA9IGdyaWQudmVydGljYWxTY3JvbGxDb250YWluZXIuc2Nyb2xsUG9zaXRpb247XG4gICAgICAgIGNvbnN0IGNvbnRhaW5lclRvcCA9IHNjcm9sbGFibGUucHJldi5uYXRpdmVFbGVtZW50LnBhcmVudE5vZGUucGFyZW50Tm9kZS5wYXJlbnROb2RlLnBhcmVudE5vZGU7XG4gICAgICAgIGNvbnN0IHRvcCA9IHBhcnNlSW50KGNvbnRhaW5lclRvcC5zdHlsZS50b3AsIDEwKTtcbiAgICAgICAgaWYgKHNjclRvcCAhPT0gMCAmJiB0b3AgPCAwKSB7XG4gICAgICAgICAgICB0aGlzLnNjcm9sbEdyaWQoZ3JpZCwgLXByZXZFbGVtLm9mZnNldEhlaWdodCxcbiAgICAgICAgICAgICAgICAoKSA9PiBzdXBlci5uYXZpZ2F0ZVVwKHJvd0VsZW1lbnQsIHsgcm93OiBjdXJyZW50Um93SW5kZXgsIGNvbHVtbjogdmlzaWJsZUNvbHVtbkluZGV4IH0pKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN1cGVyLm5hdmlnYXRlVXAocm93RWxlbWVudCwgeyByb3c6IGN1cnJlbnRSb3dJbmRleCwgY29sdW1uOiB2aXNpYmxlQ29sdW1uSW5kZXggfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIF9uYXZpZ2F0ZURvd25JbkNoaWxkKHJvd0VsZW1lbnQsIGN1cnJlbnRSb3dJbmRleCwgdmlzaWJsZUNvbHVtbkluZGV4KSB7XG4gICAgICAgIGNvbnN0IG5leHRFbGVtID0gcm93RWxlbWVudC5uZXh0RWxlbWVudFNpYmxpbmc7XG4gICAgICAgIGNvbnN0IGNoaWxkQ29udGFpbmVyID0gdGhpcy5ncmlkLm5hdGl2ZUVsZW1lbnQucGFyZW50Tm9kZS5wYXJlbnROb2RlO1xuICAgICAgICBjb25zdCBkaWZmID1cbiAgICAgICAgICAgIGNoaWxkQ29udGFpbmVyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmJvdHRvbSAtIHRoaXMuZ3JpZC5yb290R3JpZC5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmJvdHRvbTtcbiAgICAgICAgY29uc3QgZW5kSXNWaXNpYmxlID0gZGlmZiA8IDA7XG4gICAgICAgIGNvbnN0IHNjcm9sbGFibGUgPSB0aGlzLmdldE5leHRTY3JvbGxhYmxlRG93bih0aGlzLmdyaWQpO1xuICAgICAgICBjb25zdCBncmlkID0gc2Nyb2xsYWJsZS5ncmlkO1xuICAgICAgICBpZiAoIWVuZElzVmlzaWJsZSkge1xuICAgICAgICAgICAgdGhpcy5zY3JvbGxHcmlkKGdyaWQsIG5leHRFbGVtLm9mZnNldEhlaWdodCxcbiAgICAgICAgICAgICAgICAoKSA9PiBzdXBlci5uYXZpZ2F0ZURvd24ocm93RWxlbWVudCwgeyByb3c6IGN1cnJlbnRSb3dJbmRleCwgY29sdW1uOiB2aXNpYmxlQ29sdW1uSW5kZXggfSkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3VwZXIubmF2aWdhdGVEb3duKHJvd0VsZW1lbnQsIHsgcm93OiBjdXJyZW50Um93SW5kZXgsIGNvbHVtbjogdmlzaWJsZUNvbHVtbkluZGV4IH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRDbG9zZXN0RWxlbUJ5VGFnKHNvdXJjZUVsZW0sIHRhcmdldFRhZykge1xuICAgICAgICBsZXQgcmVzdWx0ID0gc291cmNlRWxlbTtcbiAgICAgICAgd2hpbGUgKHJlc3VsdCAhPT0gbnVsbCAmJiByZXN1bHQubm9kZVR5cGUgPT09IDEpIHtcbiAgICAgICAgICAgIGlmIChyZXN1bHQudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09PSB0YXJnZXRUYWcudG9Mb3dlckNhc2UoKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXN1bHQgPSByZXN1bHQucGFyZW50Tm9kZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZ2V0TmV4dFJvd0J5SW5kZXgobmV4dEluZGV4KSB7XG4gICAgICAgIHJldHVybiB0aGlzLmdyaWQuZGF0YVJvd0xpc3QuZmluZChlbGVtZW50ID0+IGVsZW1lbnQuaW5kZXggPT09IG5leHRJbmRleCkuZWxlbWVudC5uYXRpdmVFbGVtZW50O1xuICAgfVxufVxuIl19