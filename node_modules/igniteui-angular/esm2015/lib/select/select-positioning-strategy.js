/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { VerticalAlignment, HorizontalAlignment, Point, Util } from '../services/overlay/utilities';
import { ConnectedPositioningStrategy } from '../services/overlay/position/connected-positioning-strategy';
import { fadeOut, fadeIn } from '../animations/main';
import { isIE } from '../core/utils';
/** @enum {number} */
const Direction = {
    Top: -1,
    Bottom: 1,
    None: 0,
};
Direction[Direction.Top] = 'Top';
Direction[Direction.Bottom] = 'Bottom';
Direction[Direction.None] = 'None';
/**
 * @hidden \@internal
 */
export class SelectPositioningStrategy extends ConnectedPositioningStrategy {
    /**
     * @param {?} select
     * @param {?=} settings
     */
    constructor(select, settings) {
        super();
        this.select = select;
        this._selectDefaultSettings = {
            target: null,
            horizontalDirection: HorizontalAlignment.Right,
            verticalDirection: VerticalAlignment.Bottom,
            horizontalStartPoint: HorizontalAlignment.Left,
            verticalStartPoint: VerticalAlignment.Top,
            openAnimation: fadeIn,
            closeAnimation: fadeOut
        };
        this.defaultWindowToListOffset = 5;
        this.viewPort = Util.getViewportRect(document);
        this.settings = Object.assign({}, this._selectDefaultSettings, settings);
    }
    /**
     * @private
     * @param {?} contentElement
     * @param {?} outBoundsAmount
     * @return {?}
     */
    positionAndScrollBottom(contentElement, outBoundsAmount) {
        contentElement.style.top = `${this.viewPort.bottom - this.listContainerBoundRect.height - this.defaultWindowToListOffset}px`;
        contentElement.firstElementChild.scrollTop -= outBoundsAmount - (this.defaultWindowToListOffset);
        this.deltaY = this.viewPort.bottom - this.listContainerBoundRect.height -
            this.defaultWindowToListOffset - ((/** @type {?} */ (this.select.input.nativeElement.getBoundingClientRect()))).top;
    }
    /**
     * @private
     * @param {?} contentElement
     * @param {?} CURRENT_POSITION_Y
     * @return {?}
     */
    positionNoScroll(contentElement, CURRENT_POSITION_Y) {
        contentElement.style.top = `${CURRENT_POSITION_Y - this.itemTextToInputTextDiff}px`;
        this.deltaY = CURRENT_POSITION_Y -
            ((/** @type {?} */ (this.select.input.nativeElement.getBoundingClientRect()))).top - this.itemTextToInputTextDiff;
    }
    /**
     * @private
     * @param {?} contentElement
     * @param {?} outBoundsAmount
     * @return {?}
     */
    positionAndScrollTop(contentElement, outBoundsAmount) {
        contentElement.style.top = `${this.viewPort.top + this.defaultWindowToListOffset}px`;
        contentElement.firstElementChild.scrollTop += outBoundsAmount + this.itemTextToInputTextDiff + this.defaultWindowToListOffset;
        this.deltaY = this.viewPort.top + this.defaultWindowToListOffset -
            ((/** @type {?} */ (this.select.input.nativeElement.getBoundingClientRect()))).top;
    }
    /**
     * @private
     * @param {?} contentElement
     * @param {?} itemHeight
     * @return {?}
     */
    getItemsOutOfView(contentElement, itemHeight) {
        if (contentElement.firstElementChild.scrollHeight <= contentElement.firstElementChild.clientHeight) {
            return {
                'currentScroll': 0,
                'remainingScroll': 0
            };
        }
        /** @type {?} */
        const currentScroll = contentElement.firstElementChild.scrollTop;
        /** @type {?} */
        const remainingScroll = this.select.items.length * itemHeight - currentScroll - this.listContainerBoundRect.height;
        return {
            'currentScroll': currentScroll,
            'remainingScroll': remainingScroll
        };
    }
    /**
     * @private
     * @param {?} elementContainer
     * @param {?} document
     * @return {?}
     */
    listOutOfBounds(elementContainer, document) {
        /** @type {?} */
        const container = {
            TOP: elementContainer.top,
            BOTTOM: elementContainer.bottom,
        };
        /** @type {?} */
        const viewPort = Util.getViewportRect(document);
        /** @type {?} */
        const documentElement = {
            TOP: viewPort.top,
            BOTTOM: viewPort.bottom
        };
        /** @type {?} */
        const returnVals = {
            Direction: Direction.None,
            Amount: 0
        };
        if (documentElement.TOP + this.defaultWindowToListOffset > container.TOP) {
            returnVals.Direction = Direction.Top;
            returnVals.Amount = documentElement.TOP - container.TOP;
        }
        else if (documentElement.BOTTOM - this.defaultWindowToListOffset < container.BOTTOM) {
            returnVals.Direction = Direction.Bottom;
            returnVals.Amount = container.BOTTOM - documentElement.BOTTOM;
        }
        else {
            return null;
        }
        return returnVals;
    }
    /**
     * @param {?} contentElement
     * @param {?} size
     * @param {?=} document
     * @param {?=} initialCall
     * @return {?}
     */
    position(contentElement, size, document, initialCall) {
        /** @type {?} */
        const inputElement = this.select.input.nativeElement;
        /** @type {?} */
        const inputRect = (/** @type {?} */ (inputElement.getBoundingClientRect()));
        this.listContainerBoundRect = (/** @type {?} */ (contentElement.getBoundingClientRect()));
        /** @type {?} */
        const LIST_HEIGHT = this.listContainerBoundRect.height;
        if (!initialCall) {
            this.deltaX = inputRect.left - this.itemTextPadding - this.itemTextIndent;
            /** @type {?} */
            const point = new Point(this.deltaX, inputRect.top + this.deltaY);
            this.settings.target = point;
            super.position(contentElement, size);
            return;
        }
        /** @type {?} */
        const START = {
            X: inputRect.left,
            Y: inputRect.top
        };
        /** @type {?} */
        let itemElement;
        if (this.select.selectedItem) {
            itemElement = this.select.selectedItem.element.nativeElement;
            // D.P. Feb 22 2019, #3921 Force item scroll before measuring in IE11, due to base scrollToItem delay
            if (isIE()) {
                contentElement.firstElementChild.scrollTop = this.select.calculateScrollPosition(this.select.selectedItem);
            }
        }
        else {
            itemElement = this.select.getFirstItemElement();
        }
        /** @type {?} */
        const inputHeight = inputRect.height;
        /** @type {?} */
        const itemBoundRect = (/** @type {?} */ (itemElement.getBoundingClientRect()));
        /** @type {?} */
        const itemTopListOffset = itemBoundRect.top - this.listContainerBoundRect.top;
        /** @type {?} */
        const itemHeight = itemBoundRect.height;
        /** @type {?} */
        const inputFontSize = window.getComputedStyle(inputElement).fontSize;
        /** @type {?} */
        const numericInputFontSize = parseInt(inputFontSize.slice(0, inputFontSize.indexOf('p')), 10) || 0;
        /** @type {?} */
        const itemFontSize = window.getComputedStyle(itemElement).fontSize;
        /** @type {?} */
        const numericItemFontSize = parseInt(itemFontSize.slice(0, itemFontSize.indexOf('p')), 10) || 0;
        /** @type {?} */
        const inputTextToInputTop = (inputHeight - numericInputFontSize) / 2;
        /** @type {?} */
        const itemTextToItemTop = (itemHeight - numericItemFontSize) / 2;
        this.itemTextToInputTextDiff = itemTextToItemTop - inputTextToInputTop;
        /** @type {?} */
        let CURRENT_POSITION_Y = START.Y - itemTopListOffset;
        /** @type {?} */
        const CURRENT_BOTTOM_Y = CURRENT_POSITION_Y + this.listContainerBoundRect.height;
        /** @type {?} */
        const OUT_OF_BOUNDS = this.listOutOfBounds({ top: CURRENT_POSITION_Y, bottom: CURRENT_BOTTOM_Y }, document);
        if (OUT_OF_BOUNDS) {
            if (OUT_OF_BOUNDS.Direction === Direction.Top) {
                CURRENT_POSITION_Y = START.Y;
            }
            else {
                CURRENT_POSITION_Y = -1 * (LIST_HEIGHT - (itemHeight - (itemHeight - inputHeight) / 2));
                CURRENT_POSITION_Y += START.Y;
            }
        }
        /** @type {?} */
        const selectItemPaddingHorizontal = 24;
        /** @type {?} */
        const itemLeftPadding = window.getComputedStyle(itemElement).paddingLeft;
        /** @type {?} */
        const itemTextIndent = window.getComputedStyle(itemElement).textIndent;
        /** @type {?} */
        const numericLeftPadding = parseInt(itemLeftPadding.slice(0, itemLeftPadding.indexOf('p')), 10) || 0;
        /** @type {?} */
        const numericTextIndent = parseInt(itemTextIndent.slice(0, itemTextIndent.indexOf('r')), 10) || 0;
        this.itemTextPadding = numericLeftPadding;
        this.itemTextIndent = numericTextIndent;
        contentElement.style.left += `${START.X - numericLeftPadding - numericTextIndent}px`;
        contentElement.style.width = inputRect.width + 24 + selectItemPaddingHorizontal * 2 + 'px';
        this.deltaX = START.X - numericLeftPadding - numericTextIndent;
        /** @type {?} */
        const currentScroll = this.getItemsOutOfView(contentElement, itemHeight)['currentScroll'];
        /** @type {?} */
        const remainingScroll = this.getItemsOutOfView(contentElement, itemHeight)['remainingScroll'];
        // (5 items or less) no scroll and respectively no remaining scroll
        if (remainingScroll === 0 && currentScroll === 0) {
            this.positionNoScroll(contentElement, CURRENT_POSITION_Y);
        }
        // (more than 5 items) there is scroll OR remaining scroll
        if (remainingScroll !== 0 || currentScroll !== 0) {
            if (remainingScroll !== 0 && !OUT_OF_BOUNDS) {
                this.positionNoScroll(contentElement, CURRENT_POSITION_Y);
            }
            // (more than 5 items) and container getting out of the visible port
            if (remainingScroll !== 0 && OUT_OF_BOUNDS) {
                // if there is enough remaining scroll to scroll the item
                if (remainingScroll > itemHeight) {
                    if (OUT_OF_BOUNDS.Direction === Direction.Top) {
                        this.positionAndScrollTop(contentElement, OUT_OF_BOUNDS.Amount);
                        return;
                    }
                    if (OUT_OF_BOUNDS.Direction === Direction.Bottom) {
                        // (more than 5 items) and no current scroll
                        if (currentScroll === 0) {
                            this.positionNoScroll(contentElement, CURRENT_POSITION_Y);
                            return;
                            // (more than 5 items) and current scroll
                        }
                        else {
                            this.positionAndScrollBottom(contentElement, OUT_OF_BOUNDS.Amount);
                            return;
                        }
                    }
                }
                // if there is no enough remaining scroll to scroll the item
                if (remainingScroll < itemHeight) {
                    if (OUT_OF_BOUNDS.Direction === Direction.Top) {
                        this.positionNoScroll(contentElement, CURRENT_POSITION_Y);
                    }
                    if (OUT_OF_BOUNDS.Direction === Direction.Bottom) {
                        this.positionAndScrollBottom(contentElement, OUT_OF_BOUNDS.Amount);
                    }
                }
            }
            // (more than 5 items) and no remaining scroll
            if (remainingScroll === 0 && currentScroll !== 0) {
                if (OUT_OF_BOUNDS) {
                    if (OUT_OF_BOUNDS.Direction === Direction.Bottom) {
                        this.positionAndScrollBottom(contentElement, OUT_OF_BOUNDS.Amount);
                        return;
                    }
                }
                this.positionNoScroll(contentElement, CURRENT_POSITION_Y);
            }
        }
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    SelectPositioningStrategy.prototype._selectDefaultSettings;
    /** @type {?} */
    SelectPositioningStrategy.prototype.settings;
    /**
     * @type {?}
     * @private
     */
    SelectPositioningStrategy.prototype.defaultWindowToListOffset;
    /**
     * @type {?}
     * @private
     */
    SelectPositioningStrategy.prototype.viewPort;
    /**
     * @type {?}
     * @private
     */
    SelectPositioningStrategy.prototype.deltaY;
    /**
     * @type {?}
     * @private
     */
    SelectPositioningStrategy.prototype.deltaX;
    /**
     * @type {?}
     * @private
     */
    SelectPositioningStrategy.prototype.itemTextPadding;
    /**
     * @type {?}
     * @private
     */
    SelectPositioningStrategy.prototype.itemTextIndent;
    /**
     * @type {?}
     * @private
     */
    SelectPositioningStrategy.prototype.listContainerBoundRect;
    /**
     * @type {?}
     * @private
     */
    SelectPositioningStrategy.prototype.itemTextToInputTextDiff;
    /** @type {?} */
    SelectPositioningStrategy.prototype.select;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0LXBvc2l0aW9uaW5nLXN0cmF0ZWd5LmpzIiwic291cmNlUm9vdCI6Im5nOi8vaWduaXRldWktYW5ndWxhci8iLCJzb3VyY2VzIjpbImxpYi9zZWxlY3Qvc2VsZWN0LXBvc2l0aW9uaW5nLXN0cmF0ZWd5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsbUJBQW1CLEVBQTBCLEtBQUssRUFBRSxJQUFJLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUM1SCxPQUFPLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSw2REFBNkQsQ0FBQztBQUUzRyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRXJELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxlQUFlLENBQUM7OztJQUlqQyxPQUFRO0lBQ1IsU0FBVTtJQUNWLE9BQVE7Ozs7Ozs7O0FBSVosTUFBTSxPQUFPLHlCQUEwQixTQUFRLDRCQUE0Qjs7Ozs7SUFhdkUsWUFBbUIsTUFBcUIsRUFBRSxRQUEyQjtRQUNqRSxLQUFLLEVBQUUsQ0FBQztRQURPLFdBQU0sR0FBTixNQUFNLENBQWU7UUFYaEMsMkJBQXNCLEdBQUc7WUFDN0IsTUFBTSxFQUFFLElBQUk7WUFDWixtQkFBbUIsRUFBRSxtQkFBbUIsQ0FBQyxLQUFLO1lBQzlDLGlCQUFpQixFQUFFLGlCQUFpQixDQUFDLE1BQU07WUFDM0Msb0JBQW9CLEVBQUUsbUJBQW1CLENBQUMsSUFBSTtZQUM5QyxrQkFBa0IsRUFBRSxpQkFBaUIsQ0FBQyxHQUFHO1lBQ3pDLGFBQWEsRUFBRSxNQUFNO1lBQ3JCLGNBQWMsRUFBRSxPQUFPO1NBQzFCLENBQUM7UUFRTSw4QkFBeUIsR0FBRyxDQUFDLENBQUM7UUFDOUIsYUFBUSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUM7UUFKOUMsSUFBSSxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsc0JBQXNCLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDN0UsQ0FBQzs7Ozs7OztJQVdPLHVCQUF1QixDQUFDLGNBQTJCLEVBQUUsZUFBdUI7UUFDaEYsY0FBYyxDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyx5QkFBeUIsSUFBSSxDQUFDO1FBQzdILGNBQWMsQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLElBQUksZUFBZSxHQUFHLENBQUMsSUFBSSxDQUFDLHlCQUF5QixDQUFDLENBQUM7UUFDakcsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUMsTUFBTTtZQUNuRSxJQUFJLENBQUMseUJBQXlCLEdBQUcsQ0FBQyxtQkFBQSxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMscUJBQXFCLEVBQUUsRUFBVyxDQUFDLENBQUMsR0FBRyxDQUFDO0lBQ2xILENBQUM7Ozs7Ozs7SUFFTyxnQkFBZ0IsQ0FBQyxjQUEyQixFQUFFLGtCQUEwQjtRQUM1RSxjQUFjLENBQUMsS0FBSyxDQUFDLEdBQUcsR0FBRyxHQUFHLGtCQUFrQixHQUFHLElBQUksQ0FBQyx1QkFBdUIsSUFBSSxDQUFDO1FBQ3BGLElBQUksQ0FBQyxNQUFNLEdBQUcsa0JBQWtCO1lBQzVCLENBQUMsbUJBQUEsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsYUFBYSxDQUFDLHFCQUFxQixFQUFFLEVBQVcsQ0FBQyxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsdUJBQXVCLENBQUM7SUFDaEgsQ0FBQzs7Ozs7OztJQUVPLG9CQUFvQixDQUFDLGNBQTJCLEVBQUUsZUFBdUI7UUFDN0UsY0FBYyxDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMseUJBQXlCLElBQUksQ0FBQztRQUNyRixjQUFjLENBQUMsaUJBQWlCLENBQUMsU0FBUyxJQUFJLGVBQWUsR0FBRyxJQUFJLENBQUMsdUJBQXVCLEdBQUcsSUFBSSxDQUFDLHlCQUF5QixDQUFDO1FBQzlILElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLHlCQUF5QjtZQUM1RCxDQUFDLG1CQUFBLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxxQkFBcUIsRUFBRSxFQUFXLENBQUMsQ0FBQyxHQUFHLENBQUM7SUFDakYsQ0FBQzs7Ozs7OztJQUVPLGlCQUFpQixDQUFDLGNBQTJCLEVBQUUsVUFBa0I7UUFJckUsSUFBSSxjQUFjLENBQUMsaUJBQWlCLENBQUMsWUFBWSxJQUFJLGNBQWMsQ0FBQyxpQkFBaUIsQ0FBQyxZQUFZLEVBQUU7WUFDaEcsT0FBTztnQkFDSCxlQUFlLEVBQUUsQ0FBQztnQkFDbEIsaUJBQWlCLEVBQUUsQ0FBQzthQUN2QixDQUFDO1NBQ0w7O2NBQ0ssYUFBYSxHQUFHLGNBQWMsQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTOztjQUMxRCxlQUFlLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLFVBQVUsR0FBRyxhQUFhLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixDQUFDLE1BQU07UUFDbEgsT0FBTztZQUNILGVBQWUsRUFBRSxhQUFhO1lBQzlCLGlCQUFpQixFQUFFLGVBQWU7U0FDckMsQ0FBQztJQUNOLENBQUM7Ozs7Ozs7SUFFTyxlQUFlLENBQUMsZ0JBQWlELEVBQUUsUUFBa0I7O2NBSW5GLFNBQVMsR0FBRztZQUNkLEdBQUcsRUFBRSxnQkFBZ0IsQ0FBQyxHQUFHO1lBQ3pCLE1BQU0sRUFBRSxnQkFBZ0IsQ0FBQyxNQUFNO1NBQ2xDOztjQUNLLFFBQVEsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQzs7Y0FDekMsZUFBZSxHQUFHO1lBQ3BCLEdBQUcsRUFBRSxRQUFRLENBQUMsR0FBRztZQUNqQixNQUFNLEVBQUUsUUFBUSxDQUFDLE1BQU07U0FDMUI7O2NBQ0ssVUFBVSxHQUFHO1lBQ2YsU0FBUyxFQUFFLFNBQVMsQ0FBQyxJQUFJO1lBQ3pCLE1BQU0sRUFBRSxDQUFDO1NBQ1o7UUFDRCxJQUFJLGVBQWUsQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLHlCQUF5QixHQUFHLFNBQVMsQ0FBQyxHQUFHLEVBQUU7WUFDdEUsVUFBVSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDO1lBQ3JDLFVBQVUsQ0FBQyxNQUFNLEdBQUcsZUFBZSxDQUFDLEdBQUcsR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDO1NBQzNEO2FBQU0sSUFBSSxlQUFlLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyx5QkFBeUIsR0FBRyxTQUFTLENBQUMsTUFBTSxFQUFFO1lBQ25GLFVBQVUsQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FBQztZQUN4QyxVQUFVLENBQUMsTUFBTSxHQUFHLFNBQVMsQ0FBQyxNQUFNLEdBQUcsZUFBZSxDQUFDLE1BQU0sQ0FBQztTQUNqRTthQUFNO1lBQ0gsT0FBTyxJQUFJLENBQUM7U0FDZjtRQUNELE9BQU8sVUFBVSxDQUFDO0lBQ3RCLENBQUM7Ozs7Ozs7O0lBRUQsUUFBUSxDQUFDLGNBQTJCLEVBQUUsSUFBVSxFQUFFLFFBQW1CLEVBQUUsV0FBcUI7O2NBQ2xGLFlBQVksR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxhQUFhOztjQUM5QyxTQUFTLEdBQUcsbUJBQUEsWUFBWSxDQUFDLHFCQUFxQixFQUFFLEVBQVc7UUFDakUsSUFBSSxDQUFDLHNCQUFzQixHQUFHLG1CQUFBLGNBQWMsQ0FBQyxxQkFBcUIsRUFBRSxFQUFXLENBQUM7O2NBQzFFLFdBQVcsR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUMsTUFBTTtRQUN0RCxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ2QsSUFBSSxDQUFDLE1BQU0sR0FBRyxTQUFTLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQzs7a0JBQ3BFLEtBQUssR0FBRyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLFNBQVMsQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztZQUNqRSxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUM7WUFDN0IsS0FBSyxDQUFDLFFBQVEsQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDckMsT0FBTztTQUNWOztjQUVLLEtBQUssR0FBRztZQUNWLENBQUMsRUFBRSxTQUFTLENBQUMsSUFBSTtZQUNqQixDQUFDLEVBQUUsU0FBUyxDQUFDLEdBQUc7U0FDbkI7O1lBRUcsV0FBVztRQUNmLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLEVBQUU7WUFDMUIsV0FBVyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUM7WUFDN0QscUdBQXFHO1lBQ3JHLElBQUksSUFBSSxFQUFFLEVBQUU7Z0JBQ1IsY0FBYyxDQUFDLGlCQUFpQixDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLHVCQUF1QixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUM7YUFDOUc7U0FDSjthQUFNO1lBQ0gsV0FBVyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztTQUNuRDs7Y0FDSyxXQUFXLEdBQUcsU0FBUyxDQUFDLE1BQU07O2NBQzlCLGFBQWEsR0FBRyxtQkFBQSxXQUFXLENBQUMscUJBQXFCLEVBQUUsRUFBVzs7Y0FDOUQsaUJBQWlCLEdBQUcsYUFBYSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUMsR0FBRzs7Y0FDdkUsVUFBVSxHQUFHLGFBQWEsQ0FBQyxNQUFNOztjQUVqQyxhQUFhLEdBQUcsTUFBTSxDQUFDLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxDQUFDLFFBQVE7O2NBQzlELG9CQUFvQixHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQzs7Y0FDNUYsWUFBWSxHQUFHLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsQ0FBQyxRQUFROztjQUM1RCxtQkFBbUIsR0FBRyxRQUFRLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsWUFBWSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUM7O2NBQ3pGLG1CQUFtQixHQUFHLENBQUMsV0FBVyxHQUFHLG9CQUFvQixDQUFDLEdBQUcsQ0FBQzs7Y0FDOUQsaUJBQWlCLEdBQUcsQ0FBQyxVQUFVLEdBQUcsbUJBQW1CLENBQUMsR0FBRyxDQUFDO1FBQ2hFLElBQUksQ0FBQyx1QkFBdUIsR0FBRyxpQkFBaUIsR0FBRyxtQkFBbUIsQ0FBQzs7WUFFbkUsa0JBQWtCLEdBQUcsS0FBSyxDQUFDLENBQUMsR0FBRyxpQkFBaUI7O2NBQzlDLGdCQUFnQixHQUFHLGtCQUFrQixHQUFHLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxNQUFNOztjQUUxRSxhQUFhLEdBR2YsSUFBSSxDQUFDLGVBQWUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxrQkFBa0IsRUFBRSxNQUFNLEVBQUUsZ0JBQWdCLEVBQUUsRUFBRSxRQUFRLENBQUM7UUFDekYsSUFBSSxhQUFhLEVBQUU7WUFDZixJQUFJLGFBQWEsQ0FBQyxTQUFTLEtBQUssU0FBUyxDQUFDLEdBQUcsRUFBRTtnQkFDM0Msa0JBQWtCLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQzthQUNoQztpQkFBTTtnQkFDSCxrQkFBa0IsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLFdBQVcsR0FBRyxDQUFDLFVBQVUsR0FBRyxDQUFDLFVBQVUsR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN4RixrQkFBa0IsSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDO2FBQ2pDO1NBQ0o7O2NBQ0ssMkJBQTJCLEdBQUcsRUFBRTs7Y0FDaEMsZUFBZSxHQUFHLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsQ0FBQyxXQUFXOztjQUNsRSxjQUFjLEdBQUcsTUFBTSxDQUFDLGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxDQUFDLFVBQVU7O2NBQ2hFLGtCQUFrQixHQUFHLFFBQVEsQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxlQUFlLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQzs7Y0FDOUYsaUJBQWlCLEdBQUcsUUFBUSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLGNBQWMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDO1FBQ2pHLElBQUksQ0FBQyxlQUFlLEdBQUcsa0JBQWtCLENBQUM7UUFDMUMsSUFBSSxDQUFDLGNBQWMsR0FBRyxpQkFBaUIsQ0FBQztRQUN4QyxjQUFjLENBQUMsS0FBSyxDQUFDLElBQUksSUFBSSxHQUFHLEtBQUssQ0FBQyxDQUFDLEdBQUcsa0JBQWtCLEdBQUcsaUJBQWlCLElBQUksQ0FBQztRQUNyRixjQUFjLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxTQUFTLENBQUMsS0FBSyxHQUFHLEVBQUUsR0FBRywyQkFBMkIsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDO1FBQzNGLElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDLENBQUMsR0FBRyxrQkFBa0IsR0FBRyxpQkFBaUIsQ0FBQzs7Y0FDekQsYUFBYSxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxjQUFjLEVBQUUsVUFBVSxDQUFDLENBQUMsZUFBZSxDQUFDOztjQUNuRixlQUFlLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLGNBQWMsRUFBRSxVQUFVLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQztRQUU3RixtRUFBbUU7UUFDbkUsSUFBSSxlQUFlLEtBQUssQ0FBQyxJQUFJLGFBQWEsS0FBSyxDQUFDLEVBQUU7WUFDOUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGNBQWMsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO1NBQzdEO1FBQ0QsMERBQTBEO1FBQzFELElBQUksZUFBZSxLQUFLLENBQUMsSUFBSSxhQUFhLEtBQUssQ0FBQyxFQUFFO1lBQzlDLElBQUksZUFBZSxLQUFLLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRTtnQkFDekMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGNBQWMsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO2FBQzdEO1lBQ0Qsb0VBQW9FO1lBQ3BFLElBQUksZUFBZSxLQUFLLENBQUMsSUFBSSxhQUFhLEVBQUU7Z0JBQ3hDLHlEQUF5RDtnQkFDekQsSUFBSSxlQUFlLEdBQUcsVUFBVSxFQUFFO29CQUM5QixJQUFJLGFBQWEsQ0FBQyxTQUFTLEtBQUssU0FBUyxDQUFDLEdBQUcsRUFBRTt3QkFDM0MsSUFBSSxDQUFDLG9CQUFvQixDQUFDLGNBQWMsRUFBRSxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUM7d0JBQ2hFLE9BQU87cUJBQ1Y7b0JBQ0QsSUFBSSxhQUFhLENBQUMsU0FBUyxLQUFLLFNBQVMsQ0FBQyxNQUFNLEVBQUU7d0JBQzlDLDRDQUE0Qzt3QkFDNUMsSUFBSSxhQUFhLEtBQUssQ0FBQyxFQUFFOzRCQUNyQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsY0FBYyxFQUFFLGtCQUFrQixDQUFDLENBQUM7NEJBQzFELE9BQU87NEJBQ1AseUNBQXlDO3lCQUM1Qzs2QkFBTTs0QkFDSCxJQUFJLENBQUMsdUJBQXVCLENBQUMsY0FBYyxFQUFFLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQzs0QkFDbkUsT0FBTzt5QkFDVjtxQkFDSjtpQkFDSjtnQkFDRCw0REFBNEQ7Z0JBQzVELElBQUksZUFBZSxHQUFHLFVBQVUsRUFBRTtvQkFDOUIsSUFBSSxhQUFhLENBQUMsU0FBUyxLQUFLLFNBQVMsQ0FBQyxHQUFHLEVBQUU7d0JBQzNDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxjQUFjLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztxQkFFN0Q7b0JBQ0QsSUFBSSxhQUFhLENBQUMsU0FBUyxLQUFLLFNBQVMsQ0FBQyxNQUFNLEVBQUU7d0JBQzlDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxjQUFjLEVBQUUsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDO3FCQUN0RTtpQkFDSjthQUNKO1lBQ0QsOENBQThDO1lBQzlDLElBQUksZUFBZSxLQUFLLENBQUMsSUFBSSxhQUFhLEtBQUssQ0FBQyxFQUFFO2dCQUM5QyxJQUFJLGFBQWEsRUFBRTtvQkFDZixJQUFJLGFBQWEsQ0FBQyxTQUFTLEtBQUssU0FBUyxDQUFDLE1BQU0sRUFBRTt3QkFDOUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLGNBQWMsRUFBRSxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUM7d0JBQ25FLE9BQU87cUJBQ1Y7aUJBQ0o7Z0JBQ0QsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGNBQWMsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO2FBQzdEO1NBQ0o7SUFDTCxDQUFDO0NBQ0o7Ozs7OztJQXJORywyREFRRTs7SUFDRiw2Q0FBa0M7Ozs7O0lBT2xDLDhEQUFzQzs7Ozs7SUFDdEMsNkNBQWtEOzs7OztJQUNsRCwyQ0FBdUI7Ozs7O0lBQ3ZCLDJDQUF1Qjs7Ozs7SUFDdkIsb0RBQWdDOzs7OztJQUNoQyxtREFBK0I7Ozs7O0lBQy9CLDJEQUF3Qzs7Ozs7SUFDeEMsNERBQXdDOztJQVo1QiwyQ0FBNEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBWZXJ0aWNhbEFsaWdubWVudCwgSG9yaXpvbnRhbEFsaWdubWVudCwgUG9zaXRpb25TZXR0aW5ncywgU2l6ZSwgUG9pbnQsIFV0aWwgfSBmcm9tICcuLi9zZXJ2aWNlcy9vdmVybGF5L3V0aWxpdGllcyc7XG5pbXBvcnQgeyBDb25uZWN0ZWRQb3NpdGlvbmluZ1N0cmF0ZWd5IH0gZnJvbSAnLi4vc2VydmljZXMvb3ZlcmxheS9wb3NpdGlvbi9jb25uZWN0ZWQtcG9zaXRpb25pbmctc3RyYXRlZ3knO1xuaW1wb3J0IHsgSVBvc2l0aW9uU3RyYXRlZ3kgfSBmcm9tICcuLi9zZXJ2aWNlcy9vdmVybGF5L3Bvc2l0aW9uJztcbmltcG9ydCB7IGZhZGVPdXQsIGZhZGVJbiB9IGZyb20gJy4uL2FuaW1hdGlvbnMvbWFpbic7XG5pbXBvcnQgeyBJZ3hTZWxlY3RCYXNlIH0gZnJvbSAnLi9zZWxlY3QuY29tbW9uJztcbmltcG9ydCB7IGlzSUUgfSBmcm9tICcuLi9jb3JlL3V0aWxzJztcblxuLyoqIEBoaWRkZW4gKi9cbmVudW0gRGlyZWN0aW9uIHtcbiAgICBUb3AgPSAtMSxcbiAgICBCb3R0b20gPSAxLFxuICAgIE5vbmUgPSAwXG59XG5cbi8qKiBAaGlkZGVuIEBpbnRlcm5hbCAqL1xuZXhwb3J0IGNsYXNzIFNlbGVjdFBvc2l0aW9uaW5nU3RyYXRlZ3kgZXh0ZW5kcyBDb25uZWN0ZWRQb3NpdGlvbmluZ1N0cmF0ZWd5IGltcGxlbWVudHMgSVBvc2l0aW9uU3RyYXRlZ3kge1xuXG4gICAgcHJpdmF0ZSBfc2VsZWN0RGVmYXVsdFNldHRpbmdzID0ge1xuICAgICAgICB0YXJnZXQ6IG51bGwsXG4gICAgICAgIGhvcml6b250YWxEaXJlY3Rpb246IEhvcml6b250YWxBbGlnbm1lbnQuUmlnaHQsXG4gICAgICAgIHZlcnRpY2FsRGlyZWN0aW9uOiBWZXJ0aWNhbEFsaWdubWVudC5Cb3R0b20sXG4gICAgICAgIGhvcml6b250YWxTdGFydFBvaW50OiBIb3Jpem9udGFsQWxpZ25tZW50LkxlZnQsXG4gICAgICAgIHZlcnRpY2FsU3RhcnRQb2ludDogVmVydGljYWxBbGlnbm1lbnQuVG9wLFxuICAgICAgICBvcGVuQW5pbWF0aW9uOiBmYWRlSW4sXG4gICAgICAgIGNsb3NlQW5pbWF0aW9uOiBmYWRlT3V0XG4gICAgfTtcbiAgICBwdWJsaWMgc2V0dGluZ3M6IFBvc2l0aW9uU2V0dGluZ3M7XG5cbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgc2VsZWN0OiBJZ3hTZWxlY3RCYXNlLCBzZXR0aW5ncz86IFBvc2l0aW9uU2V0dGluZ3MpIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgdGhpcy5zZXR0aW5ncyA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuX3NlbGVjdERlZmF1bHRTZXR0aW5ncywgc2V0dGluZ3MpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZGVmYXVsdFdpbmRvd1RvTGlzdE9mZnNldCA9IDU7XG4gICAgcHJpdmF0ZSB2aWV3UG9ydCA9IFV0aWwuZ2V0Vmlld3BvcnRSZWN0KGRvY3VtZW50KTtcbiAgICBwcml2YXRlIGRlbHRhWTogbnVtYmVyO1xuICAgIHByaXZhdGUgZGVsdGFYOiBudW1iZXI7XG4gICAgcHJpdmF0ZSBpdGVtVGV4dFBhZGRpbmc6IG51bWJlcjtcbiAgICBwcml2YXRlIGl0ZW1UZXh0SW5kZW50OiBudW1iZXI7XG4gICAgcHJpdmF0ZSBsaXN0Q29udGFpbmVyQm91bmRSZWN0OiBET01SZWN0O1xuICAgIHByaXZhdGUgaXRlbVRleHRUb0lucHV0VGV4dERpZmY6IG51bWJlcjtcblxuICAgIHByaXZhdGUgcG9zaXRpb25BbmRTY3JvbGxCb3R0b20oY29udGVudEVsZW1lbnQ6IEhUTUxFbGVtZW50LCBvdXRCb3VuZHNBbW91bnQ6IG51bWJlcikge1xuICAgICAgICBjb250ZW50RWxlbWVudC5zdHlsZS50b3AgPSBgJHt0aGlzLnZpZXdQb3J0LmJvdHRvbSAtIHRoaXMubGlzdENvbnRhaW5lckJvdW5kUmVjdC5oZWlnaHQgLSB0aGlzLmRlZmF1bHRXaW5kb3dUb0xpc3RPZmZzZXR9cHhgO1xuICAgICAgICBjb250ZW50RWxlbWVudC5maXJzdEVsZW1lbnRDaGlsZC5zY3JvbGxUb3AgLT0gb3V0Qm91bmRzQW1vdW50IC0gKHRoaXMuZGVmYXVsdFdpbmRvd1RvTGlzdE9mZnNldCk7XG4gICAgICAgIHRoaXMuZGVsdGFZID0gdGhpcy52aWV3UG9ydC5ib3R0b20gLSB0aGlzLmxpc3RDb250YWluZXJCb3VuZFJlY3QuaGVpZ2h0IC1cbiAgICAgICAgICAgIHRoaXMuZGVmYXVsdFdpbmRvd1RvTGlzdE9mZnNldCAtICh0aGlzLnNlbGVjdC5pbnB1dC5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpIGFzIERPTVJlY3QpLnRvcDtcbiAgICB9XG5cbiAgICBwcml2YXRlIHBvc2l0aW9uTm9TY3JvbGwoY29udGVudEVsZW1lbnQ6IEhUTUxFbGVtZW50LCBDVVJSRU5UX1BPU0lUSU9OX1k6IG51bWJlcikge1xuICAgICAgICBjb250ZW50RWxlbWVudC5zdHlsZS50b3AgPSBgJHtDVVJSRU5UX1BPU0lUSU9OX1kgLSB0aGlzLml0ZW1UZXh0VG9JbnB1dFRleHREaWZmfXB4YDtcbiAgICAgICAgdGhpcy5kZWx0YVkgPSBDVVJSRU5UX1BPU0lUSU9OX1kgLVxuICAgICAgICAgICAgKHRoaXMuc2VsZWN0LmlucHV0Lm5hdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkgYXMgRE9NUmVjdCkudG9wIC0gdGhpcy5pdGVtVGV4dFRvSW5wdXRUZXh0RGlmZjtcbiAgICB9XG5cbiAgICBwcml2YXRlIHBvc2l0aW9uQW5kU2Nyb2xsVG9wKGNvbnRlbnRFbGVtZW50OiBIVE1MRWxlbWVudCwgb3V0Qm91bmRzQW1vdW50OiBudW1iZXIpIHtcbiAgICAgICAgY29udGVudEVsZW1lbnQuc3R5bGUudG9wID0gYCR7dGhpcy52aWV3UG9ydC50b3AgKyB0aGlzLmRlZmF1bHRXaW5kb3dUb0xpc3RPZmZzZXR9cHhgO1xuICAgICAgICBjb250ZW50RWxlbWVudC5maXJzdEVsZW1lbnRDaGlsZC5zY3JvbGxUb3AgKz0gb3V0Qm91bmRzQW1vdW50ICsgdGhpcy5pdGVtVGV4dFRvSW5wdXRUZXh0RGlmZiArIHRoaXMuZGVmYXVsdFdpbmRvd1RvTGlzdE9mZnNldDtcbiAgICAgICAgdGhpcy5kZWx0YVkgPSB0aGlzLnZpZXdQb3J0LnRvcCArIHRoaXMuZGVmYXVsdFdpbmRvd1RvTGlzdE9mZnNldCAtXG4gICAgICAgICAgICAodGhpcy5zZWxlY3QuaW5wdXQubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSBhcyBET01SZWN0KS50b3A7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRJdGVtc091dE9mVmlldyhjb250ZW50RWxlbWVudDogSFRNTEVsZW1lbnQsIGl0ZW1IZWlnaHQ6IG51bWJlcik6IHtcbiAgICAgICAgJ2N1cnJlbnRTY3JvbGwnOiBudW1iZXIsXG4gICAgICAgICdyZW1haW5pbmdTY3JvbGwnOiBudW1iZXJcbiAgICB9IHtcbiAgICAgICAgaWYgKGNvbnRlbnRFbGVtZW50LmZpcnN0RWxlbWVudENoaWxkLnNjcm9sbEhlaWdodCA8PSBjb250ZW50RWxlbWVudC5maXJzdEVsZW1lbnRDaGlsZC5jbGllbnRIZWlnaHQpIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgJ2N1cnJlbnRTY3JvbGwnOiAwLFxuICAgICAgICAgICAgICAgICdyZW1haW5pbmdTY3JvbGwnOiAwXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGN1cnJlbnRTY3JvbGwgPSBjb250ZW50RWxlbWVudC5maXJzdEVsZW1lbnRDaGlsZC5zY3JvbGxUb3A7XG4gICAgICAgIGNvbnN0IHJlbWFpbmluZ1Njcm9sbCA9IHRoaXMuc2VsZWN0Lml0ZW1zLmxlbmd0aCAqIGl0ZW1IZWlnaHQgLSBjdXJyZW50U2Nyb2xsIC0gdGhpcy5saXN0Q29udGFpbmVyQm91bmRSZWN0LmhlaWdodDtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICdjdXJyZW50U2Nyb2xsJzogY3VycmVudFNjcm9sbCxcbiAgICAgICAgICAgICdyZW1haW5pbmdTY3JvbGwnOiByZW1haW5pbmdTY3JvbGxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGxpc3RPdXRPZkJvdW5kcyhlbGVtZW50Q29udGFpbmVyOiB7IHRvcDogbnVtYmVyLCBib3R0b206IG51bWJlciB9LCBkb2N1bWVudDogRG9jdW1lbnQpOiB7XG4gICAgICAgIERpcmVjdGlvbjogRGlyZWN0aW9uLFxuICAgICAgICBBbW91bnQ6IG51bWJlclxuICAgIH0ge1xuICAgICAgICBjb25zdCBjb250YWluZXIgPSB7XG4gICAgICAgICAgICBUT1A6IGVsZW1lbnRDb250YWluZXIudG9wLFxuICAgICAgICAgICAgQk9UVE9NOiBlbGVtZW50Q29udGFpbmVyLmJvdHRvbSxcbiAgICAgICAgfTtcbiAgICAgICAgY29uc3Qgdmlld1BvcnQgPSBVdGlsLmdldFZpZXdwb3J0UmVjdChkb2N1bWVudCk7XG4gICAgICAgIGNvbnN0IGRvY3VtZW50RWxlbWVudCA9IHtcbiAgICAgICAgICAgIFRPUDogdmlld1BvcnQudG9wLFxuICAgICAgICAgICAgQk9UVE9NOiB2aWV3UG9ydC5ib3R0b21cbiAgICAgICAgfTtcbiAgICAgICAgY29uc3QgcmV0dXJuVmFscyA9IHtcbiAgICAgICAgICAgIERpcmVjdGlvbjogRGlyZWN0aW9uLk5vbmUsXG4gICAgICAgICAgICBBbW91bnQ6IDBcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKGRvY3VtZW50RWxlbWVudC5UT1AgKyB0aGlzLmRlZmF1bHRXaW5kb3dUb0xpc3RPZmZzZXQgPiBjb250YWluZXIuVE9QKSB7XG4gICAgICAgICAgICByZXR1cm5WYWxzLkRpcmVjdGlvbiA9IERpcmVjdGlvbi5Ub3A7XG4gICAgICAgICAgICByZXR1cm5WYWxzLkFtb3VudCA9IGRvY3VtZW50RWxlbWVudC5UT1AgLSBjb250YWluZXIuVE9QO1xuICAgICAgICB9IGVsc2UgaWYgKGRvY3VtZW50RWxlbWVudC5CT1RUT00gLSB0aGlzLmRlZmF1bHRXaW5kb3dUb0xpc3RPZmZzZXQgPCBjb250YWluZXIuQk9UVE9NKSB7XG4gICAgICAgICAgICByZXR1cm5WYWxzLkRpcmVjdGlvbiA9IERpcmVjdGlvbi5Cb3R0b207XG4gICAgICAgICAgICByZXR1cm5WYWxzLkFtb3VudCA9IGNvbnRhaW5lci5CT1RUT00gLSBkb2N1bWVudEVsZW1lbnQuQk9UVE9NO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJldHVyblZhbHM7XG4gICAgfVxuXG4gICAgcG9zaXRpb24oY29udGVudEVsZW1lbnQ6IEhUTUxFbGVtZW50LCBzaXplOiBTaXplLCBkb2N1bWVudD86IERvY3VtZW50LCBpbml0aWFsQ2FsbD86IGJvb2xlYW4pOiB2b2lkIHtcbiAgICAgICAgY29uc3QgaW5wdXRFbGVtZW50ID0gdGhpcy5zZWxlY3QuaW5wdXQubmF0aXZlRWxlbWVudDtcbiAgICAgICAgY29uc3QgaW5wdXRSZWN0ID0gaW5wdXRFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpIGFzIERPTVJlY3Q7XG4gICAgICAgIHRoaXMubGlzdENvbnRhaW5lckJvdW5kUmVjdCA9IGNvbnRlbnRFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpIGFzIERPTVJlY3Q7XG4gICAgICAgIGNvbnN0IExJU1RfSEVJR0hUID0gdGhpcy5saXN0Q29udGFpbmVyQm91bmRSZWN0LmhlaWdodDtcbiAgICAgICAgaWYgKCFpbml0aWFsQ2FsbCkge1xuICAgICAgICAgICAgdGhpcy5kZWx0YVggPSBpbnB1dFJlY3QubGVmdCAtIHRoaXMuaXRlbVRleHRQYWRkaW5nIC0gdGhpcy5pdGVtVGV4dEluZGVudDtcbiAgICAgICAgICAgIGNvbnN0IHBvaW50ID0gbmV3IFBvaW50KHRoaXMuZGVsdGFYLCBpbnB1dFJlY3QudG9wICsgdGhpcy5kZWx0YVkpO1xuICAgICAgICAgICAgdGhpcy5zZXR0aW5ncy50YXJnZXQgPSBwb2ludDtcbiAgICAgICAgICAgIHN1cGVyLnBvc2l0aW9uKGNvbnRlbnRFbGVtZW50LCBzaXplKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IFNUQVJUID0ge1xuICAgICAgICAgICAgWDogaW5wdXRSZWN0LmxlZnQsXG4gICAgICAgICAgICBZOiBpbnB1dFJlY3QudG9wXG4gICAgICAgIH07XG5cbiAgICAgICAgbGV0IGl0ZW1FbGVtZW50O1xuICAgICAgICBpZiAodGhpcy5zZWxlY3Quc2VsZWN0ZWRJdGVtKSB7XG4gICAgICAgICAgICBpdGVtRWxlbWVudCA9IHRoaXMuc2VsZWN0LnNlbGVjdGVkSXRlbS5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQ7XG4gICAgICAgICAgICAvLyBELlAuIEZlYiAyMiAyMDE5LCAjMzkyMSBGb3JjZSBpdGVtIHNjcm9sbCBiZWZvcmUgbWVhc3VyaW5nIGluIElFMTEsIGR1ZSB0byBiYXNlIHNjcm9sbFRvSXRlbSBkZWxheVxuICAgICAgICAgICAgaWYgKGlzSUUoKSkge1xuICAgICAgICAgICAgICAgIGNvbnRlbnRFbGVtZW50LmZpcnN0RWxlbWVudENoaWxkLnNjcm9sbFRvcCA9IHRoaXMuc2VsZWN0LmNhbGN1bGF0ZVNjcm9sbFBvc2l0aW9uKHRoaXMuc2VsZWN0LnNlbGVjdGVkSXRlbSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpdGVtRWxlbWVudCA9IHRoaXMuc2VsZWN0LmdldEZpcnN0SXRlbUVsZW1lbnQoKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBpbnB1dEhlaWdodCA9IGlucHV0UmVjdC5oZWlnaHQ7XG4gICAgICAgIGNvbnN0IGl0ZW1Cb3VuZFJlY3QgPSBpdGVtRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSBhcyBET01SZWN0O1xuICAgICAgICBjb25zdCBpdGVtVG9wTGlzdE9mZnNldCA9IGl0ZW1Cb3VuZFJlY3QudG9wIC0gdGhpcy5saXN0Q29udGFpbmVyQm91bmRSZWN0LnRvcDtcbiAgICAgICAgY29uc3QgaXRlbUhlaWdodCA9IGl0ZW1Cb3VuZFJlY3QuaGVpZ2h0O1xuXG4gICAgICAgIGNvbnN0IGlucHV0Rm9udFNpemUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShpbnB1dEVsZW1lbnQpLmZvbnRTaXplO1xuICAgICAgICBjb25zdCBudW1lcmljSW5wdXRGb250U2l6ZSA9IHBhcnNlSW50KGlucHV0Rm9udFNpemUuc2xpY2UoMCwgaW5wdXRGb250U2l6ZS5pbmRleE9mKCdwJykpLCAxMCkgfHwgMDtcbiAgICAgICAgY29uc3QgaXRlbUZvbnRTaXplID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoaXRlbUVsZW1lbnQpLmZvbnRTaXplO1xuICAgICAgICBjb25zdCBudW1lcmljSXRlbUZvbnRTaXplID0gcGFyc2VJbnQoaXRlbUZvbnRTaXplLnNsaWNlKDAsIGl0ZW1Gb250U2l6ZS5pbmRleE9mKCdwJykpLCAxMCkgfHwgMDtcbiAgICAgICAgY29uc3QgaW5wdXRUZXh0VG9JbnB1dFRvcCA9IChpbnB1dEhlaWdodCAtIG51bWVyaWNJbnB1dEZvbnRTaXplKSAvIDI7XG4gICAgICAgIGNvbnN0IGl0ZW1UZXh0VG9JdGVtVG9wID0gKGl0ZW1IZWlnaHQgLSBudW1lcmljSXRlbUZvbnRTaXplKSAvIDI7XG4gICAgICAgIHRoaXMuaXRlbVRleHRUb0lucHV0VGV4dERpZmYgPSBpdGVtVGV4dFRvSXRlbVRvcCAtIGlucHV0VGV4dFRvSW5wdXRUb3A7XG5cbiAgICAgICAgbGV0IENVUlJFTlRfUE9TSVRJT05fWSA9IFNUQVJULlkgLSBpdGVtVG9wTGlzdE9mZnNldDtcbiAgICAgICAgY29uc3QgQ1VSUkVOVF9CT1RUT01fWSA9IENVUlJFTlRfUE9TSVRJT05fWSArIHRoaXMubGlzdENvbnRhaW5lckJvdW5kUmVjdC5oZWlnaHQ7XG5cbiAgICAgICAgY29uc3QgT1VUX09GX0JPVU5EUzoge1xuICAgICAgICAgICAgRGlyZWN0aW9uOiBEaXJlY3Rpb24sXG4gICAgICAgICAgICBBbW91bnQ6IG51bWJlclxuICAgICAgICB9ID0gdGhpcy5saXN0T3V0T2ZCb3VuZHMoeyB0b3A6IENVUlJFTlRfUE9TSVRJT05fWSwgYm90dG9tOiBDVVJSRU5UX0JPVFRPTV9ZIH0sIGRvY3VtZW50KTtcbiAgICAgICAgaWYgKE9VVF9PRl9CT1VORFMpIHtcbiAgICAgICAgICAgIGlmIChPVVRfT0ZfQk9VTkRTLkRpcmVjdGlvbiA9PT0gRGlyZWN0aW9uLlRvcCkge1xuICAgICAgICAgICAgICAgIENVUlJFTlRfUE9TSVRJT05fWSA9IFNUQVJULlk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIENVUlJFTlRfUE9TSVRJT05fWSA9IC0xICogKExJU1RfSEVJR0hUIC0gKGl0ZW1IZWlnaHQgLSAoaXRlbUhlaWdodCAtIGlucHV0SGVpZ2h0KSAvIDIpKTtcbiAgICAgICAgICAgICAgICBDVVJSRU5UX1BPU0lUSU9OX1kgKz0gU1RBUlQuWTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBjb25zdCBzZWxlY3RJdGVtUGFkZGluZ0hvcml6b250YWwgPSAyNDtcbiAgICAgICAgY29uc3QgaXRlbUxlZnRQYWRkaW5nID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoaXRlbUVsZW1lbnQpLnBhZGRpbmdMZWZ0O1xuICAgICAgICBjb25zdCBpdGVtVGV4dEluZGVudCA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGl0ZW1FbGVtZW50KS50ZXh0SW5kZW50O1xuICAgICAgICBjb25zdCBudW1lcmljTGVmdFBhZGRpbmcgPSBwYXJzZUludChpdGVtTGVmdFBhZGRpbmcuc2xpY2UoMCwgaXRlbUxlZnRQYWRkaW5nLmluZGV4T2YoJ3AnKSksIDEwKSB8fCAwO1xuICAgICAgICBjb25zdCBudW1lcmljVGV4dEluZGVudCA9IHBhcnNlSW50KGl0ZW1UZXh0SW5kZW50LnNsaWNlKDAsIGl0ZW1UZXh0SW5kZW50LmluZGV4T2YoJ3InKSksIDEwKSB8fCAwO1xuICAgICAgICB0aGlzLml0ZW1UZXh0UGFkZGluZyA9IG51bWVyaWNMZWZ0UGFkZGluZztcbiAgICAgICAgdGhpcy5pdGVtVGV4dEluZGVudCA9IG51bWVyaWNUZXh0SW5kZW50O1xuICAgICAgICBjb250ZW50RWxlbWVudC5zdHlsZS5sZWZ0ICs9IGAke1NUQVJULlggLSBudW1lcmljTGVmdFBhZGRpbmcgLSBudW1lcmljVGV4dEluZGVudH1weGA7XG4gICAgICAgIGNvbnRlbnRFbGVtZW50LnN0eWxlLndpZHRoID0gaW5wdXRSZWN0LndpZHRoICsgMjQgKyBzZWxlY3RJdGVtUGFkZGluZ0hvcml6b250YWwgKiAyICsgJ3B4JztcbiAgICAgICAgdGhpcy5kZWx0YVggPSBTVEFSVC5YIC0gbnVtZXJpY0xlZnRQYWRkaW5nIC0gbnVtZXJpY1RleHRJbmRlbnQ7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRTY3JvbGwgPSB0aGlzLmdldEl0ZW1zT3V0T2ZWaWV3KGNvbnRlbnRFbGVtZW50LCBpdGVtSGVpZ2h0KVsnY3VycmVudFNjcm9sbCddO1xuICAgICAgICBjb25zdCByZW1haW5pbmdTY3JvbGwgPSB0aGlzLmdldEl0ZW1zT3V0T2ZWaWV3KGNvbnRlbnRFbGVtZW50LCBpdGVtSGVpZ2h0KVsncmVtYWluaW5nU2Nyb2xsJ107XG5cbiAgICAgICAgLy8gKDUgaXRlbXMgb3IgbGVzcykgbm8gc2Nyb2xsIGFuZCByZXNwZWN0aXZlbHkgbm8gcmVtYWluaW5nIHNjcm9sbFxuICAgICAgICBpZiAocmVtYWluaW5nU2Nyb2xsID09PSAwICYmIGN1cnJlbnRTY3JvbGwgPT09IDApIHtcbiAgICAgICAgICAgIHRoaXMucG9zaXRpb25Ob1Njcm9sbChjb250ZW50RWxlbWVudCwgQ1VSUkVOVF9QT1NJVElPTl9ZKTtcbiAgICAgICAgfVxuICAgICAgICAvLyAobW9yZSB0aGFuIDUgaXRlbXMpIHRoZXJlIGlzIHNjcm9sbCBPUiByZW1haW5pbmcgc2Nyb2xsXG4gICAgICAgIGlmIChyZW1haW5pbmdTY3JvbGwgIT09IDAgfHwgY3VycmVudFNjcm9sbCAhPT0gMCkge1xuICAgICAgICAgICAgaWYgKHJlbWFpbmluZ1Njcm9sbCAhPT0gMCAmJiAhT1VUX09GX0JPVU5EUykge1xuICAgICAgICAgICAgICAgIHRoaXMucG9zaXRpb25Ob1Njcm9sbChjb250ZW50RWxlbWVudCwgQ1VSUkVOVF9QT1NJVElPTl9ZKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIChtb3JlIHRoYW4gNSBpdGVtcykgYW5kIGNvbnRhaW5lciBnZXR0aW5nIG91dCBvZiB0aGUgdmlzaWJsZSBwb3J0XG4gICAgICAgICAgICBpZiAocmVtYWluaW5nU2Nyb2xsICE9PSAwICYmIE9VVF9PRl9CT1VORFMpIHtcbiAgICAgICAgICAgICAgICAvLyBpZiB0aGVyZSBpcyBlbm91Z2ggcmVtYWluaW5nIHNjcm9sbCB0byBzY3JvbGwgdGhlIGl0ZW1cbiAgICAgICAgICAgICAgICBpZiAocmVtYWluaW5nU2Nyb2xsID4gaXRlbUhlaWdodCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoT1VUX09GX0JPVU5EUy5EaXJlY3Rpb24gPT09IERpcmVjdGlvbi5Ub3ApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucG9zaXRpb25BbmRTY3JvbGxUb3AoY29udGVudEVsZW1lbnQsIE9VVF9PRl9CT1VORFMuQW1vdW50KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoT1VUX09GX0JPVU5EUy5EaXJlY3Rpb24gPT09IERpcmVjdGlvbi5Cb3R0b20pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIChtb3JlIHRoYW4gNSBpdGVtcykgYW5kIG5vIGN1cnJlbnQgc2Nyb2xsXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudFNjcm9sbCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucG9zaXRpb25Ob1Njcm9sbChjb250ZW50RWxlbWVudCwgQ1VSUkVOVF9QT1NJVElPTl9ZKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gKG1vcmUgdGhhbiA1IGl0ZW1zKSBhbmQgY3VycmVudCBzY3JvbGxcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3NpdGlvbkFuZFNjcm9sbEJvdHRvbShjb250ZW50RWxlbWVudCwgT1VUX09GX0JPVU5EUy5BbW91bnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBpZiB0aGVyZSBpcyBubyBlbm91Z2ggcmVtYWluaW5nIHNjcm9sbCB0byBzY3JvbGwgdGhlIGl0ZW1cbiAgICAgICAgICAgICAgICBpZiAocmVtYWluaW5nU2Nyb2xsIDwgaXRlbUhlaWdodCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoT1VUX09GX0JPVU5EUy5EaXJlY3Rpb24gPT09IERpcmVjdGlvbi5Ub3ApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucG9zaXRpb25Ob1Njcm9sbChjb250ZW50RWxlbWVudCwgQ1VSUkVOVF9QT1NJVElPTl9ZKTtcblxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChPVVRfT0ZfQk9VTkRTLkRpcmVjdGlvbiA9PT0gRGlyZWN0aW9uLkJvdHRvbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3NpdGlvbkFuZFNjcm9sbEJvdHRvbShjb250ZW50RWxlbWVudCwgT1VUX09GX0JPVU5EUy5BbW91bnQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gKG1vcmUgdGhhbiA1IGl0ZW1zKSBhbmQgbm8gcmVtYWluaW5nIHNjcm9sbFxuICAgICAgICAgICAgaWYgKHJlbWFpbmluZ1Njcm9sbCA9PT0gMCAmJiBjdXJyZW50U2Nyb2xsICE9PSAwKSB7XG4gICAgICAgICAgICAgICAgaWYgKE9VVF9PRl9CT1VORFMpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKE9VVF9PRl9CT1VORFMuRGlyZWN0aW9uID09PSBEaXJlY3Rpb24uQm90dG9tKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBvc2l0aW9uQW5kU2Nyb2xsQm90dG9tKGNvbnRlbnRFbGVtZW50LCBPVVRfT0ZfQk9VTkRTLkFtb3VudCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5wb3NpdGlvbk5vU2Nyb2xsKGNvbnRlbnRFbGVtZW50LCBDVVJSRU5UX1BPU0lUSU9OX1kpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuIl19